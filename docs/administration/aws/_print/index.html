<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.109.0"><link rel=canonical type=text/html href=https://hortacloud.janelia.org/docs/administration/aws/><link rel=alternate type=application/rss+xml href=https://hortacloud.janelia.org/docs/administration/aws/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>AWS | HortaCloud</title><meta name=description content="Learn how to deploy and operate your own HortaCloud instance on AWS
"><meta property="og:title" content="AWS"><meta property="og:description" content="Learn how to deploy and operate your own HortaCloud instance on AWS
"><meta property="og:type" content="website"><meta property="og:url" content="https://hortacloud.janelia.org/docs/administration/aws/"><meta itemprop=name content="AWS"><meta itemprop=description content="Learn how to deploy and operate your own HortaCloud instance on AWS
"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS"><meta name=twitter:description content="Learn how to deploy and operate your own HortaCloud instance on AWS
"><link rel=preload href=/scss/main.min.a9b55832fcac0ae4e1abebd8fa418b962048ce55d2fe39e8ecb37040471492c2.css as=style><link href=/scss/main.min.a9b55832fcac0ae4e1abebd8fa418b962048ce55d2fe39e8ecb37040471492c2.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class=font-weight-bold>HortaCloud</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.3baa126cf3fea92fd4dc8fe6611e8520.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/administration/aws/>Return to the regular view of this page</a>.</p></div><h1 class=title>AWS</h1><div class=lead>Learn how to deploy and operate your own HortaCloud instance on AWS</div><ul><li>1: <a href=#pg-aa09ac4c336c90970d422edf7c37abe2>Costs</a></li><li>2: <a href=#pg-a6019a15515da980daf6ab4a20aa0a20>Deployment</a></li><li>3: <a href=#pg-47be1a16b5df5bb00564696755d43828>Backup & Restore</a></li><li>4: <a href=#pg-e807886fdd82accb7b13ffd06c600de7>Upgrading</a></li><li>5: <a href=#pg-758c43e554607493c78a37aa827034b2>Data Import</a></li><li>6: <a href=#pg-0941c9f4c254e615d6587436cb91b5f6>Troubleshooting</a></li></ul><div class=content><p>HortaCloud is easily deployed on Amazon Web Services (AWS) using the AWS CDK to automatically provision resources.</p></div></div><div class=td-content><h1 id=pg-aa09ac4c336c90970d422edf7c37abe2>1 - Costs</h1><div class=lead>Costs of running the system in the cloud</div><p>Deploying this system on Amazon Web Services (AWS) incurs a monthly cost for AWS service usage.</p><p>In particular, the cost breakdown is roughly:</p><ul><li>$382/mo - Per user costs for running the Horta client on AppStream</li><li>$277/mo - Back-end services running on EC2 (with Savings Plan)</li><li>$76/mo - Storage (3 TB) for one sample image on S3</li><li>$34/mo - Virtual Private Cloud (VPC)</li></ul><p>Therefore, the minimum total cost per month for a single user would be about $770 ($9,237/year). For 2 users, the monthly cost would be $1130 ($13,570/year), etc. The full estimate can be <a href="https://calculator.aws/#/estimate?id=ecbba8c6713281bc419c70de414d8a1db19dd345">found here</a>.</p><p>We are assuming 8 hours of tracing per day, 5 days a week. If the system is not used for 8 hours a day, the cost will be less. You can dial in your own expected usage in the <a href="https://calculator.aws/#/estimate?id=ecbba8c6713281bc419c70de414d8a1db19dd345">AWS calculator</a> for an accurate cost estimate.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a6019a15515da980daf6ab4a20aa0a20>2 - Deployment</h1><div class=lead>How to deploy HortaCloud to your own AWS account</div><p>The deployment uses AWS CDK to create AWS resources on your AWS account as shown in the diagram below. All services run in a secured Virtual Private Cloud (VPC).</p><a href=../cloud_architecture.png><img src=../cloud_architecture.png class="rounded mx-auto" style=max-width:800px alt="cloud architecture diagram"></a><h2 id=install-prerequisites>Install prerequisites</h2><p>You should have <strong>node v14</strong> installed on your local machine. We recommend using <a href=https://github.com/nvm-sh/nvm>nvm</a> to install and activate this version of node.</p><ul><li>Install AWS CLI<ul><li>AWS CDK requires AWS CLI to be installed and configured on the computer from which one runs the deployment procedure. <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html>Installation</a> & <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html>configuration</a> instructions can be found in the AWS documentation.</li></ul></li></ul><h2 id=get-the-deployment-scripts>Get the deployment scripts</h2><p>Clone the <a href=https://github.com/JaneliaSciComp/hortacloud>HortaCloud GitHib repository</a> containing the deployment scripts:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/JaneliaSciComp/hortacloud/
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> hortacloud
</span></span></code></pre></div><p>Install the dependencies:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>npm run setup -- -i
</span></span></code></pre></div><p>This command will install all packages that are needed to run the deployment procedure. The &lsquo;-i&rsquo; flag will tell the setup script to install npm packages for all application modules: cognito_stack, vpc_stack, workstation_stack and admin_api_stack. If you do not specify the &lsquo;-i&rsquo; flag, the command will only check the .env file and create it in case it&rsquo;s missing. Notice how the &lsquo;-i&rsquo; flag is preceded by two hyhens &lsquo;&ndash;&rsquo; - this is specific to npm not to cdk, so all script specific flags must be after the double hyphen separator.</p><h2 id=configure-environment>Configure environment</h2><p>The following values must be set in the <code>.env</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>AWS_REGION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your aws region&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>AWS_ACCOUNT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your aws account&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>HORTA_ORG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;app qualifier name&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>ADMIN_USER_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;admin email&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_JWT_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;a 32 byte jwt secret&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_MONGO_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;a 32 byte mongo secret&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_APP_PASSWD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;app password&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>RABBITMQ_PASSWD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;rabbitmq password&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_API_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;jacs api key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JADE_API_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;jade api key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>HORTA_DATA_BUCKETS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;s3 buckets that hold MouseLight data&gt;</span>
</span></span></code></pre></div><p>The api keys and secrets have been randomly generated during the setup step, but you can generate new ones with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl rand -hex <span style=color:#0000cf;font-weight:700>32</span>
</span></span></code></pre></div><p>We prefer this procedure because these values will be handled during the installation using the <code>sed</code> command and it is preferable that they not contain any characters that require escaping in a sed command.</p><p>If you already have data on some S3 buckets you can add them to <code>HORTA_DATA_BUCKETS</code> as a comma separated list. For example, if you want to use Janelia&rsquo;s Open Data bucket but in addition you also have your data on a private bucket (&lsquo;janelia-mouselight-demo&rsquo; in this example) you need to set <code>HORTA_DATA_BUCKETS="janelia-mouselight-imagery,janelia-mouselight-demo"</code>. By default, only the MouseLight Open Data bucket is mounted. Every bucket specified in the &lsquo;HORTA_DATA_BUCKETS&rsquo; list will be available in Horta as <code>/s3data/&lt;s3BucketName></code> directory.</p><p>If you want to change the setting for <code>HORTA_WS_INSTANCE_TYPE</code>, keep in mind that you may have to change <code>HORTA_WS_IMAGE_NAME</code>.</p><p>For <code>HORTA_WS_INSTANCE_TYPE</code> set to any <code>stream.graphics.g4dn.*</code> instances:</p><ul><li><code>stream.graphics.g4dn.xlarge</code></li><li><code>stream.graphics.g4dn.2xlarge</code></li><li><code>stream.graphics.g4dn.4xlarge</code></li><li><code>stream.graphics.g4dn.8xlarge</code></li><li><code>stream.graphics.g4dn.12xlarge</code></li><li><code>stream.graphics.g4dn.16xlarge</code></li></ul><p>use: <code>HORTA_WS_IMAGE_NAME=AppStream-Graphics-G4dn-WinServer2019-09-01-2022</code> image.</p><p>For <code>HORTA_WS_INSTANCE_TYPE</code> set to any <code>stream.graphics-pro.*</code> instances:</p><ul><li><code>stream.graphics-pro.4xlarge</code></li><li><code>stream.graphics-pro.8xlarge</code></li><li><code>stream.graphics-pro.16xlarge</code></li></ul><p>use <code>HORTA_WS_IMAGE_NAME=AppStream-Graphics-Pro-WinServer2019-09-01-2022</code> image</p><p>Note: AWS deprecates the AppStream images relatively frequently so please make sure you use an AppStream-Graphics image that is available on AWS. You can see the available images from the AWS console if you select the &ldquo;AppStream 2.0&rdquo; service and then search &ldquo;Images > Image Registry&rdquo;</p><h2 id=configure-aws-account>Configure AWS account</h2><h3 id=iam-required-roles>IAM Required Roles</h3><p>In order to create an AppStream Image Builder, which is needed to create the Workstation Image, you need to have all <a href=https://docs.aws.amazon.com/appstream2/latest/developerguide/roles-required-for-appstream.html>roles required by AppStream</a>. Check that by simply connecting to the AWS console and check if the Roles are available in the IAM Service - select &ldquo;Services&rdquo; > &ldquo;Security, Identity, Compliance&rdquo; > &ldquo;IAM&rdquo; then verify that the required roles are present:</p><ul><li>AmazonAppStreamServiceAccess</li><li>ApplicationAutoScalingForAmazonAppStreamAccess</li><li>AWSServiceRoleForApplicationAutoScaling_AppStreamFleet</li></ul><h3 id=aws-limits>AWS Limits</h3><p>Most AWS services allow you to setup restrictions on the number of active instances. The default limits, especially for some AppStream resources, such as &ldquo;Maximum ImageBuilders&rdquo; for some graphics instances - &ldquo;stream.graphics.g4dn.xlarge&rdquo; may be really low (0 in some cases). Connect to AWS console &ldquo;Service Quotas&rdquo; service and increase the limit for in case you see a <code>limit was exceeded</code> error. Typically take a look at the limits setup for your account for EC2, VPC, AppStream, S3. Keep in mind that limits may be different from instance type to instance type for AppStream service, so you may have to adjust the limits based on the AppStream instance type selection.</p><h2 id=deploy-hortacloud-services>Deploy HortaCloud services</h2><p>After the setup is complete, deploy the application by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy
</span></span></code></pre></div><p>First time the application is deployed we also need to create user login pool and this must be explicitly specified using &lsquo;-u&rsquo; flag [See <strong>Deploy the user login stack</strong> section below]:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy -- -u
</span></span></code></pre></div><p>There are a few steps during the deployment that require manual intervention. The deploy script will indicate when these steps should be taken with a ⚠️ warning message.</p><p>The full deployment of the application is done in 3, or 4 steps - if user login stack is deployed too, that run automatically one after the other,
with some manual intervention for <strong>AppStream builder</strong> step (third step outlined below):</p><ol><li><p><strong>Deploy the user login stack</strong> - this step is optional and practically is only needed first time the application is deployed. To create the user login stack you need to pass in &lsquo;-u&rsquo; flag to the deploy command (<code>npm run deploy -- -u</code>) which will automatically create a Cognito user pool and the &lsquo;admin&rsquo; user and &lsquo;admins&rsquo; group. You also have an option to import cognito users from a backup (<code>npm run deploy -- -u \ -r -b janelia-mouselight-demo -f hortacloud/backups/20220511030001/cognito</code>) but in this case you may need to skip the creation of the default admin user and group.</p></li><li><p><strong>Deploy the back-end stacks</strong> - this includes the AppStream builder. At the back end deployment the installation process will also create the admin user configured in <code>ADMIN_USER_EMAIL</code>.</p></li><li><p><strong>Connect to AppStream builder and install the Horta application</strong> - This is a semiautomated step that involves copying and running two PowerShell scripts onto the AppStream builder instance.</p></li><li><p><strong>Deploy the administration stack.</strong></p></li></ol><h3 id=install-the-horta-desktop-application>Install the Horta desktop application</h3><p>For client installation start and connect to the AppStream builder instance then copy the following scripts from this repo to the AppStream instance:</p><ul><li><a href=https://github.com/JaneliaSciComp/hortacloud/blob/main/vpc_stack/src/asbuilder/installcmd.ps1>installcmd.ps1</a> - installs JDK and the Horta application</li><li><a href=https://github.com/JaneliaSciComp/hortacloud/blob/main/vpc_stack/src/asbuilder/createappimage.ps1>createappimage.ps1</a> - creates the AppStream image</li></ul><p>After you copied or created the scripts:</p><ul><li>Log in to the AWS console and go to <a href=https://console.aws.amazon.com/appstream2>https://console.aws.amazon.com/appstream2</a></li><li>Find your new builder in the &ldquo;Images > Image Builder&rdquo; tab</li><li>Click on the image name and open an &ldquo;Administrator&rdquo; window by clicking on the &ldquo;Connect&rdquo; button.</li><li>Copy the installation scripts from your local machine to AppStream:<ul><li>Click on the folder icon at the top left of the window</li><li>Select the <code>Temporary Files</code> folder</li><li>Use the <code>Upload Files</code> icon to find the files on your machine and upload them.</li></ul></li><li>Open the powershell by typing &ldquo;`Power shell&rdquo; in the search found at the bottom left of the window. This step used to require an &ldquo;Administrator Power Shell&rdquo; but now it needs only a regular user power shell and it may actually fail the install if you run it in an Administrator Power Shell.</li><li>Change to the directory where you uploaded the installation scripts, eg:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#204a87>cd </span><span style=color:#4e9a06>&#39;C:\Users\ImagebuilderAdmin\My Files\Temporary Files&#39;</span>
</span></span></code></pre></div><ul><li>Run the installcmd script to install Horta. &lt;serverName> is the name of the backend EC2 instance, typically it looks like <code>ip-&lt;ip4 with dashes instead of dots>.ec2.internal</code>. Instructions for locating this are provided as output from the installer script. The Horta client certificate is signed using the ec2 internal name so do not use the actual IP for the &lt;serverName> parameter, because user logins will fail with a certificate error.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>installcmd</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>serverName</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>This will install the JDK and Horta. The installer will run silently and it will install the Horta application under the <code>C:\apps</code> folder. If it prompts you for the install directory, select <code>C:\apps</code> as the JaneliaWorkstation location.</p><ul><li><em>Optional</em> - To start Horta for testing, run:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>c:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>apps</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>runJaneliaWorkstation</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span>
</span></span></code></pre></div><ul><li><p>when prompted, login as the admin user you set in ADMIN_USER_EMAIL (leave the password empty)</p></li><li><p>Navigate through the menus to make sure Horta is working. <em>Do not create any user accounts at this time as they will get created from the Admin web application.</em></p></li><li><p>When testing is finished, close down Horta.</p></li><li><p>Finalize the creation of the AppStream image, run:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>createappimage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span>
</span></span></code></pre></div><p>Keep in mind that once you start this step the builder instance begins the snap shotting process and it will not be usable until it completes. After this is completed the AppStream image should be available and the builder will be in a stop state. To use it again you need to start it and then you can connect.</p><ul><li>You can now safely close the AppStream session and return to the AppStream console. There you will see a new image in the image registry with a status of <code>Pending</code>.</li><li>Once the image status has changed to a status of <code>Available</code> you can start the fleet by going to the <code>Fleets</code> page on the AppStream site.<ul><li>Select your fleet from the list of fleets and then select &lsquo;Start&rsquo; from the <code>Action</code> menu.</li></ul></li><li>At this point the installation script you started on your host machine, should continue to completion.</li></ul><h2 id=customizing-the-portal-url>Customizing the portal URL</h2><p>By default the application will have a very long url that is not easy to remember, something like:
<a href=http://janelia-hortacloudwebapp-janeliahortacloudwebadmi-yefcny29t8n6.s3-website-us-east-1.amazonaws.com/>http://janelia-hortacloudwebapp-janeliahortacloudwebadmi-yefcny29t8n6.s3-website-us-east-1.amazonaws.com/</a>. Follow these instructions to create a shorter domain for use with your installation.</p><ul><li>Register a domain with Route53 or your domain provider.<ul><li>The Route53 page in the AWS console has a &ldquo;Register domain&rdquo; form.</li><li>Alternative providers can also be used, but it requires a little more work.</li></ul></li><li>Purchase an SSL certificate for your domain.<ul><li>This can be done with <a href=https://aws.amazon.com/certificate-manager/>AWS Certificate Manager</a></li><li>or an external certificate provider, often it can be done with the same company that provided your domain registration. Use the &ldquo;Import a certificate&rdquo; button to register your certificate with AWS.</li></ul></li><li>Use the &ldquo;Create distribution&rdquo; button on the CloudFront console to attach your registered domain to the s3 bucket that hosts the admin portal.<ul><li>the only things that need to be changed from the defaults are<ul><li>&ldquo;Origin domain&rdquo; - this should be the domain that was originally generated for your admin portal.
eg: <em>janelia-hortacloudwebapp-janeliahortacloudwebadmi-yefcny29t8n6.s3-website-us-east-1.amazonaws.com</em></li><li>&ldquo;Viewer protocol policy&rdquo; - Change this to &ldquo;Redirect HTTP to HTTPS&rdquo;</li><li>&ldquo;Custom SSL certificate&rdquo; - Select the certificate that you registered with AWS Certificate Manager</li></ul></li><li>Finally, click the &ldquo;Create distribution&rdquo; button.</li></ul></li></ul><h2 id=uninstalling-hortacloud-services>Uninstalling HortaCloud services</h2><p>To completely uninstall the application run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run destroy -- -u
</span></span></code></pre></div><p>The command will uninstall all stacks including the user logins (Cognito) stack.</p><p>Note in the previous <a href=#Upgrading_HortaCloud_services_to_AWS>system upgrade section</a> that an upgrade typically does not require removing and recreating the user pool stack.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=troubleshooting-client-app-installation>Troubleshooting client app installation</h3><p>If the client app installation fails for any reason, before you attempt the install again you must remove everything that was installed by the install script. Uninstall all applications installed with scoop and remove the &lsquo;C:\apps&rsquo; folder. To do that run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>scoop</span> <span style=color:#000>uninstall</span> <span style=color:#000>scoop</span>
</span></span><span style=display:flex><span><span style=color:#204a87>del </span><span style=color:#000>c:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>apps</span>
</span></span></code></pre></div><p>When prompted whether you really want to uninstall everything, select &ldquo;yes&rdquo; or &ldquo;all&rdquo;.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-47be1a16b5df5bb00564696755d43828>3 - Backup & Restore</h1><div class=lead>How to backup your HortaCloud data</div><h2 id=system-backup>System backup</h2><p>The system can be configured to take nightly backups. All it is needed is to specify a writeable bucket (<code>HORTA_BACKUP_BUCKET</code>) that will hold the backups. You can also specify the base prefix for the backups using <code>HORTA_BACKUP_FOLDER</code>. If this is not specified the prefix will default to &ldquo;/hortacloud/backups&rdquo;.</p><p>Currently the backup contains the Cognito users and the Mongo database (user-generated metadata and tracing data). Each backup will be stored in a timestamp (with format &ldquo;yyyyMMddHHmmss&rdquo;) folder under the base backup prefix. The location of the backups will be <code>s3://&lt;backup_bucket>/&lt;backup_folder_prefix>/&lt;timestamp>/jacs</code> for the database and <code>s3://&lt;backup_bucket>/&lt;backup_folder_prefix>/&lt;timestamp>/cognito</code> for cognito users.</p><p>The backup is configured as a cron job that runs daily at 3 AM local time on the EC2 host on which the backend services run.</p><h2 id=system-restore>System restore</h2><p>If system backups are available, the sample and tracing data can be restored by specifying a specified backup bucket (<code>HORTA_RESTORE_BUCKET</code>) and prefix (<code>HORTA_RESTORE_FOLDER</code>) which typically was created by the nightly backup job.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e807886fdd82accb7b13ffd06c600de7>4 - Upgrading</h1><div class=lead>Upgrading to a new version of HortaCloud</div><p>There are two ways to upgrade to a new version of the code: <a href=#full-upgrade>Full Upgrade</a> and <a href=#incremental-upgrade>Incremental Upgrade</a>.</p><h2 id=full-upgrade>Full Upgrade</h2><p>This method backs up all of the data, removes the existing HortaCloud stack, installs a new version from scratch, and restores the data. This is currently the most automated way to upgrade, and requires the least amount of effort.</p><h3 id=backup-your-data>Backup your data</h3><p>First, ensure that you have a recent data backup. If you have not <a href=../backups>configured backups</a>, do that first. For most upgrades, you only need to check if a backup for the JACS Mongo database exists. Typically this is located at <code>s3://&lt;HORTA_BACKUP_BUCKET value>/&lt;HORTA_BACKUP_FOLDER value>/&lt;timestamp>/jacs</code></p><h3 id=remove-hortacloud-environment>Remove HortaCloud environment</h3><p>To remove the current HortaCloud environment run this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run destroy
</span></span></code></pre></div><p>This command will uninstall the frontend and the backend AWS Cloudformation stacks, i.e., Admin, Appstream and JACS stacks, but it will not uninstall Cognito stack, so no user accounts will be removed.</p><h3 id=deploy-new-version-of-hortacloud>Deploy new version of HortaCloud</h3><p>The next step is to upgrade the local git repo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git pull
</span></span></code></pre></div><p>You should also check out a specific version tag that you want to deploy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git checkout &lt;version&gt;
</span></span></code></pre></div><p>In order to restore the database from an existing backup make sure the following properties are set:</p><pre tabindex=0><code>HORTA_RESTORE_BUCKET=&lt;backup bucket name&gt;
HORTA_RESTORE_FOLDER=&#34;/hortacloud/backups/latest&#34;
</code></pre><p>HORTA_RESTORE_BUCKET is the name of the backup bucket and HORTA_RESTORE_FOLDER must reference the parent prefix containing the &lsquo;jacs&rsquo; folder - the location of the actual mongo backup. Typically the backup job creates a &ldquo;softlink&rdquo; - &ldquo;/hortacloud/backups/latest&rdquo; so if you simply set the restore folder to that it should pick up the latest backup. If the backup was a manual backup or you need to restore to a previous date set the restore folder to that folder. For example setting <code>HORTA_RESTORE_FOLDER=/hortacloud/backups/20220609030001</code> will restore the database to the content saved on Jun 9, 2022.</p><p>After setting these properties you can proceed with the actual deploy procedure which will only install the backend and the frontend stack (skipping any Cognito installation):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy
</span></span></code></pre></div><p>From here on, this approach is identical with the initial deployment, with the only exception that data and users should already exist once the backend stack is fully deployed.</p><p>After you start the deploy command, follow the instructions you see on the screen which will prompt you when you need to setup the AppStream Builder exactly as it is described in the <a href=#workstation-app-installation>Workstation app-installation section</a></p><p>If somehow you need to recreate the user login accounts because you inadvertently removed the Cognito stack as well (e.g. using <code>-u</code> flag) you can restore all the accounts from a previous backup using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy -- -u -r -b &lt;backup bucket&gt; -f hortacloud/backups/manual-backup/cognito
</span></span></code></pre></div><p>The folder parameter must point to the actual cognito prefix, where &lsquo;users.json&rsquo; and &lsquo;groups.json&rsquo; are located</p><h2 id=incremental-upgrade>Incremental Upgrade</h2><p>Incremental approach requires more manual steps, but it does not require any data restore. It basically removes only the frontend stacks, i.e. Appstream and Admin App, and it requires a manual update of the backend stack and the workstation.</p><p>The steps for the incremental approach are the following:</p><ul><li><p>Remove only the frontend stacks:
<code>npm run destroy -- -b</code></p></li><li><p>From the AWS console connect to the EC2 instance (<code>&lt;ORG>-hc-jacs-node-&lt;STAGE></code>) running the JACS stack using the &ldquo;Session Manager&rdquo;. To be more specific, from the EC2 instances page, select the instance <code>&lt;ORG>-hc-jacs-node-&lt;STAGE></code> and click on the &ldquo;Connect&rdquo; button. This will take you to the instance page, and then from there select the &ldquo;Session Manager&rsquo; tab and click the &ldquo;Connect&rdquo; button again. The &ldquo;Connect&rdquo; button should be enabled - if it&rsquo;s not there either was a problem with the deployment or there might be a problem with the instance itself.</p></li><li><p>Once connected run the following commands</p><pre tabindex=0><code>cd /opt/jacs/deploy
./manage.sh compose down
sudo git pull origin stable
sudo git checkout &lt;version&gt;
./manage.sh compose up -d
</code></pre></li><li><p>Start AppStream builder (<code>&lt;ORG>-hc-image-builder-&lt;STAGE></code>)</p></li><li><p>Connect as Administrator</p></li><li><p>Check that &lsquo;reinstallwsonly.ps1&rsquo; script is available, in the Admin&rsquo;s home directory. If not copy it from the application repo or just create it like the other install scripts, (&lsquo;installcmd.ps1&rsquo; and &lsquo;createappimage.ps1&rsquo;) were created on the initial deployment.</p></li><li><p>Run the reinstallwssonly.ps1 script:</p><pre tabindex=0><code>.\reinstallwssonly.ps1 &lt;IP of host running JACS stack&gt;
</code></pre><p>The IP of the host running JACS is the same used for initial run of &lsquo;installcmd.ps1&rsquo; and it can be found from the AWS console.</p></li><li><p>Try out the workstation application to make sure it works</p><pre tabindex=0><code>C:\apps\runJaneliaWorkstation.ps1
</code></pre></li><li><p>Make sure you have the latest &lsquo;createappimage.ps1&rsquo; script from the application git repository. If you don&rsquo;t copy the latest script that supports &lsquo;&ndash;skip-registration&rsquo; flag.</p></li><li><p>Start the script for creating the AppStream image but skip the application registration: <code>.\createappimage.ps1 --skip-registration</code></p></li><li><p>Reinstall the frontend stacks</p><pre tabindex=0><code>npm run deploy -- --skip-vpc
</code></pre><p>If no changes were made to the code AWS CDK will only update the missing stacks, leaving JACS stack as it was since it practically has not been changed from AWS&rsquo; perspective</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-758c43e554607493c78a37aa827034b2>5 - Data Import</h1><div class=lead>How to get image data into the system</div><h3 id=adding-the-mouselight-open-data>Adding the MouseLight Open Data</h3><p>The MouseLight project at Janelia has made available the complete imagery and neuron tracing annotations for its published data sets on the <a href=https://registry.opendata.aws/janelia-mouselight/>AWS Open Data Registry</a>.</p><p>You can easily make these available in your own HortaCloud instance by <a href=/docs/user_manual/synchronized_folders/>creating a Synchronized Folder</a> which points to <code>/s3data/janelia-mouselight-data</code>.</p><h3 id=adding-a-single-volume>Adding a single volume</h3><p>A Horta Sample is an object representing a single 3D volume that can be visualized and traced with Horta.</p><p>If you already have the HortaKTX format data in your mounted S3 buckets, select <strong>File</strong> → <strong>New</strong> → <strong>Horta Sample</strong>, and then set &ldquo;Sample Name&rdquo; to <code>&lt;sampleDirectoryName></code> and &ldquo;Path to Render Folder&rdquo; as <code>/s3data/&lt;bucketName>/&lt;sampleDirectoryName></code>.</p><p>Open the Data Explorer (<strong>Window</strong> → <strong>Core</strong> → <strong>Data Explorer</strong>) and navigate to Home, then &ldquo;3D RawTile Microscope Samples&rdquo;, and your sample name. Right-click the sample and choose &ldquo;Open in Horta&rdquo;. This will open the Horta Panel and then from the Horta Panel you have options to create a workspace or to open the 2D or the 3D volume viewer.</p><h3 id=converting-your-data>Converting your data</h3><p>If your data has not been converted into HortaKTX format, you can use the <a href=https://github.com/JaneliaSciComp/hortacloud-importer>HortaCloud Data Importer</a> to convert it. This tool supports many common image formats, and can be easily extended in Python to support your favorite format.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0941c9f4c254e615d6587436cb91b5f6>6 - Troubleshooting</h1><div class=lead>Troubleshooting HortaCloud services</div><h2 id=no-user-can-login-to-the-workstation>No user can login to the workstation</h2><p>We have seen this behavior if the &ldquo;/data&rdquo; volume ran out of space. You can check this by connecting to the EC2 instance running the JACS stack and running <code>df -h /data</code>.</p><p>If the disk is full you, you can try to find anything that could be removed but if the limit was reached because the size your data you really have to resize the volume. The steps to resize an EBS volume can be found in the AWS documentation. First run <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/requesting-ebs-volume-modifications.html>the instructions to increase the size of and EBS volume</a> and then <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html>the instructions that make the entire new disk space available to the EC2 instance</a></p><p>If users still cannot use the workstation for tracing, after the <code>/data</code> volume was resized, and there is plenty of disk space available, the reason might be that RabbitMQ failed to start properly, which may happen if RabbitMQ runs out of disk space. Users can also inspect the log from the workstation and look for errors like:</p><pre tabindex=0><code>java.lang.IllegalStateException: Message connection could not be opened to host &lt;hostip&gt; after &lt;n&gt; attempts
</code></pre><p>If this is case check the size of the file <code>/data/db/rabbitmq/jacs/mnesia/rabbit\@jacs-rabbit/msg_stores/vhosts/628WB79CIFDYO9LJI6DKMI09L/recovery.dets</code> If the file exists and its size is 0 then remove the file and restart the entire stack.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/hortacloud-support aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/HortaCloud aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/JaneliaSciComp/hortacloud-website aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 Howard Hughes Medical Institute /</small>
<small><a class=text-white href=https://www.hhmi.org/privacy-policy target=_blank rel=noopener>Privacy Policy & Cookie Notice</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin=anonymous></script>
<script src=/js/prism.js></script></body></html>