<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://hortacloud.janelia.org/docs/><link rel=alternate type=application/rss+xml href=https://hortacloud.janelia.org/docs/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>HortaCloud Documentation | HortaCloud</title>
<meta name=description content="HortaCloud: collaborative neuron annotation in the cloud"><meta property="og:url" content="https://hortacloud.janelia.org/docs/"><meta property="og:site_name" content="HortaCloud"><meta property="og:title" content="HortaCloud Documentation"><meta property="og:description" content="HortaCloud: collaborative neuron annotation in the cloud"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="HortaCloud Documentation"><meta itemprop=description content="HortaCloud: collaborative neuron annotation in the cloud"><meta itemprop=dateModified content="2024-11-26T14:46:46-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="HortaCloud Documentation"><meta name=twitter:description content="HortaCloud: collaborative neuron annotation in the cloud"><link rel=preload href=/scss/main.min.c95463dd6853f7bb81818d73328288d6768ba4174ecf8a654a5861ae4de38a19.css as=style><link href=/scss/main.min.c95463dd6853f7bb81818d73328288d6768ba4174ecf8a654a5861ae4de38a19.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><link rel=stylesheet href=/css/prism.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" data-name="Layer 1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 128 79"><defs><style>.cls-1{clip-path:url(#clippath)}.cls-2{fill:none}.cls-2,.cls-3,.cls-4,.cls-5,.cls-6{stroke-width:0}.cls-3{fill:url(#linear-gradient)}.cls-4{fill:url(#radial-gradient)}.cls-5{fill:url(#radial-gradient-2)}.cls-6{fill:url(#radial-gradient-3)}.cls-7{filter:url(#outer-glow-2)}</style><filter id="outer-glow-2" filterUnits="userSpaceOnUse"><feOffset dx="0" dy="0"/><feGaussianBlur result="blur" stdDeviation="2"/><feFlood flood-color="#7171ff" flood-opacity=".7"/><feComposite in2="blur" operator="in"/><feComposite in="SourceGraphic"/></filter><linearGradient id="linear-gradient" x1="63.48" y1="906.14" x2="63.48" y2="1020.06" gradientTransform="translate(0 1002) scale(1 -1)" gradientUnits="userSpaceOnUse"><stop offset=".13" stop-color="#32103d"/><stop offset=".16" stop-color="#341a43"/><stop offset=".22" stop-color="#38294c"/><stop offset=".29" stop-color="#3b3252"/><stop offset=".41" stop-color="#3c3554"/><stop offset=".56" stop-color="#3d3a62"/><stop offset=".85" stop-color="#404788"/></linearGradient><clipPath id="clippath"><path class="cls-2" d="M21.28 75c-9.45-.2-15.87-5.95-17.86-13.89-4.44-16.48 7.77-33.29 24.81-31.74 3.97.99 3.55-2.9 3.97-3.97C37.31 11.77 48.95 3.58 62.95 3.58c10.84.0 20.68 5.95 26.78 14.88 1.98 1.98.99 1.98 2.98.99 16.78-5.18 32.04 9.85 31.74 28.77.25 14.48-8.82 26.82-21.82 26.78H21.28z"/></clipPath><radialGradient id="radial-gradient" cx="23.68" cy="46.16" fx="23.68" fy="46.16" r="31.87" gradientTransform="translate(1.75 5.33) scale(1 .99)" gradientUnits="userSpaceOnUse"><stop offset=".04" stop-color="#4ac6b0"/><stop offset=".24" stop-color="#33ac9c"/><stop offset=".46" stop-color="#1f968b"/><stop offset=".58" stop-color="#2c6f7f" stop-opacity=".7"/><stop offset=".73" stop-color="#3b4472" stop-opacity=".38"/><stop offset=".84" stop-color="#442a6a" stop-opacity=".18"/><stop offset=".9" stop-color="#482067" stop-opacity=".1"/></radialGradient><radialGradient id="radial-gradient-2" cx="108.45" cy="46.89" fx="108.45" fy="46.89" r="27.33" gradientTransform="translate(-5.74) scale(.99 1)" gradientUnits="userSpaceOnUse"><stop offset=".04" stop-color="#95d840"/><stop offset=".12" stop-color="#84d34a"/><stop offset=".27" stop-color="#6acc59"/><stop offset=".41" stop-color="#5ac763"/><stop offset=".52" stop-color="#55c667"/><stop offset=".59" stop-color="#52b86a" stop-opacity=".9"/><stop offset=".73" stop-color="#4c9473" stop-opacity=".65"/><stop offset=".93" stop-color="#435b82" stop-opacity=".25"/><stop offset="1" stop-color="#404788" stop-opacity=".1"/></radialGradient><radialGradient id="radial-gradient-3" cx="65.31" cy="41.69" fx="65.31" fy="41.69" r="58.3" gradientTransform="translate(0 2.35)" gradientUnits="userSpaceOnUse"><stop offset=".09" stop-color="#fde735"/><stop offset=".12" stop-color="#f2dc37"/><stop offset=".22" stop-color="#d7bf3f"/><stop offset=".32" stop-color="#c4aa45"/><stop offset=".42" stop-color="#b89e48"/><stop offset=".52" stop-color="#b59a4a"/><stop offset=".56" stop-color="#a4874e" stop-opacity=".86"/><stop offset=".67" stop-color="#836257" stop-opacity=".59"/><stop offset=".76" stop-color="#69455e" stop-opacity=".38"/><stop offset=".85" stop-color="#573162" stop-opacity=".23"/><stop offset=".92" stop-color="#4b2465" stop-opacity=".13"/><stop offset=".97" stop-color="#482067" stop-opacity=".1"/></radialGradient></defs><g class="cls-7"><g><path class="cls-3" d="M21.28 75c-9.45-.2-15.87-5.95-17.86-13.89-4.44-16.48 7.77-33.29 24.81-31.74 3.97.99 3.55-2.9 3.97-3.97C37.31 11.77 48.95 3.58 62.95 3.58c10.84.0 20.68 5.95 26.78 14.88 1.98 1.98.99 1.98 2.98.99 16.78-5.18 32.04 9.85 31.74 28.77.25 14.48-8.82 26.82-21.82 26.78H21.28z"/><g class="cls-1"><path class="cls-4" d="M39.08 36.61c0-1.65 2.22-2.26 3.23-3.47 3.62-4 11.74-5.31 7.32-11.24-2.27 5.67-22.99 23.77-15.16 7.08 1.69-2.97 1.91-8.54 5.76-9.5-1.27-.62-1.77-3.62-2.91-3.8-1.39 9.89-8.08 18.73-10.61 28.41-3.31-7.14-3.08-9.75 3.83-12.99-.23-1.93-7.47 5.84-3.92-3.97-5.4 2.6-3.12 12.58-.97 18.88 5.12 14.96-16.81-2.97-15.98-12.65-4.17 1.26-3.42 12.04-5.35 6.42-1.13 1.89-2.02 3.91-2.66 6.04 3.45.57 6.76 3.78 8.63 6.49 3.16-.45 2.39 8.88.09 3.18-.12-.86-.61-2.4-.54-.43.32 3.41-4 7.52-7.53 7.5.45 1.21 1.01 2.39 1.66 3.51 2.13-2.81 4.5-.47 7.39-.43 3.09 1.3-1.61 7.26 1.1 8.3-.1-9.47 5.07-9.38 2.55-10.17-1.58-.6.51-1.95 1-2.6 8.23-3.73 2.73 10.98-.14 13.95 3.05.45 3.69-5.2 3.24.53 3.52-.91 1.07-9.42 2.92-13-1.13-9.67 9.76-7.18 15.82-5.23 4.63.41 8.41.06 11.62 2.51.62.49 1.18 1.08 1.64 1.75 3.71 4.57 3.35 9.01.6 14.03 9.71-7.41-4.77-19.21.65-16.37 4.19 3.12 9.85-.22 14.32 2.15 4.31 4.67 8.37 9.84 10.05 15.22.8-2.57 2.07-1.42 3.29-1.62-4.75-3.64-8.63-9.2-12.28-13.96-5.62-3.65-25.92-.82-9.47-8.28 7.04-3.33 11.63 6.64 10.8 1.91-4.11-9.5-13.3-1.38-19.97.35-5.52 2.06-16.2-2.71-8.62-8.4 4-3 4.17-5.94 9.14-4.7 2.74.4 5.76-2.28 8.68-1.16-.79-2.98-15.7 1.61-10.1-4.2-.35-.29-.66-.78-.84-1.24-.03.02-.06.05-.09.08-3.02 3.91-4.59 4.4-8.2 1.12zm4.42 5.11C41.86 44.71 34.88 52 30.69 52c-.22-3.14 2.1-3.25 4.29-2.71-.6-4.14-1.62-6.05 2.02-10.22 2.19-1.79 4.93 2.53 6.49 2.65zm-13 6.49c-2.65 3.61-.78-5.83.27-7.27.99-4.05 5.46-3.81 3.92-1.47.0.0-4.19 8.73-4.18 8.74zM7.68 40.34c-.81-7.97 3.82 4.37 4.02 6.94.26 3.3-3.83-3.96-4.02-6.94zM6.39 45.27c-.29-2.18 1.79 1.49 1.94 2.13-.85.11-1.72-1.27-1.94-2.13zm6.68 9.44c-1.6-3.96 7.74.52 3.71 2.54-2.26 2.17-3.49-.44-3.71-2.54zM11.5 64.3c-5.52-.18-2.8-2.82.37-3.05.8.68 1.27 3.4-.37 3.05zm1.01-4.59c-.42-2.01 2.47-.15 1.23 1.04-.66.24-1.03-.44-1.23-1.04zM20 57.92c-6.38 1.71 2.24-4.72 1.61-1.88-.08 1-.33 1.96-1.61 1.88zm17.77-3.25c-.82.35-10.45-1.5-4.75-2.02 2.55-1.97 5.4-2.07 4.75 2.02z"/><path class="cls-5" d="M118 50.29c-.13.0 2.29-.14 1.38-.09 2.04-.11 4.09-.2 6.09.18.04-.82.05-1.66.03-2.49-1.45-.36-6.51 1.44-5.5-.89 2.25-5.9-2.13-4.56 4.94-4.52-.1-.54-.21-1.07-.34-1.59-4.17.37-2.95-1.14-1.02-3.45-.24-.69-.52-1.37-.81-2.04-3.52 8.77-12.06-.08-19.88 5.76 1.3-3.89 9.12-13.26 13.19-15.55-1.03-1.02-2.13-1.95-3.29-2.81-1.25 3.94-4.85 6.69-7.28 9.84-2.63 3.29-8.74 15.1-13.48 9.18-2.04-2.84-5.08-4.94-7.15-7.82-1.49-1.78-3.02-3.65-4.57-5.02-.27.37-.55.73-.85 1.07 6.54 6.95-2.67-.13-5.14 2.84 5.99 1.39 13.69 4.58 16.01 10.5-.64 1.92-3.86 3.5-5.45 1.99-.07-.75 1.69-2.45-.37-1.85-2.28 1.51-3.8-2.3-5.34-3.37-1.7-1.57-5.25-2.76-7.13-4.43-.47.24-1.47.67-1.99.91.29.29.65.57 1.07.84 2.76 2.08 12.52 4.23 9.86 8.93-2.01 1.66-2.24 5.79-5.69 4.52-5.25-.49-6.68 1.57-11.83-.29l-.72 1.38c.64.19 2.42 1.08 3.96 1.17 2.48.3 9.1-2.45 6.68 2.44-3.13 5.99-10.75 11.92-10.75 11.92l.1 1.33s6.17-3.43 8.77-7.79c3.29-3.31 5.37-9.82 11.25-7.61 3.49.24 4.86-4.71 8.59-3.73 2.73 2.02-3.88 9.22-4.02 10.62-.24 11.82-8.57 8.95-14.33 15.63h1.67c2.24-2.62 4.21-1.96 8.07-3.25 4.84-6.5 5.36-1.01 2.01 3.25 1.68-.18 3.74-.03 5.52.0.35-1.67 2.07-1.7.13-4.2-1.46-1.42-.38-5.11 1.23-1.73 1.08 2.25 1.22 4.25 2.79 6.93h1.63c-5.73-7.01 1.76-5.76.4.0h2.03c.8-3.57-1.93-6.05-2.93-8.33-.82-3.71-3.55-6.9-3.57-10.65.36-4.44 6.91-11.88 10.91-6.97 1.5 2.38 1.42 5.7 3.45 7.86 1.72 1.67 1.33 3.82 2.15 3.89 3.26-.66 4.33 5.93 5.43 4.46.46-1.24 2.99.09 4.25.66.47-.51.91-1.04 1.34-1.59-5.3-.84-14.32-5.63-4.83-7.91-1.3-.88-3.22.17-4.33.9-2.65 3.24-6.36-6.6-6.12-8.46 3.5 3.19 9.34 4.59 13.11 7.73 1.22 1.17 3.83 1.3 5.39 2.56.16-.35.33-.7.48-1.06-2.97-2.33-6.75-3.61-9.7-5.82-.14-2.32 1.67-4.37 4.51-3.99h0zM78.2 52.66c-1.37.94-.91-2.06.74-.5-.09.17-.54.35-.73.51h0zm7.48-3.74c-2.09 2.34-7.25 4-3.22-.71.92-1.95 4.69-2.01 3.22.71zM91.97 46.89c4.09-5 6.47 2.03-.23.22.07-.07.15-.14.22-.23h0zm-2.47 26c-3.77 4.24-2.02-4.9-.83-2.19.28.82.79 1.36.83 2.19zM91 59.34c6.91 17.02-3.98 7.87-.79-.68.3.12.79.68.79.68zm26-16.97c3.87.0 2.34 2.5.9 4.63h0c-1.49 4.08-6.15.98-7.79-1.37-.65-.59-.53-1.5-.92-2.14-.7-.39-.99.16-1.23.88-1.11 3.5-6.71-1.11-1.51-1.43 3.78-.52 5.83-1.27 10.55-.56h0zm-8 8.42c-1.28-.74-5-2.77-5-3.79.08-1.59 7.03 2.58 8.67 2.67 1.95.51.37 2.29-.81 2.57-1.34.31-1.53-1.01-2.86-1.47h0z"/><path class="cls-6" d="M112.79 21.37c-4.83 1.62-8.28 3.81-11.61 7.7-1.98.41-3.81 1.04-5.52 2.11-2.38.67-.38-.84.52-1.11 1.46-.85 2.44-2.27 3.5-3.55 1.29-1.29 2.82-2.27 4.25-3.42 1.8-1.51 4.43-1.6 6.3-3.04-.16-.07-1.86-.73-2.02-.79-2.44 1.94-4.68 3.72-3.11-.85-.33-.07-.67-.13-1-.18-1.18 4.44-5.38 7-8.18 10.39h0c-4.58 4.51-10.99 6.03-17.23 6.66-1.1.0-3.46.72-4.05-.22.59-1.11 2.52-1.33 3.61-1.96 1.68-.73 3.37-1.56 4.71-2.78 1.84-1.48 2.22-3.96 3.87-5.61 1.63-2.25 1.88-5.14 3.45-7.48-.03-.05-1.03-1.39-1.04-1.4-.21.34-.41.68-.63 1.03h0c-1.16 1.45-1.24 3.09-1.74 4.61-.41 1.37-1.51 2.45-2.18 3.72-1.22 2.01-2.41 4.14-4.24 5.67-2.15 1.17-2.2.35-1.29-1.6.56-2.33.72-3.34 1.94-5.07 1.11-2.2 1.5-4.71 2.82-6.82.73-1.13.34-2.59-.7-.51-.68 1.21-1.33 3.01-1.93 4.16-.22.82-.56 1.57-.67.59-.19-2.05.8-3.74.46-5.73-1.1-1.82-.25-7.5-.09-7.79-.05-.03-1.96-1.23-2.03-1.27-1.95 5.67 1.89 7.11.53 11.87.04 4.03-2.49 7.32-2.89 11.26-.12.39-.74 1.11-.84.45.61-2.02-.74-1.2-2.02-2.41-2.57-2.38-3.08-7.32-2.35-10.58.36-1.33 1-2.58 1.86-3.64.46-2.88 2.09-5.54 2.99-8.33-.16-.08-2.12-.89-2.27-.94-.45 2.04-.84 4.18-1.52 6.17-.45 2.25-2.2 3.94-2.36 6.26.02.66-.33 1.26-.55 1.88-1.43 2.92 1.39 5.75.93 8.75.2 1.92 1.12 3.29-1.08 4.7-1.3.97-2.84 2.16-4.54 2.28-.45-.61.65-2.82-1.03-.47h0c-2.03 3.69-5.64-.13-2.93-2.62 4.66-5.7 2.04-5.15 3.81-9.44h0c1.32-3.01 4.65-4.4 3.52-7.87.1-3.43 2.19-7.5 1.83-10.8l-1.12-.24c-.26 1.34-.48 2.64-.4 4.02-.04 2.21-1.32 4.17-1.6 6.34.15 1.48.95 2.64-.1 3.96-.65.67-1.7 1.64-2.19 2.4-1.55 1.32-2.42-6.26-1.96-7.23.67-3.39-.98-6.6-.28-10.04-.12.0-.93.03-1.06.04.34 1.94-.01 3.44-.17 5.43.46 1.76 1.03 3.6.52 5.41-.7 4.24-4.07 6.52-3.58 11.36 1.03 2.85.68 5.44-.27 8.24-.53 1.06.0 5.05-2 4.02-1.74-2.8.05-5.75.14-8.66.0-1.74-1.12-3.52-.56-5.24.73-1.75-.16-4.04 1.55-5.3 2.5-2.58.65-5.76-.47-.78-.59 1.19-1.38-.04-1.66-.89-.71-1.61-.28-3.35-.27-5.03-.18-2.62-.02-5.28 1.12-7.75-.12.03-1.36.35-1.42.37-1.1 2.86-1.52 4.53-.79 7.43-.66 2.96-.61 3.59.58 6.39.87 3.63-1.9 2.8-1.44 8.73.16 1.2-.63 1.36-1.29.68-.86-1.07-.16-2.15-1.51-3.31-.62-.72-.06-1.69-.03-2.53.25-2.08.0-4.22-.63-6.22h0c-.84-2.52-2.41-4.88-4.28-6.78-.25.17-.49.34-.75.52 1.66 1.3 2.32 3.37 3.45 5.08 2.47 3.68-.14 8.49 1.78 10.56.72 1.77 1.15 3.73 1.73 5.54 1.68 1.98 2.39 4.32 1.05 6.74-1.43 2.22-3.68-.36-5.51-.55-1.96-1.02-2.35-3.76-2.91-5.52-.35-1.9.58-2.01-.04-4.4-.4-1.57-1.43-3.01-1.74-4.62-1.59-2.91-3.31-1.95-4.85-6.19-.13.16-.66.83-.79.99 1.06 1.89 2.4 3.66 4.12 4.98.79 1.76 1.3 3.74 2.13 5.51.34 1.33-.42 2.68-.11 4.01.08 1.22 1.54 2.95 1.32 4.22-2.15-.1-4.23-1.41-5.5-3.11-.49-.93-.49-2.18-1.29-2.94-2.23-1.76-3.44-4.41-4.23-7.07-.08.14-.71 1.41-.7 1.41 1.19 2.29 2.19 4.72 4.07 6.56.72 2.75 2.26 4.41 4.72 5.36-6.78-.4-7.18-3.37-11.02-7.76-.37.25-.82.41-1.28.45 1.09 1.38 2.38 2.65 3.35 4.12-2.3 2.02-6.36-2.89-8.34-4.11-.15.01-3.42.55-3.45.56 2.98 1.57 5.69 3.35 8.73 4.75 1.53.82 3.65.4 4.99 1.66-9.2-.03-10.25.14-18.54-4.71-.14.07-2.75 1.52-3.12 1.76 1.43.82 2.94 1.01 4.45 1.64 1.03.78 2.18 1.35 3.4 1.77 4.12 1.58 8.52.46 12.76.91 4.44 1.05 9.24.18 13.48 2.03 2.02.78 3.98 1.75 6.03 2.38 1.71.54 3.77.86 4.96 2.3 1.32 4.68 6.4 4.02 3.83 9.74-1.79 1.8-4.73 2.03-6.29 4.17-1.39 1.73-3.38 2.69-5.09 4.04-1.41 1.2-2.53 2.82-4.1 3.82h0c-.06.04-.11.08-.17.11-2.58 1.01-5.57 1.25-8.26 2.08-2.06.03-4.31-.13-6.27.62-1.09.48-2.2 1.03-3.36 1.34-10.22 1.43-5.56 1.84-13.83 5.59.48.17 2.98.8 3.12.83 4.48-3.62 6.08-3.99 11.38-5.04 3.56-1.53 3.76-2.9 8.13-1.86 1.77-.47 3.55-.74 5.29-1.31 2.41-.89 4.13-.85 2.04 1.68h0c-1.31 1.82-3.39 4.37-3.45 6.19h2.58c-.2-4.82 6.06-7.69 8.28-12.13 1.27-1.97 3.45-2.82 5.14-4.38.97-.92 2.54-2.81 3.71-1.29.14 3.65 3.26 7.31 1.24 10.85-.69 1.71-.14 3.01-1.43 4.01h0c-1.71 1.19-3.55 2.03-4.33 2.94h2.42c.63.0 2.25-1.23 2.08.0h1.95c.19-1.48.5-1.97 2.47-4.07 1-3.33-.67-7.27 1.55-10.25 2.65-3.86 3.88-.24 5.64 2.23 1.45 2.83-2.34 10.21-3.63 13.09h2.69c1.49-3.59 2.99-6.91 4.01-10.35.21-3.24-1.9-4.69 4.14-3.09 2.12.94 3.29 2.92 5.73 3.46 4.45 1.14 8.73 3.1 12.97 4.88 2.9 1.34 5.4 3.44 8.37 4.62l3.13-.6c-2-2.97-6.03-2.52-8.95-4.17-2.25-.96-4.45-2.05-6.72-2.94h0c-1.2-.76-2.56-1.23-3.87-1.76-1.54-.65-2.81-1.66-4.55-1.6-1.79-.41-3.72-2.2-5.46-2.82-7.95-1.51-9.68-2.49-12.64-10.46-.49-2.57.47-4.99 3.33-6.79 1.21-1.27 1.5-3.34 2.36-4.89 1.25-3.14 9.97-2.69 13.22-3.7 5.08-.68 9.49-3.11 14.02-5.27 1.39-.41 2.87-.65 4-1.65 6.46-6.66 4.56-2.64 11.13-6.2-.16-.11-1.84-1.18-2.02-1.28v-.02zM62.94 22c.06-.23.31-.5.57-.48h0c.48.34-.62 1.16-.58.48h0zM61 18.07c.14-.29.21-.64.46-.87.44.33.21 1.16.49 1.62 1.51 3.62-3.59 1.59-.95-.76h0zm-1.8 7.6c.66-1.65-.38-1.75-.09-3.14.28-.42.76-2.44 1.45-1.79.94 1.15.04 2.32-.55 3.38-.39.54-.13 1.28-.53 1.77h0s-.03.04-.05.05h0c-.18.14-.23-.15-.22-.28h0zM60.1 30c.75-2.03.54-4.26 1.51-6.22.22-.47.89-1.09.85-.12.45 1.44.54 2.65-.6 3.82-.48.82-.7 1.76-1.2 2.57-.34.62-1.02 1.05-.55-.05h0zm-5.55 7.12c1 .88-1.07.76-.7.0.17-.6.43-.4.7.0zM54.69 29.11c.07.65-.03 2.1-.86 1.73-.19-.11-.28-.3-.27-.5.98-1.82.1-2 .58-3.77.11-.3-.07-1.03.23-.41.53.92.08 1.97.31 2.94zM71.66 28c.59.52 1.07 1.15 1.52 1.77.95.77-.11 1.93-1.13 1.75-.23-.08-.2-.33-.18-.53.12-1.09-.58-2.23-.53-3.25.11.08.21.17.3.25h0zM58.86 38.92c-1.33-.93 2.06-1.25 2.58-1.7 1.16-.5 2.55-.93 3.71-.22 1.55.4-1.24.7-1.63.99-1.61.62-2.88 2.02-4.65.94zM63.54 61c-.63 1.31-1.24-.76-1.38-1.32-.14-1.33-.52-3.59.29-4.71 1.45-1.79 3.12-.44 3.38 1.4-.29 1.69-1.69 3.01-2.3 4.62h0zM70.15 37c-.88.1-3.33.49-3.19-.91.61-.43 1.36-.64 1.96-1.09.41-.35.84-.8 1.43-.79.61.0.89.63 1.16 1.08.67 1.04-.45 1.59-1.37 1.7h0z"/></g></g></g></svg></span><span class=navbar-brand__name>HortaCloud</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about/><span>About</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class=nav-item><a class=nav-link href=/publications/><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/team/><span>Team</span></a></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.7b51b548bc9361415cec1d9d43977ad3.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>HortaCloud Documentation</h1><ul><li>1: <a href=#pg-6e17e09fffc1050f46600282def85180>Overview</a></li><ul></ul><li>2: <a href=#pg-9826365741ca5442a2b347073119085b>User manual</a></li><ul><li>2.1: <a href=#pg-2cc166fddc11bf2274cfaa7611dfdd8f>Concepts</a></li><li>2.2: <a href=#pg-02fee88c4b81e201bf16fb7a1e85955f>AppStream Basics</a></li><li>2.3: <a href=#pg-feb9c9a2c6a51ac83203e3b736cd241c>Tutorials</a></li><ul><li>2.3.1: <a href=#pg-d89a53f23767385001697bb44d6058e6>Logging in</a></li><li>2.3.2: <a href=#pg-68a002723b2fd29ad5d212e5b6b20154>Viewing images</a></li><li>2.3.3: <a href=#pg-43ac18dcac3f921c5a0851ff65f33385>Tracing neurons</a></li><li>2.3.4: <a href=#pg-fca4d40332682cf1269ce3294f1dc88a>Exporting and importing neurons</a></li></ul><li>2.4: <a href=#pg-0c1d4d2c71a58e9bda291973835f8abd>Basic Operations</a></li><li>2.5: <a href=#pg-79b42b49477866bac32f7d6b422d54d7>Features</a></li><li>2.6: <a href=#pg-2b1961a5565e77677ad7d5e4b849b6ec>Reference</a></li><li>2.7: <a href=#pg-b1d565f35ba3dfe73fe7ebb6e3497f34>Synchronized Folders</a></li><li>2.8: <a href=#pg-76ebc5b0c62cb5e65c114e0581fb7578>Reporting issues</a></li></ul><li>3: <a href=#pg-9d2b3fd06ac095b9dc68b7aa8fbf324e>Administration guide</a></li><ul><li>3.1: <a href=#pg-80336952a101429f70d9a84e05c2d806>AWS</a></li><ul><li>3.1.1: <a href=#pg-aa09ac4c336c90970d422edf7c37abe2>Costs</a></li><li>3.1.2: <a href=#pg-a6019a15515da980daf6ab4a20aa0a20>Deployment</a></li><li>3.1.3: <a href=#pg-47be1a16b5df5bb00564696755d43828>Backup & Restore</a></li><li>3.1.4: <a href=#pg-e807886fdd82accb7b13ffd06c600de7>Upgrading</a></li><li>3.1.5: <a href=#pg-758c43e554607493c78a37aa827034b2>Data Import</a></li><li>3.1.6: <a href=#pg-0941c9f4c254e615d6587436cb91b5f6>Troubleshooting</a></li></ul><li>3.2: <a href=#pg-e2af44929e77d40d5c3af05dfa4f6721>Bare metal</a></li><ul><li>3.2.1: <a href=#pg-ad51fc64a31547dbb98cadc6e22fdf62>Two-server deployment</a></li><li>3.2.2: <a href=#pg-5a6700f837d490c2f8cce74416e4c5a0>Three-server deployment</a></li><li>3.2.3: <a href=#pg-52fa8f551b4259f2d27e1238963f5ab4>Installing Docker</a></li><li>3.2.4: <a href=#pg-8c5f034c618e5b4f6fbabf8e6e9865e1>Deploying JACS</a></li><li>3.2.5: <a href=#pg-a0d43dee0f682d26aeeced42f6f523b6>Deploying ELK</a></li><li>3.2.6: <a href=#pg-a8d56f9f9ba6cf350fea8d567173c3e0>Self-signed Certificates</a></li><li>3.2.7: <a href=#pg-92ef9d692f28e2663500b1b1f2e1e902>Storage volumes</a></li><li>3.2.8: <a href=#pg-7a8952308cdb3a7af0e8db8edef7117c>Data import</a></li><li>3.2.9: <a href=#pg-6d70c3f179823392b17699c06103fb1a>Troubleshooting</a></li></ul></ul><li>4: <a href=#pg-c995838bf718c1eeff1a9f27bbce59da>Developer's guide</a></li><ul><li>4.1: <a href=#pg-b3ea425051b85e88366f1255b9a09733>Getting started</a></li><li>4.2: <a href=#pg-c10a3b2defa728cdb37ebb0801c86708>Single server deployment</a></li><li>4.3: <a href=#pg-456a54cd44dab2f393eb1317bc996c84>System Overview</a></li><ul><li>4.3.1: <a href=#pg-458e3631b38500671eb83386a0800733>Persistence</a></li><li>4.3.2: <a href=#pg-6de0d7915d9bbe583ebcb458dc517f90>Tiled Imagery</a></li><li>4.3.3: <a href=#pg-491d5f73fa085d484aef1779d4149a49>Event Handling/Communication</a></li></ul><li>4.4: <a href=#pg-54cfc17f234956ddccf6ffc860b31efe>Contribution guidelines</a></li></ul><li>5: <a href=#pg-8efbf7499fe9c7bde8d2c1bb7ff6ee3c>Editing the documentation</a></li><ul></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-6e17e09fffc1050f46600282def85180>1 - Overview</h1><div class=lead>What is HortaCloud?</div><p>HortaCloud is a streaming 3D annotation platform for large microscopy data that runs entirely in the cloud. It is a free, open source research software tool, developed by Janelia Research Campus.</p><p>It combines state-of-the-art volumetric visualization, advanced features for 3D neuronal annotation, and real-time multi-user collaboration with a set of enterprise-grade backend microservices for moving and processing large amounts of data rapidly and securely. HortaCloud takes advantage of cloud-based Virtual Desktop Infrastructure (VDI) to perform all 3D rendering in cloud-leased GPUs which are data-adjacent, and only transfer a high-fidelity interactive video stream to each annotator’s local compute platform through a web browser.</p><ul><li><p><strong>What is it good for?</strong>: HortaCloud is a powerful tool for 3D visualization and annotation of large-scale microscopy data. It has been used to trace axons across the entire mouse brain by Janelia&rsquo;s <a href=https://www.janelia.org/project-team/mouselight>MouseLight Team Project</a>.</p></li><li><p><strong>What is it not good for?</strong>: HortaCloud is a very specialized tool for sparse microscopy data. It is not intended for annotation of dense data sets, such as electron microscopy (EM) imagery.</p></li><li><p><strong>What makes HortaCloud unique?</strong>: Leveraging state-of-the-art services on AWS allows HortaCloud to run entirely in the cloud, making it possible to visualize terabyte-scale 3D volumes without moving all of that data over the Internet (see diagram below).</p></li></ul><a href=system_architecture.png><img src=system_architecture.png class="rounded mx-auto" style=max-width:500px alt="system architecture diagram"></a><h2 id=where-should-i-go-next>Where should I go next?</h2><p>If you are a HortaCloud user, read through the <a href=/docs/user_manual>User Manual</a> to get familiar with the tools.</p><p>If you are a system administrator or developer looking to deploy an instance of HortaCloud, start with the <a href=/docs/administration/aws>AWS Deployment Guide</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9826365741ca5442a2b347073119085b>2 - User manual</h1><div class=lead>How to use the Horta application</div><p>The sections below describe Horta&rsquo;s basic and advanced features. Generally the sections listed below should be read in the order listed.</p><h3 id=note-on-horta-versions>Note on Horta versions</h3><p>The Horta application exists in two versions that come from a common code base. The <em>cloud</em> version (HortaCloud) that is available here is a reduced version of the <em>desktop</em> version (<a href=https://github.com/JaneliaSciComp/workstation>Janelia Workstation</a>). In fact, we&rsquo;ll often use the word &ldquo;workstation&rdquo; to refer to the Horta application in either form.</p><p>When there are differences between the two versions, they will be noted with &ldquo;(HortaCloud)&rdquo; and &ldquo;(desktop)&rdquo;. If the differences are more substantial, they will be presented like this:</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud only</h4>In HortaCloud, the following control behaves differently from the desktop version.</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Desktop only</h4>The following features is only available in the desktop version of the Janelia Workstation.</div><p>The major user-visible differences between the two versions are:</p><ul><li>HortaCloud does not have access to the local file system or clipboard and requires additional steps to import or export data via those routes (see AppStream Basics section for details)</li><li>HortaCloud datasets typically only include low-resolution 2D data, so some 2D tools are not as useful or may not function in the absence of high-resolution data (eg, automatic path tracing)</li><li>the desktop Janelia Workstation contains tools for viewing, annotating, and managing other unrelated Janelia datasets</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2cc166fddc11bf2274cfaa7611dfdd8f>2.1 - Concepts</h1><div class=lead>High-level description of the data, the software, and the jargon</div><h2 id=data>Data</h2><p>Light microscopes of various kinds can now image an entire fly or mouse brain (eg, resonant scanning two photon with integrated vibrotome or Bessel light sheet). Horta is capable of displaying and annotating the resulting multi-terabyte datasets. The details of how the data should be prepared for use in Horta is covered in the <a href=https://hortacloud.janelia.org/docs/user_manual/reference/>Horta Reference</a> section. In general, though, the data will have these properties:</p><ul><li>size: generally limited by disk space (local or cloud)</li><li>channels: two channels are supported and tested; three channels are supported but not well tested; four or more channels are possible but would require more development</li><li>location: the data will be on a storage system accessible to the image server<ul><li>(HortaCloud) AWS S3 bucket</li><li>(desktop) local or networked storage available to the workstation servers</li><li>the file path to the data should be known to the user if they will be creating samples manually</li></ul></li><li>arrangement: the 2D and 3D images are arranged in multi-resolution octrees; details are covered in the reference section, but the user doesn&rsquo;t need to know them</li></ul><h2 id=software--tasks>Software & tasks</h2><p>Horta includes the Horta 2D viewer, which is the 2D, plane-by-plane, viewing and annotation tool, and the Horta 3D viewer, which supports viewing and annotating the data in three dimensions. The two viewers connect to common data editing and storage functions, many of which can be viewed in the Horta Control Center.</p><p>Horta is designed for a variety of tasks:</p><ul><li>viewing data: panning, zooming in and out, and scrolling through planes; brightness and contrast adjustment</li><li>skeletal tracing of neurons: tracer places connected points on the signal</li><li>text annotation: each point can have arbitrary text added to it</li><li>import/export: skeletons can be imported or exported as SWC files; text notes are imported/exported as JSON (see reference section for details)</li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>Why the name 'Horta'?</h4>&ldquo;Horta&rdquo; is the name of a tunneling silicon based lifeform from the Star Trek original series episode 25 <a href=http://en.wikipedia.org/wiki/The_Devil_in_the_Dark>&ldquo;The Devil in the Dark&rdquo;</a>. Neuron traces in 3D resemble the tunnels such a creature might make in the ground. &ldquo;Horta&rdquo; can also be conveniently backronymed as &ldquo;How Outstanding Researchers Trace Axons&rdquo;.</div><h2 id=workflows>Workflows</h2><p>The basic tools can be used to implement a variety of workflows. For example, a user may trace a neuron entirely on their own. Or two users may trace the same neuron, export their results, and a later user may compare those results either by importing them both back in to the workstation or using other tools. If computational methods can trace neurons and export the results as SWC files, those results can be imported into the workstation for validation and/or correction and extension by later users. This flexibility supports neuron reconstruction at both small and large scales.</p><h2 id=jargon>Jargon</h2><ul><li>basic objects in Horta:<ul><li><code>sample</code>: the data; specifically, the object in the workstation that represents a particular image dataset; it&rsquo;s independent of user, and it&rsquo;s all you need if you are only viewing the data</li><li><code>workspace</code>: the object in the workstation that collects a set of annotations (traced neurons and text annotations); it is owned by a user or group, and it contains neurons</li><li><code>neuron</code>: the object that holds the traced neuron skeletons; a neuron usually contains one or more neurites</li><li><code>neurite</code>: a single skeleton or tree; a group of annotations with parent-child relationships, all tracing back to a single root without a parent</li><li><code>annotation</code>: a single point that may have zero or one parent and zero or more children; annotations are sometimes called anchors</li><li><code>tag</code>: a word or phrase attached to a neuron; it may be used in filtering the neuron list or in controlling neuron appearance</li><li><code>owner</code>: a username or group that owns the neuron; if a neuron is owned by a user, only they may change it; if a neuron is owned by a group, any member of the group may take sole ownership of the neuron (and then change it)</li></ul></li><li>data and data formats:<ul><li><code>tiles</code> or <code>octree</code>: the files holding the 2D data</li><li><code>ktx tiles</code>: the files holding the 3D data</li><li><code>SWC file</code>: a common multi-column text file format for storing neuron skeletons</li><li><code>JSON file</code>: a common structured text file format used to import/export text annotations</li></ul></li><li>tracing methods & workflows:<ul><li><code>manual</code>: a tracer clicks along the signal in the data to create a neuron skeleton</li><li><code>semi-automated</code>: a computer program partially traces the signal in a dataset; the fragments are imported into the workstation; a tracer connects and/or extends fragments as needed to produce the skeleton</li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-02fee88c4b81e201bf16fb7a1e85955f>2.2 - AppStream Basics</h1><div class=lead>Some general information about running HortaCloud in the AppStream environment</div><h2 id=the-appstream-environment>The AppStream environment</h2><p>In general, the AppStream environment behaves like a Windows desktop computer running a single application, Horta. Because it&rsquo;s running in a browser, though, there are some important differences. Many of them are managed via the AppStream toolbar at the top of the screen.</p><p>Older AppStream toolbar:</p><a href=../AppStream-toolbar.png><img src=../AppStream-toolbar.png class="rounded mx-auto" style=max-width:761px alt="AppStream 1 toolbar"></a><p>Newer AppStream toolbar:</p><a href=../AppStream2-toolbar.png><img src=../AppStream2-toolbar.png class="rounded mx-auto" style=max-width:1076px alt="AppStream 2 toolbar"></a><h3 id=data-import-and-export-file-system-and-clipboard>Data import and export: file system and clipboard</h3><p><strong>Note</strong>: The AppStream toolbar may differ slightly; the icon positions referred to below are for the older AppStream version.</p><p>Web browsers are constrained with respect to how they read and write data on a computer, and applications running in virtual machines displayed in a browser, even more so.</p><p>File system access: the third icon from the left opens a dialog showing &ldquo;My Files&rdquo;, and within it, a &ldquo;Temporary Files&rdquo; location. This is a file location on the remote computer running Horta and Horta can read and write to. You can then transfer files from that location to your local computer via the &ldquo;My Files&rdquo; dialog box. See &ldquo;Importing Data&rdquo; and &ldquo;Exporting Data&rdquo; in the &ldquo;Basic Operations&rdquo; section for more details.</p><p>Clipboard access: if you copy anything in Horta to the clipboard, it&rsquo;s only accessible on the remote computer. The fourth icon from left on the toolbar will transfer the remote clipboard&rsquo;s contents to the local clipboard.</p><h3 id=windows-and-screens>Windows and screens</h3><p>Horta users often want to see the 2D and 3D views simultaneously, or they want a maximum 3D view while leaving room for the Data Explorer and/or Horta Control Center. To enable use of multiple monitors, click the seventh icon from left on the toolbar. There is also a full-screen mode enabled via the sixth icon.</p><p>The second icon on the toolbar shows all windows, in case you undock a Horta Window and then lose it behind a larger window. There&rsquo;s also a terminal window from which Horta is initially run; this can be ignored. If you close it, it will close Horta.</p><h3 id=quitting-and-relaunching-horta>Quitting and relaunching Horta</h3><p>Sometimes Horta does have issues. Often reloading data by reopening a workspace will clear them up. If not, to relaunch the application again without ending the AppStream session, choose File > Exit or click the &ldquo;x&rdquo; at top right. Then relaunch the application by clicking the first icon in the toolbar and choosing &ldquo;Horta Workstation&rdquo; again.</p><h3 id=ending-the-session>Ending the session</h3><p>Generally sessions will automatically close after a period of inactivity. To end the session manually, you can choose &ldquo;End Session&rdquo; from the drop-down menu on the top-right toolbar button.</p><p>Remember that when you end a session, some data that is stored on the remote computer will be lost:</p><p>Volatile data:</p><ul><li>files in &ldquo;MyFiles/Temporary Files&rdquo;</li><li>information on the clipboard</li></ul><p>All other data (sample data, workspace data, annotations, notes, etc.) is stored in the database and is not lost when a session ends.</p><h3 id=reconnecting>Reconnecting</h3><p>If your browser window is accidentally closed, your session is not lost. Simply repeat the login steps, and you will be reconnected to the session, even if from a different browser and/or computer.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-feb9c9a2c6a51ac83203e3b736cd241c>2.3 - Tutorials</h1><div class=lead>Some Horta tutorials: how to login and start HortaCloud, how to view images, and how to trace neurons</div><p>Each of the tutorials builds on the preceding tutorials, and they should be completed in order.</p></div><div class=td-content><h1 id=pg-d89a53f23767385001697bb44d6058e6>2.3.1 - Logging in</h1><div class=lead>How to log in to HortCloud and start the Horta application</div><p>In this tutorial, we&rsquo;ll go over the steps needed to log into HortaCloud and start the Horta application.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud only</h4>This tutorial applies to HortaCloud only.</div><h2 id=prerequisites>Prerequisites</h2><ul><li>You should know the URL for the HortaCloud instance that you will be using.</li><li>The administrator of the instance should have created an account for you.</li><li>You should know the username and password for that account.</li></ul><p>The screenshots below were taken from the Janelia instance in June 2022.</p><h2 id=steps>Steps</h2><p>The steps to log in to HortaCloud and starting the Horta application are similar to the steps for many web applications. The procedure is straightforward, but we&rsquo;ve provided screenshots of every step to help troubleshooting when things go wrong.</p><h3 id=navigate-to-your-hortacloud-websites-url-in-your-browser>Navigate to your HortaCloud website&rsquo;s URL in your browser.</h3><p>You are probably already on the site, if you&rsquo;re reading this documentation! Click the button on the right labeled &ldquo;Login to HortaCloud&rdquo;.</p><p>All major browsers are supported: Safari, Google Chrome, Mozilla Firefox, and Microsoft Edge.</p><a href=../images-logging-in/1-front-page.png><img src=../images-logging-in/1-front-page.png class="rounded mx-auto" alt="HortaCloud home screen"></a><h3 id=enter-your-username-and-password-given-to-you-by-your-local-administrator-in-the-entry-fields-then-click-the-login-button>Enter your username and password given to you by your local administrator in the entry fields, then click the &ldquo;Login&rdquo; button.</h3><p>On this page, there are also links for changing your password and for requesting a password reset if you have forgotten your password.</p><a href=../images-logging-in/2-login-blank.png><img src=../images-logging-in/2-login-blank.png class="rounded mx-auto" alt="HortaCloud portal username and password screen"></a><h3 id=click-appstream-login-to-continue>Click &ldquo;AppStream Login&rdquo; to continue.</h3><p>This screen also contains a change password link, and if you are a Horta application administrator, you will also see tools for managing users and groups in Horta.</p><a href=../images-logging-in/2-login-portal.png><img src=../images-logging-in/2-login-portal.png class="rounded mx-auto" alt="HortaCloud portal when logged in"></a><h3 id=click-horta-workstation-to-start-the-application>Click &ldquo;Horta Workstation&rdquo; to start the application.</h3><p>This is currently the only application in HortaCloud.</p><a href=../images-logging-in/3-app-list.png><img src=../images-logging-in/3-app-list.png class="rounded mx-auto" alt="AppStream application list"></a><h3 id=wait-for-application-startup>Wait for application startup</h3><p>As the application starts, which can take a couple minutes, you will see a wait screen (first image below). The percentage should steadily increase. After that, you will see a brief console screen (second image below), then the Horta application itself (third image below).</p><p>The list of folders you see in the &ldquo;Data Explorer&rdquo; in Horta will be different and will depend on what data is available in your instance and which data you personally have permissions to see.</p><a href=../images-logging-in/4-wait-screen.png><img src=../images-logging-in/4-wait-screen.png class="rounded mx-auto" alt="AppStream wait screen">
</a><a href=../images-logging-in/5-console.png><img src=../images-logging-in/5-console.png class="rounded mx-auto" alt=console>
</a><a href=../images-logging-in/6-Horta.png><img src=../images-logging-in/6-Horta.png class="rounded mx-auto" alt=Horta></a><h2 id=troubleshooting>Troubleshooting</h2><p>In most cases, if you have trouble launching the Horta application, you should contact your local HortaCloud administrator. If the application launches but you do not see the expected data, you should contact the local Horta application administrator. Of course, these may be the same person.</p><h2 id=ending-your-session>Ending your session</h2><p>You can end your session by clicking on the rightmost icon on the AppStream toolbar and choosing &ldquo;End Session&rdquo;.</p><a href=../../AppStream-toolbar.png><img src=../../AppStream-toolbar.png class="rounded mx-auto" style=max-width:761px alt="AppStream toolbar"></a></div><div class=td-content style=page-break-before:always><h1 id=pg-68a002723b2fd29ad5d212e5b6b20154>2.3.2 - Viewing images</h1><div class=lead>How to load and navigate through images in Horta</div><p>In this tutorial, we&rsquo;ll go over the steps needed to load images in Horta and view them.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud-focused</h4>This tutorial is focused on HortaCloud. However, most of it applies to the desktop version of Horta as well. If you can launch Horta on the desktop, and you see data in the Data Explorer, you should be able to follow most of the other steps of the tutorial.</div><h2 id=prerequisites>Prerequisites</h2><ul><li>You should be able to log into HortaCloud and launch the Horta application, as detailed in the previous tutorial.</li><li>Your HortaCloud instance should have access to the Janelia MouseLight data on Amazon AWS S3.<ul><li>If not, you should have access to some similar data in your HortaCloud instance.</li></ul></li></ul><h2 id=steps>Steps</h2><h3 id=start-the-horta-application>Start the Horta Application</h3><p>Launch the Horta application. See the previous tutorial &ldquo;Logging in&rdquo; for more detail.</p><h3 id=locate-and-examine-data-in-the-data-explorer>Locate and examine data in the Data Explorer</h3><p>The &ldquo;Data Explorer&rdquo;, which appears by default in the upper left panel of Horta, shows a representation of all the data in Horta that you are allowed to see. This data is organized in folders, both created by the system and created by users. The exact list of folder you see will differ depending on which data you have permission to see.</p><p>Click on the triangle to the left of the folder named <code>Home</code> with the owner <code>mouselight</code>, which appears immediately to the right of the folder name, in yellow. This will open the folder to show its contents.</p><p>Click on the triangle to the left of the &ldquo;3D Tile Microscope Samples&rdquo; folder, also owned by <code>mouselight</code>. You will see a long list of samples, indicated by a green flask icon. Each of these sample represents a group of image files on disk or in an AWS S3 bucket.</p><p>For this tutorial, we&rsquo;re going to look at one of the Janelia Mouse Light samples, the <code>2018-07-02</code> sample. Scroll down the list of samples until you see it. Left-click on the sample to select it. You will see information appear in the &ldquo;Data Inspector&rdquo;, located just below the Data Explorer.</p><p>The three tabs of the Data Inspector each show information about the sample. The &ldquo;Attributes&rdquo; tab contains typical metadata like name, creation/modification date, and globally unique identifier (GUID). It also shows the sample&rsquo;s owner and the location of the image files that belong to the sample. The &ldquo;Permissions&rdquo; tab shows which users or groups can read or write to the data. There&rsquo;s also a button which allows someone to grant permissions to other users to see or edit the data. The third tab, &ldquo;Annotations&rdquo;, is not used by Horta and is only used with other tools in the desktop workstation client.</p><a href=../images-viewing/data-explorer.png><img src=../images-viewing/data-explorer.png class="rounded mx-auto" alt="Data Explorer showing target sample"></a><h3 id=open-a-sample-in-horta>Open a sample in Horta</h3><p>Now that we&rsquo;ve located the <code>2018-07-02</code> sample, it&rsquo;s time to open it in Horta.</p><p>Do one of two things:</p><ol><li>Right-click the sample, and choose &ldquo;Open in Horta&rdquo;.</li><li>Left-click the sample to select it; then choose <code>Horta</code> > <code>Open in Horta</code> from the <code>Actions</code> menu.</li></ol><p>At this point, not a lot will visibly happen. When you open a sample in Horta, all that happens is that the dataset&rsquo;s metadata is loaded into the application. The images themselves are not yet loaded. You will see that in the &ldquo;Horta Control Center&rdquo; panel at right, near the top below the &ldquo;WORKSPACE&rdquo; heading, the &ldquo;Sample&rdquo; field will now show the name &ldquo;2018-07-02&rdquo;. That&rsquo;s all (screenshot below). In the next tutorial (&ldquo;Tracing neurons&rdquo;), we&rsquo;ll see that opening a workspace in Horta populates much more information in the UI. The &ldquo;Concepts&rdquo; section of the documentation has more information on the difference between samples and workspaces.</p><a href=../images-viewing/sample-open-hcc.png><img src=../images-viewing/sample-open-hcc.png class="rounded mx-auto" style=max-width:600px alt="sample information in the Horta Control Center"></a><h3 id=open-the-horta-3d-window>Open the Horta 3D window</h3><p>It&rsquo;s time to finally look at some images. For this demonstration, we&rsquo;ll start with the 3D images. Near the top of the Horta Control Center, under the &ldquo;VIEWS&rdquo; heading, find the checkbox labeled &ldquo;Open 3D&rdquo;. Click it so it&rsquo;s checked.</p><p>You will see a window tab titled &ldquo;Horta 3D&rdquo; open in the center panel. The first 3D images will also load. Initially, it&rsquo;ll be underwhelming. Probably you&rsquo;ll see one small bright rectangle in the center of the screen. In the next section, we&rsquo;ll see how to adjust the color. For now, if you left-click in the 3D window, more data will load to cover most of the window.</p><a href=../images-viewing/3d-sample-initial.png><img src=../images-viewing/3d-sample-initial.png class="rounded mx-auto" alt="sample immediately after opening in 3D">
</a><a href=../images-viewing/3d-sample-initial+click.png><img src=../images-viewing/3d-sample-initial+click.png class="rounded mx-auto" alt="sample in 3D after clicking"></a><h3 id=explore-the-data-in-3d>Explore the data in 3D</h3><h4 id=adjust-colors>Adjust colors</h4><p>The default color settings are not good; in general, the data will appear to be a washed out bright, light blue/purple. In order to adjust the color, first we need to go to the &ldquo;Windows&rdquo; menu and choose Horta > Color Sliders.</p><p>Often when the sliders are first opened, their panel will not be the correct height. You can adjust this. Like other panels in Horta, the color slider panel may be resized and docked or undocked from the main window as you like.</p><p>Also, when the color sliders are first opened, often the 3D image will be redrawn, or potentially not drawn at all. If this occurs, left-click in the 3D window to trigger a redraw.</p><p>Even though the data only has two channels (a signal channel and a reference channel), you&rsquo;ll see three sliders. The third blue slider has a specialized use that we&rsquo;re not going to cover in this tutorial. Click the eye next to the blue slider, and the blue channel will be hidden.</p><p>In practice, you will likely spend a lot of time tuning the color settings so the desired biological structures are most visible. For this tutorial, we&rsquo;ll cover a few simple steps to make the data more visible:</p><ol><li>First, you can optionally display the numeric values of the sliders by clicking the <code>#</code> button at the far right of each color slider, just before the color swatch. This is useful if you want to adjust values finely. It&rsquo;s also useful to communicate the values to another user. But note if you want to import or export <em>all</em> of the color settings at once, you can do so using those options on the gear menu in the lower right corner of the color slider panel.</li><li>Click the eye icon to the left of the top, green slider. This turns the green channel data invisible.</li><li>Now drag the leftmost slider of the middle, purple slider to the right. Do this until the blocky, purple background of the image tiles disappears and you can see the purple outline of the brain. For this data, you&rsquo;ll be dragging the slider until it&rsquo;s midway between the left edge and the center lock icon below the sliders. If you have the numbers showing, set &ldquo;Min&rdquo; to around 15600.</li><li>Now do it again for green. Click the eye next to the green slider to show the green channel, and the eye next to the purple channel to hide it. Drag the leftmost slide of the green bar until, again, the blocky background disappears and the brain outline is visible. For this data, try setting it a bit to the left of the left purple slider. That&rsquo;s around a value of 12200 for &ldquo;Min&rdquo;.</li><li>Click the eye next to the purple slide so both data channels are visible again.</li></ol><p>At this point (screenshot below), the labeled neurons, though, stand out in green against the purple background. Feel free to experiment with the other sliders. It&rsquo;s a matter of personal preference. Some tracers prefer to adjust the settings until the background is nearly invisible, so that the neuron signal is prominent, even if dim.</p><p>Note: Color settings are not saved for samples! In the next tutorial, we&rsquo;ll see how these settings <em>are</em> saved in workspaces.</p><a href=../images-viewing/3d-colors-adjusted.png><img src=../images-viewing/3d-colors-adjusted.png class="rounded mx-auto" style=max-width:1200px alt="sample in 3D after minimal color adjustment"></a><h4 id=pan-zoom-rotate>Pan, zoom, rotate</h4><p>Navigating the 3D data is done using the mouse.</p><p>To navigate in space (pan):</p><ul><li>left-click to center on a location</li><li>left-drag to move the image in the view plane</li><li>as you navigate, images will be loaded and unloaded</li></ul><p>To zoom in and out:</p><ul><li>use the scroll wheel to zoom in or out; as you zoom, higher or lower resolutions images will be loaded</li><li>note that as you zoom in, you will see less and less of the thickness of the brain; that is, the displayed data will come from a projection depth that is smaller, allowing you to more clearly isolate smaller structures as you zoom in</li></ul><p>To rotate in 3D:</p><ul><li>middle-click and drag, or hold down the shift key and left-click and drag; the cursor will change to two curved arrows, and the image will rotate in three dimensions</li></ul><a href=../images-viewing/3d-rotated-zoomed.png><img src=../images-viewing/3d-rotated-zoomed.png class="rounded mx-auto" alt="sample in 3D after rotating and zooming"></a><h3 id=open-the-horta-2d-window>Open the Horta 2D window</h3><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud</h4><p>Note that HortaCloud does not store high-resolution 2D images! When you zoom in, the images will be blurry.</p><p>In the Horta desktop application, when you zoom in, higher-resolution images will automatically be loaded.</p></div><p>Loading the 2D images is done just like for 3D. Near the top of the Horta Control Center, in the &ldquo;VIEWS&rdquo; section, find the checkbox labeled &ldquo;Open 2D&rdquo;. Click it so it&rsquo;s checked.</p><p>You will see a window tab titled &ldquo;Horta 2D&rdquo; open in the center panel. The first 2D images will also load.</p><a href=../images-viewing/2d-sample-initial.png><img src=../images-viewing/2d-sample-initial.png class="rounded mx-auto" style=max-width:1200px alt="sample after opening in 2D"></a><h3 id=explore-the-data-in-2d>Explore the data in 2D</h3><h4 id=adjust-colors-1>Adjust colors</h4><p>As with 3D, the default color settings are almost never useful, and we&rsquo;ll quickly adjust them to make the data more visible. In practice, you will likely spend a lot of time tuning the color settings so the desired biological structures are most visible.</p><p>The colors of the two data channels are controlled by the sliders and buttons at the bottom of the middle panel in the &ldquo;Horta 2D&rdquo; tab. They are distinct from the sliders used to adjust the 3D colors.</p><p>NOTE: Sometimes the color slider do not draw correctly when the sample initially opens in 2D. If this is the case, you will see two small checkboxes and two small plus signs at the right of the empty area below the 2D image. Toggle either on of the check boxes off and on, and the sliders should redraw.</p><p>Here are the steps to make some minimal adjustments to the colors:</p><ol><li>As before, you can optionally display the numeric values of the sliders by clicking the <code>#</code> button at the far right of each color slider</li><li>Click the eye icon to the left of the top, green slider. This turns the green channel data invisible.</li><li>Now drag the leftmost slider of the lower, purple slider to the right. Do this until the blocky, purple background of the image tiles disappears and you can see the purple outline of the brain. For this data, you&rsquo;ll be dragging the slider until it&rsquo;s midway between the left edge and the center lock icon below the sliders. Try a value of &ldquo;Min&rdquo; = 15200.</li><li>Now do it again for green. Click the eye next to the green slider to show the green channel, and the eye next to the purple channel to hide it. Drag the leftmost slide of the green bar until, again, the blocky background disappears and the brain outline is visible. For this data, try a location just to the left of the middle purple slider. Try &ldquo;Min&rdquo; = 11800.</li><li>Click the eye next to the purple slide so both data channels are visible again.</li></ol><p>At this point (screenshot), the labeled neurons stand out in green against the purple background. Feel free to experiment with the other sliders. Again, it&rsquo;s a matter of preference, your data, and your display, among other things.</p><a href=../images-viewing/2d-colors-adjusted.png><img src=../images-viewing/2d-colors-adjusted.png class="rounded mx-auto" style=max-width:1200px alt="sample in 2D after adjusting colors"></a><p>Note: Color settings are not saved for samples! In the next tutorial, we&rsquo;ll see how these settings <em>are</em> saved in workspaces.</p><h4 id=pan-scroll-through-z-zoom>Pan, scroll through z, zoom</h4><p>Navigating the 2D data is done using the mouse.</p><p>To navigate in the x-y plane, you can:</p><ul><li>double-left-click on any location to center the view on that point</li><li>middle-click and drag to pan the image to any location</li></ul><p>To navigate along the z-axis, you can:</p><ul><li>use the scroll wheel to change the visible plane</li><li>drag the horizontal slider below the 2D view to change the visible plane</li><li>change the plane number visible in the plane number box to the right of the plane slider by either typing a plane number in the box, or by clicking the up and down arrows in the box</li></ul><p>To zoom the image:</p><ul><li>hold down the shift key and spin the scroll wheel</li><li>drag the vertical slider to the right of the 2D view</li><li>remember, HortaCloud does not has high-resolution 2D images; when you zoom in, it will be blurry!</li></ul><h2 id=x-y-z-locations>x, y, z locations</h2><h3 id=status-bars>Status bars</h3><p>As you move the mouse cursor in either the 2D or 3D windows, you will see the <code>x, y, z</code> location of the cursor displayed in the status bars.</p><ul><li>in 3D, the status bar is at the very bottom of the Horta application window</li><li>in 2D, the status bar is at the bottom of the 2D window; the 3D status bar in this case is not accurate, and it does not update</li><li>in both cases, the <code>x, y, z</code> location is given in microns (µm), as a floating-point number</li></ul><p>The screenshot below shows both status bars, with the 3D bar at the bottom and the 2D bar above it.</p><a href=../images-viewing/status-bars.png><img src=../images-viewing/status-bars.png class="rounded mx-auto" alt="the 2D and 3D status bars"></a><h3 id=copying-location-values>Copying location values</h3><p>You can copy the the current <code>x, y, z</code> location to the clipboard by right-clicking in the view.</p><ul><li>in 3D, right-click and choose &ldquo;Copy Micron Location to Clipboard&rdquo;</li><li>in 2D, right-click and choose &ldquo;Copy Micron Coords to Clipboard&rdquo;</li><li>in both cases, the copied text has the following form: <code>[68665.88,48154.89,26670.117]</code><ul><li>this is convenient for pasting into eg Matlab or Python</li></ul></li><li>(HortaCloud) see the &ldquo;AppStream Basics&rdquo; section in this documentation for how to transfer the data from AppStream&rsquo;s clipboard to your local system&rsquo;s clipboard</li></ul><h3 id=go-to-point>Go to point</h3><p>If you know the <code>x, y, z</code> location you&rsquo;d like to navigate to, and that data is on the clipboard, click the &ldquo;Go to location&mldr;&rdquo; button that appears in the &ldquo;VIEWS&rdquo; section in the Horta Control Center. Paste in the data from the clipboard and click &ldquo;OK&rdquo;. Both the 2D and 3D views will navigate to put that point at the center of the view without changing the zoom level.</p><p>Details:</p><ul><li>the values should be in microns</li><li>you can paste in <code>x, y, z</code> coordinates or just <code>x, y</code>; in the latter case, the current <code>z</code> value will not change</li><li>any brackets or commas will be removed<ul><li>thus you can copy and paste from Horta, or from eg Matlab or Python</li></ul></li></ul><p>Again, HortaCloud users should see &ldquo;AppStream Basics&rdquo; for how to move data from your local system to the AppStream Clipboard.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-43ac18dcac3f921c5a0851ff65f33385>2.3.3 - Tracing neurons</h1><div class=lead>How to trace neurons in Horta</div><p>In this tutorial, we&rsquo;ll go over the steps needed to begin tracing a neuron in Horta in the 3D view.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud-focused</h4>This tutorial is focused on HortaCloud. However, most of it applies to the desktop version of Horta as well. If you can launch Horta on the desktop, and you see data in the Data Explorer, you should be able to follow most of the other steps of the tutorial.</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>3D-focused</h4><p>This tutorial doesn&rsquo;t cover tracing in 2D in detail. Most of it is the same (creating workspaces, neurons, shift-click to add points), but there are some slight differences. See the &ldquo;Basic Operations&rdquo; section for details on 2D tracing.</p><p>For HortaCloud, 2D tracing is rarely useful, as HortaCloud does not usually contain high-resolution 2D data. You&rsquo;re not going to be able to accurately place annotations with the low-resolution data.</p></div><h2 id=prerequisites>Prerequisites</h2><ul><li>You should be able to log into HortaCloud and launch the Horta application, as detailed in the first tutorial.</li><li>You should be able to open a sample in 3D and navigate the data, as detailed in the second tutorial.</li><li>Your HortaCloud instance should have access to the Janelia MouseLight data on Amazon AWS S3.<ul><li>If not, you should have access to some similar data in your HortaCloud instance.</li></ul></li></ul><h2 id=steps>Steps</h2><h3 id=start-the-horta-application-and-open-a-sample-in-horta>Start the Horta Application and open a sample in Horta</h3><p>As detailed in the previous two tutorials:</p><ol><li>Launch HortaCloud</li><li>Locate the <code>2018-07-02</code> sample in the Data Explorer and open it in the Horta Control Center</li><li>Open the sample in the 3D viewer</li></ol><h3 id=create-a-workspace>Create a workspace</h3><p>The sample that is listed in the Data Explorer, that we&rsquo;ve opened in Horta, is the representation of the image data in the database. In general, a user never needs to change this information&ndash;it&rsquo;s a static snapshot of the image data. The sample is shared among all users who will work with that dataset.</p><p>A workspace, by contrast, contains the neurons that a user has traced. The workspace initially belongs to and can only be seen by the user that created it, but it can then be shared with other users and/or groups.</p><p>To create a workspace:</p><ol><li>Open a sample in Horta (as done in the previous step); this is the dataset that the neuron tracing will be associated with</li><li>In the Horta Control Center at right, in the &ldquo;WORKSPACE&rdquo; section, click the button labeled &ldquo;New workspace&mldr;&rdquo;.</li><li>By default, the dialog box that pops up provides a template for naming the workspace. For this tutorial, however, click the &ldquo;Manual override&rdquo; button to name the workspace without using the template. You can use the default name &ldquo;new workspace&rdquo; or enter another name, perhaps &ldquo;tutorial workspace&rdquo;. For this tutorial, leave &ldquo;Assign neurons&rdquo; unchecked.</li><li>Click &ldquo;OK&rdquo;</li></ol><a href=../images-tracing/workspace-naming-dialog.png><img src=../images-tracing/workspace-naming-dialog.png class="rounded mx-auto" alt="naming a new workspace"></a><p>The system will work for a moment, then it will reload the images, this time loading the workspace instead of the sample. You will notice that in the &ldquo;WORKSPACE&rdquo; section of the Horta Control Center, the name you gave the workspace will appear just above the sample name now.</p><a href=../images-tracing/new-workspace-hcc.png><img src=../images-tracing/new-workspace-hcc.png class="rounded mx-auto" style=max-width:373px alt="new workspace in the Horta Control Center"></a><p>In the Data Explorer, this workspace will be located in your &ldquo;Home&rdquo; folder (the one with your username next to it in gold), within the &ldquo;Workspaces&rdquo; subfolder. You may need to click the refresh button (upper left corner, two arrows in a circle) in the Data Explorer before it shows up.</p><p>By default, you are the only person who can see, open, or edit the workspace, save Horta administrators. See the &ldquo;Basic Operations&rdquo; section for how to share data.</p><h3 id=adjust-colors-and-save-the-color-model>Adjust colors and save the color model</h3><p>One immediate advantage of the workspace is the ability to save color settings, which Horta calls the &ldquo;color model&rdquo;. Unlike the sample, which is (potentially) shared among many or all users, workspaces often belong to one user. They are therefore appropriate for storing information like color settings, which are often a matter of personal preference.</p><ul><li>First, if the 3D view is not open, click the &ldquo;Open 3D&rdquo; checkbox and/or switch to the &ldquo;Horta 3D&rdquo; tab as needed.</li><li>Then adjust colors as described in the previous tutorial and shown in screenshots therein. For this sample: set the second purple slider to midway between the left edge and the center lock icons; set the first green slider a bit to the left of the second slider; and hide the third blue channel.</li><li>Next, to save the color model, locate the gear menu in the 3D &ldquo;Color Sliders&rdquo; panel, to the right, just under the three channels&rsquo; color swatches. Note that the &ldquo;Horta 2D&rdquo; tab has its own color sliders. Be sure to use the 3D sliders for this tutorial.</li><li>From the gear menu, choose &ldquo;Save Color Model to Workspace&rdquo;.</li></ul><p>When you save a color model, all of the color slider settings are saved: channel colors, channel visibility, all sliders, and all locks. From this point forward, when you open this workspace, the color model will be loaded. If you change the color settings later and want to keep them, you&rsquo;ll need to save them again, however. The color model does not automatically save itself when changed.</p><p>The same applies to 2D; you can save the 2D color model (separately) from the gear menu in the 2D color slider area in the Horta 2D tab.</p><h3 id=create-a-neuron>Create a neuron</h3><p>Now, deep in the third tutorial, we are <em>finally</em> ready to trace a neuron!</p><p>In Horta, tracing neurons is done by placing a series of connected point annotations along the neuron signal in the images. These points form one or more trees of points, with each point having one parent point and zero, one, or more child points.</p><p>The Horta Control Center contains, below the &ldquo;WORKSPACE&rdquo; and &ldquo;VIEWS&rdquo; sections, a &ldquo;NEURONS&rdquo; section that contains a list of neurons and controls for interacting with neurons.</p><p>To create a neuron, click the &ldquo;Add&mldr;&rdquo; button below the neuron list. The default name is &ldquo;Neuron 1&rdquo;, where the number will be incremented to be larger than existing neurons. You may also give the neuron any name you like, with some restrictions (eg, the <code>*</code> and <code>?</code> characters can&rsquo;t be used). You can rename the neuron at any time by right-clicking its name in the neuron list and choosing &ldquo;Rename&rdquo;. Once the neuron is created, the name will appear in the neuron list, and the neuron will be selected (highlighted).</p><p>The initial color is randomly chosen from a palette of about twenty. If you&rsquo;d like to change the color of the neuron, click the color swatch to the right of the neuron&rsquo;s name in the list and choose a new color from the dialog box.</p><a href=../images-tracing/new-neuron.png><img src=../images-tracing/new-neuron.png class="rounded mx-auto" style=max-width:373px alt="new neuron in the neuron list"></a><h3 id=add-points>Add points</h3><p>Let&rsquo;s find a neuron to trace. You can find any neuron you like (especially if you are not using the 2018-07-02 sample), but we&rsquo;ll provide the location of a sample neuron if you want to follow along closely. This neuron is chosen for demonstration purposes only! It may not even be traceable along its entire length.</p><p>To find the sample neuron:</p><ul><li>Right-click in the 3D view and choose &ldquo;Reset Horta Rotation&rdquo; so you are oriented in the default direction</li><li>Click the &ldquo;Go to location&mldr;&rdquo; button in the &ldquo;VIEWS&rdquo; section of the Horta Control Center (described in more detail in the previous tutorial)</li><li>Enter the following coordinates and click OK: <code>[74130,18910,35035]</code><ul><li>Remember, if you copy and paste these coordinates, you&rsquo;ll need to choose the middle icon on the AppStream toolbar and choose &ldquo;Past to remote session&rdquo; to transfer the coordinates from your local computer&rsquo;s clipboard to the AppStream clipboard; once it&rsquo;s there, you can use control-V to paste as usual</li><li>See &ldquo;AppStream Basics&rdquo; for more information on copying and pasting to and from AppStream</li></ul></li></ul><p>We&rsquo;re going to trace a small part of the bright neuron making a hairpin turn from the right edge of the screen.</p><a href=../images-tracing/target-area.png><img src=../images-tracing/target-area.png class="rounded mx-auto" alt="target area for tracing"></a><p>The neuron you want to trace (&ldquo;Neuron 1&rdquo; in our case) should be highlighted in the neuron list. If it isn&rsquo;t, single click it. The list of annotations below the neuron list should be empty at this time, if you&rsquo;re following the tutorial exactly.</p><p>Navigate to the place you want to start tracing. Often this will be the soma of the neuron, but it can be anywhere. For this tutorial, we&rsquo;ll start placing points in the middle of it. By single-clicking to recenter, dragging the image, and zooming in and out, center the neuron in the view. Feel free to rotate if you like, but to make this tutorial easy to follow from the screenshots, we&rsquo;ll keep the default rotation.</p><p>Now move the mouse pointer over the signal, and over places near the signal but not on it. You&rsquo;ll notice that a blob with the letter &ldquo;P&rdquo; in it appears and reappears as you move the mouse. In fact, you will see that it snaps to the brightest pixels in a small neighborhood around the mouse pointer. If there are no bright pixels, it may not appear at all. This &ldquo;P&rdquo; cursor indicates where the point will be placed. Zoom in as much as you need to place the point accurately. Shift-left-click to place the first point when the &ldquo;P&rdquo; blob is visible and on top of signal. Near the (x, y, z) location shown above is a good place to place the first point.</p><a href=../images-tracing/first-point.png><img src=../images-tracing/first-point.png class="rounded mx-auto" alt="first point placed"></a><p>The first point appears! It&rsquo;ll be drawn in the color of the neuron, and it will also have a &ldquo;P&rdquo; indicator drawn on it (although that indicator may be difficult to read depending on the strength of the signal nearby). At this point, if you were to rotate the view, you&rsquo;ll see that the point lies properly on top of the signal in all dimensions. This is another feature of the &ldquo;P&rdquo; blob cursor: it senses the correct depth at which to place points. That is, it not only finds bright pixels in the plane of the display, it also finds the brightest pixel along the axis perpendicular to the screen (with a larger search neighborhood).</p><p>Move the mouse cursor along the neuron signal and shift-click again, working to the right of the screen on the upper segment. Repeat a few times until you have a short string of annotations, points connected by lines. The most recent point you&rsquo;ve placed always has a (sometimes faint) &ldquo;P&rdquo; icon. &ldquo;P&rdquo; stands for &ldquo;Parent&rdquo;: that is the point to which your next point will be connected.</p><a href=../images-tracing/few-points.png><img src=../images-tracing/few-points.png class="rounded mx-auto" alt="few points placed"></a><p>How densely should you place points? That depends on your intended scientific analysis. If you intend to determine region-to-region connectivity, you can annotate quite sparsely. However, if you intend to calculate neuron length or analyze neuron morphology, you will want to place points with smaller separation. If you&rsquo;re using the tracing as ground truth for machine learning purposes, you may want near pixel-perfect tracing. In this case, look at the main documentation for the &ldquo;automatically traced path&rdquo; feature, in which you can have the computer trace paths between human placed points.</p><h3 id=the-annotation-list-and-more-navigation>The annotation list and more navigation</h3><p>The annotations list, in the &ldquo;ANNOTATIONS&rdquo; section, now contains a summary of the points you&rsquo;ve placed. Not every point is listed&ndash;that would quickly get unwieldy&ndash;but the &ldquo;interesting&rdquo; points are. By default, the list includes every root point, endpoint, and branch point. It does not include points along a linear chain. But it also includes points that have some kind of user annotation attached to them (discussed elsewhere in the documentation). If you&rsquo;re following closely, there will only be two points in the annotation list at this time, the root point and the endpoint.</p><a href=../images-tracing/annotation-list.png><img src=../images-tracing/annotation-list.png class="rounded mx-auto" style=max-width:373px alt="annotation list with two entries"></a><p>Both the annotation list and the neuron list can be used for navigation.</p><ul><li>if you double-click a neuron in the neuron list, the view will center on the first point (the root point) in the neuron</li><li>if you double-click on an annotation in the annotation list, the view will center on it</li></ul><h3 id=moving-and-deleting-points>Moving and deleting points</h3><p>If you make any errors when adding points, there are easy ways to correct them.</p><p>If you need to move a point a short distance, left-click and drag it.</p><ul><li>in 2D, you can only drag in the same plane</li><li>in 3D, you can again only drag in the plane of the view; the point does <em>not</em> snap to bright pixels when you drag, so you&rsquo;ll probably have to rotate and drag multiple times from different angles to fine-tune the location</li></ul><p>To delete a point:</p><ul><li>in 2D: left click on it, then press the delete key on the keyboard</li><li>in 2D: right-click on it, then choose &ldquo;Delete link&rdquo; from the menu</li><li>in 3D: right-click on it, then choose &ldquo;Delete Vertex&rdquo; from the menu</li></ul><p>If you delete an annotation in a linear chain, it&rsquo;ll connect the two surrounding points. You can&rsquo;t delete the root of the tree or branch points (see below for more on branching). If you need to delete multiple points, see the &ldquo;Delete subtree&rdquo; feature described in the &ldquo;Basic Operations&rdquo; section.</p><h3 id=branching>Branching</h3><p>You will see that each time you shift-click, the &ldquo;P&rdquo; indicator moves to the point you&rsquo;ve most recently placed. &ldquo;P&rdquo; stands for &ldquo;Parent&rdquo;: that is the point to which your next point will be connected. This is how you&rsquo;ll create branches.</p><p>If you&rsquo;ve been following this tutorial closely, your neuron should be approaching a place where the signal branches. Continue adding points headed left until you reach the branch, and place a point directly on the branch location. If you&rsquo;re tracing on different data, find a convenient branch point, or imagine one (it&rsquo;s only a tutorial!).</p><p>At this point, the next parent icon (&ldquo;P&rdquo;) should be on the branch. Choose one arm of the neuron to trace, and add a few points. Now, go back to the branch point and single-click it so it again shows the &ldquo;P&rdquo; icon. This indicates that the next point you place will use this point (the branch point) as its parent. Add a few more points along the other branch. You&rsquo;ve now got a branching structure.</p><a href=../images-tracing/branch.png><img src=../images-tracing/branch.png class="rounded mx-auto" alt="branched neuron"></a><p>The annotation list now shows the root point, the branch point, and two endpoints.</p><a href=../images-tracing/annotation-list-branch.png><img src=../images-tracing/annotation-list-branch.png class="rounded mx-auto" style=max-width:373px alt="branched neuron"></a><p>There are workflows that help you manage the task of tracing a branched structure. See, for example, &ldquo;Simple workflow with notes and filters&rdquo; in the &ldquo;Features&rdquo; section</p><h2 id=continuing-work-in-the-workspace>Continuing work in the workspace</h2><p>Annotations are saved to the database immediately after they are placed. This goes for all operations; the application is in constant communication with the database, and all changes are saved immediately. You can quit at any time, and no work will be lost. In this respect, HortaCloud acts more like a mobile application than a desktop application.</p><p>When you want to continue work, simple open the workspace from the Data Explorer just as you earlier opened a sample. That is, right-click it in the Data Explorer and choose &ldquo;Open in Horta&rdquo;. The neuron data will load immediately. After that, you can choose &ldquo;Open 3D&rdquo; and continue work tracing.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-fca4d40332682cf1269ce3294f1dc88a>2.3.4 - Exporting and importing neurons</h1><div class=lead>How to export and import neurons from/to Horta</div><p>In this tutorial, we&rsquo;ll go over how to export and import traced neurons from/to Horta.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>You should be able to log into HortaCloud and launch the Horta application, as detailed in the first tutorial.</li><li>You should be able to open a workspace in 3D and navigate the data, as detailed in the second tutorial.</li><li>You should be able to create and add points to a neuron, as detailed in the third tutorial.</li></ul><h2 id=steps>Steps</h2><h3 id=open-the-workspace>Open the workspace</h3><p>Launch HortaCloud and open the workspace created in the previous tutorial, or any other workspace that you can trace in.</p><h3 id=exporting-neurons-as-swc-files>Exporting neurons as SWC files</h3><p>Once you&rsquo;ve finished tracing a neuron, you will probably want to export the data for analysis or visualization in another piece of software. Horta supports import and export to the standard SWC file format. Details of the SWC format can be found in the &ldquo;Reference&rdquo; section.</p><p>To export a traced neuron:</p><ol><li>Right click on its name in the neuron list and choose &ldquo;Export SWC File&rdquo;. A file dialog box will open.</li><li>Name the file whatever you like. An extension of &ldquo;.swc&rdquo; is strongly recommended. The two options on the right are discussed in the &ldquo;Basic Operations&rdquo; section. The defaults are appropriate almost all of the time.</li><li>Choose the export location. For desktop, choose any location you like on your hard drive. For HortaCloud, we need to save to an intermediate location first. At the top of the dialog box, click the &ldquo;Save in&rdquo; drop-down menu and choose &ldquo;Temporary Files&rdquo;.</li></ol><a href=../images-import-export/export-dialog.png><img src=../images-import-export/export-dialog.png class="rounded mx-auto" alt="export neurons dialog"></a><ol start=4><li>Click &ldquo;OK&rdquo;. A &ldquo;Background Tasks&rdquo; window will open with a progress bar. This operation is very fast, and you may not even see the bar before it&rsquo;s filled. For desktop Horta, you&rsquo;re done after this step.</li><li>For HortaCloud users, you now need to download your file(s) from the &ldquo;Temporary Files&rdquo; location on AppStream. The AppStream toolbar appears at the top of the browser&rsquo;s content window, above the top of the Horta main window. Click the third icon from left, which has a tooltip of &ldquo;My Files&rdquo;.</li><li>In the new dialog box that opens, click &ldquo;Temporary Files&rdquo;. This is a web view into the folder where you exported your neuron. At the right end of the row for each file in this directory is a downward facing chevron. Click it and choose &ldquo;Download&rdquo; from the drop-down menu. Depending on your browser, you may be prompted to choose a location, or the file may be downloaded to your default downloads location. Also depending on your browser, you may need to authorize or confirm the download from the AppStream site.</li></ol><a href=../images-import-export/temporary-files-download.png><img src=../images-import-export/temporary-files-download.png class="rounded mx-auto" style=max-width:1200px alt="download from temporary files"></a><div class="alert alert-primary" role=alert><h4 class=alert-heading>Temporary means temporary!</h4>The name &ldquo;Temporary Files&rdquo; is accurate! The files in this location will be deleted when your session ends. You <em>must</em> download any exported neurons to your local computer in the same session in which you exported them.</div><h3 id=importing-neurons-from-swc-files>Importing neurons from SWC files</h3><p>Importing neurons from SWC files is basically the same as exporting, in reverse. Again, the HortaCloud procedure involves an intermediate location.</p><p>If you&rsquo;ve been using the Janelia <code>2021-03-17</code> sample for your test, you can <a href=..//images-import-export/test-neuron.swc>download a test neuron to import</a> (right-click and download the linked file). If you don&rsquo;t have access to the Janelia sample we&rsquo;re using in these tutorials, you can test importing a neuron into your own sample and workspace by simply exporting any neuron (as in the previous section), deleting the neuron using the &ldquo;-&rdquo; button under the neuron list, and then reimporting the same neuron.</p><p>To import a traced neuron:</p><ol><li>Open a workspace that corresponds to the same sample the neuron was exported from. In other words, the exported neuron&rsquo;s SWC file must be using the same coordinate system and same scale as the target sample. If not, the imported neuron will not lie on top of the neuron signal in the images. In many cases, it will be imported somewhere in space far from the brain imagery.</li><li>(HortaCloud only) Upload the SWC file to AppStream. Click the &ldquo;My Files&rdquo; icon on the AppStream toolbar (third from left). Click &ldquo;Temporary Files&rdquo;. You can drag files directly to this dialog box, and they will be uploaded. Alternately, click &ldquo;Upload files&rdquo; and choose the files from the file dialog that opens.</li><li>In Horta, click the gear menu in the &ldquo;WORKSPACE&rdquo; section. Choose &ldquo;Import SWC file as separate neurons&rdquo;.</li><li>Desktop users may choose any neuron on their hard disk at this point. HortaCloud users should again navigate to the &ldquo;Temporary Files&rdquo; area by using the drop-down menu called &ldquo;Look in&rdquo; at the top. Either way, choose a neuron SWC file and then click &ldquo;Open&rdquo;.</li><li>The &ldquo;Background Tasks&rdquo; window will again open, and the neuron will appear in the neurons list, and in the 2D or 3D views, if you have them open.</li></ol><p>Once the neuron has loaded, it will be visible in the 3D view, the 2D view (if it&rsquo;s open), and the neuron list. If you select the test neuron in the neuron list, you&rsquo;ll see a large number of branch points and endpoints in the annotation list.</p><a href=../images-import-export/test-neuron-import.png><img src=../images-import-export/test-neuron-import.png class="rounded mx-auto" style=max-width:1200px alt="imported test neuron"></a><h3 id=bulk-importexport>Bulk import/export</h3><p>See the &ldquo;Basic Operations&rdquo; section for more information on exporting multiple neurons at once, and on importing multiple neurons either interactive or in a offline batch process.</p><h2 id=whats-next>What&rsquo;s next</h2><p>After finishing these tutorials, you may want to read the &ldquo;Basic Operations&rdquo; section of the User Manual. This section will cover much of the same material discussed in these tutorials, with a few more details and a few more operations described. The &ldquo;Features&rdquo; section lists many less-commonly used tools. The &ldquo;Reference&rdquo; section contains details on, for example, file formats. Typically users will rarely need to consult that section.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0c1d4d2c71a58e9bda291973835f8abd>2.4 - Basic Operations</h1><div class=lead>Description of some basic operations: how to navigate images, how to trace neurons in 2D and 3D, and how to import and export neuron data</div><p>This section will walk you through the process of tracing a neuron and some other tasks. It&rsquo;s meant to introduce you to the basic operations of Horta. Not all features or details of features are discussed. You can find those details in the appropriate <a href=https://hortacloud.janelia.org/docs/user_manual/features/>Feature</a> section.</p><h2 id=assumptions>Assumptions</h2><p>Before you get started with Horta, it is assumed:</p><ul><li>The data is available in the proper format.</li><li>If a sample hasn&rsquo;t been created, you know the file path to the data.</li><li>(HortaCloud) You have a HortaCloud username and password.</li><li>(desktop) The Janelia Workstation is installed, you have a username and password, and you have logged in after launching the workstation. You have set the memory used by the workstation to a large number, preferably 40G or more.</li><li>You&rsquo;ve read the <a href=https://hortacloud.janelia.org/docs/user_manual/concepts/>Concepts</a> section of this documentation.</li></ul><p>You should contact whomever prepared your data if you don&rsquo;t know the answers to the above questions.</p><h2 id=data-explorer-and-data-inspector>Data Explorer and Data Inspector</h2><p>When Horta is launched (either version), you will see the Data Explorer and Data Inspector at the left edge of the application window.</p><p>The Data Explorer panel lists all of the objects in the workstation that the user has permission to view. These objects include both samples and workspaces as well as folders used to organize them.</p><p>Single-clicking on an object in the Explorer will populate the Data Inspector with more details about the object. The <code>Attributes</code> tab shows object metadata. <code>Permissions</code> shows current access permission and, via the &ldquo;Grant permission&rdquo; button at the bottom, allows the user to share read or write (edit) permissions for the selected object. The <code>Annotations</code> tab is only used in the desktop application for datatypes not available in HortaCloud.</p><p>Right-clicking on an object brings up a menu of actions. Most are self-explanatory; others will be described later in this section or in one of the reference sections.</p><h2 id=basic-annotation>Basic annotation</h2><p>The most basic workflow for neuron tracing is this:</p><ul><li>Create a sample</li><li>Create a workspace</li><li>Create a neuron</li><li>Add points to the neuron</li><li>When done, export the neuron</li></ul><p>Those tasks, and others, are detailed below.</p><h2 id=creating-a-sample>Creating a sample</h2><p>A sample is the representation of a dataset in the workstation. This only needs to be created once per dataset and can be shared among all users who are annotating that dataset. You need to create a sample in order to view data.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud</h4>In HortaCloud, samples are usually already created automatically by the system.</div><ul><li>File menu > New > Horta Sample</li><li>In &ldquo;Sample Name&rdquo;, enter a name for the sample</li><li>In &ldquo;Path To Render Folder&rdquo;, enter the path that the image server will use to locate the images. This should be a Linux-style path.<ul><li>(HortaCloud) The sample path will refer to a S3 bucket.</li></ul></li><li>Click &ldquo;Add Sample&rdquo;.</li><li>The sample will appear in your &ldquo;3D Tile Microscope Samples&rdquo; in your home folder. You may need to refresh the Data Explorer to see it.</li><li>(optional) Share the data with other users or groups.</li></ul><p>Once it&rsquo;s been created, you may perform any operations on the sample that you can do with any other object in the workstation. For example, you may move, rename, or remove it. See the main workstation documentation for details.</p><h3 id=relocating-a-sample>Relocating a sample</h3><p>If, for any reason, the images for a sample change location or change name, you can update the path stored in the sample without recreating it. Right-click on the sample and choose &ldquo;Edit sample path&rdquo;.</p><h2 id=viewing-and-navigation>Viewing and navigation</h2><h3 id=opening-a-sample>Opening a sample</h3><ul><li>In the Data Explorer, browse to the sample.</li><li>Right-click the sample and choose &ldquo;Open in Horta&rdquo;.</li><li>This option loads both samples and workspaces.</li><li>The sample will open the Horta Control Center, which is typically docked at the right-hand side of the main window. When you open a sample (rather than a workspace), very little information will appear in the Horta Control Center.</li><li>To view the images in the sample, click the checkbox next to &ldquo;Open 2D&rdquo; or &ldquo;Open 3D&rdquo; in the &ldquo;VIEWS&rdquo; section of the Horta Control Center (see screenshot below).</li><li>The viewer (2D or 3D) will open in the center panel. Depending on the data volume, network speed, and disk speed, the data may take anywhere from a few seconds to a few minute to open. The status bar at the bottom of the application will indicate some of the loading steps.</li><li>The 2D and 3D viewers each have their own tab, and you can switch between them freely.</li></ul><a href=../workspace-panel-1.png><img src=../workspace-panel-1.png class="rounded mx-auto" style=max-width:450px alt="workspace panel screenshot"></a><p>After you&rsquo;ve created a workspace (see below), use the same procedure to open the workspace.</p><h3 id=viewing-and-navigating-in-the-horta-2d-viewer>Viewing and navigating in the Horta 2D viewer</h3><p>Horta 2D displays the 3D data as a series of 2D planar images. It provides the usual suite of tools for viewing and navigating through the data. When zoomed out, a lower-resolution view of the data is displayed. When zoomed in, higher resolution images are loaded. Annotations are displayed when they are near the plane that is currently being displayed.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud 2D data</h4>In HortaCloud, usually only the lowest resolution of the 2D data is available. When a sample or workspace is loaded, a single image of the whole data set will be displayed at the lowest zoom level. If you zoom in, the image will become blurry.</div><a href=../LVV-toolbar.png><img src=../LVV-toolbar.png class="rounded mx-auto" style=max-width:296px alt="image toolbar"></a><p>The toolbar at the top of Horta 2D (screenshot above) indicates the current mouse mode. Usually it&rsquo;s the &ldquo;pen mode&rdquo; shown above, which is used for normal annotation. Hover the mouse cursor above each mode to get a description of what they do. This section assumes you are in &ldquo;pen mode&rdquo;. Holding down &ldquo;option&rdquo; will change to &ldquo;hand mode&rdquo; while the key is held down. This mode is useful for navigation.</p><ul><li>To pan the image, hold down option so hand mode is active, then left click and drag the image. Alternately, double-click the image in either mode to recenter at the selected point.</li><li>To zoom the image, do any of: hold down shift and use the mouse scroll wheel, drag the slider to the right of the image, click &ldquo;Zoom Min&rdquo; or &ldquo;Zoom Max&rdquo;, or (when zoom mode is selected from the toolbar) left-click to drag the area to zoom to.</li><li>To change planes, do any of: drag the slider under the image, click the arrows in the plane number indicator under the image, or scroll the mouse wheel when it is in plane change mode. Note that when you are zoomed out, each click of the mouse wheel will traverse more than one plane.<ul><li>Note that holding down the shift key will put the mouse scroll wheel into zoom mode, and releasing the shift key will place the mouse scroll wheel into plane change mode, regardless of the mode the mouse scroll wheel was in when the shift key was depressed.</li></ul></li><li>The &ldquo;Reset View&rdquo; button will recenter the image in x, y, and z and zoom out.</li><li>In the Horta Control Center, the &ldquo;Go to location&mldr;&rdquo; button allows you to enter an x, y or x, y, z location, and the view will move to center itself at that point. If you don&rsquo;t enter z, the plane doesn&rsquo;t change. Commas are optional. Square brackets around the coordinates are ignored.</li></ul><h3 id=adjusting-colors-in-horta-2d>Adjusting colors in Horta 2D</h3><p>Controls for adjusting the color of each channel in the image appear below the image, below the plane slider.</p><p>Each channel can be shown or hidden (eye icon at far left), and its color can be change (color patch at far right, which will open a color choice dialog).</p><p>The three handles on each slider control the range of color mapped to the range of data. The three locks below the sliders will force each of those values to remain in sync across all channel individually.</p><p>At the right of each color slider is a button labeled with the number sign <code>#</code>. If you click this button, three text boxes will open up showing the value of the corresponding Min/Mid/Max color slider values. In addition, the calculated gamma is shown. You may type new values into these boxes or use the small up/down arrows if you&rsquo;d like finer control over them. Note that if you type values into the text boxes, the values will become active if you press return/enter, press tab to move to another field, or click the &ldquo;Set&rdquo; button at right.</p><p><strong>Note:</strong> While it&rsquo;s impossible to drag the color sliders past each other, it <em>is</em> possible to type values into the text boxes that don&rsquo;t make sense. Sometimes the slider controls will end up on top of each other. In this case, drag the sliders you <em>can</em> access to a new value. The text values will synchronize and update, and you can then enter values that make sense.</p><p>At the bottom of the panel to the right of the 2D view area are two color-related buttons. The &ldquo;Auto Contrast&rdquo; button attempts to find a reasonable range of colors based on a simple histogram of the data. This almost never does a good job. The &ldquo;Reset Colors&rdquo; button returns the displayed color of each channel to its default value (ie, sliders at maximum, etc.). This is also rarely useful.</p><p>Note that the current colors, contrast settings, channel visibility and locks are not saved automatically! You must manually save changes by clicking on the gear menu and choosing &ldquo;Save Color Model To Workspace&rdquo; or &ldquo;Save Color Model As User Preference&rdquo;. As the desired settings usually depend on the characteristics of the individual sample, usually you will want to save the color model to the workspace, after which it will be automatically loaded when the workspace is opened. However, if you find there is a baseline color model you&rsquo;d prefer over the default (sliders set to min/middle/max), you may save to your preferences as a personal default.</p><p>On the same menu are options for saving or loading the color to/from disk.</p><h3 id=viewing-and-navigating-in-horta-3d>Viewing and navigating in Horta 3D</h3><p>The Horta 3D viewer is opened by clicking the checkbox next to &ldquo;Open 3D&rdquo; from within the Horta Control Center. At low zoom, lower resolution images are displayed. When zoomed in, higher resolution images are loaded. Annotations are displayed at all zoom levels.</p><p>To move around the volume:</p><ul><li>Single-left click anywhere (including on an annotation): center the volume on that point. Note that if you click on an annotation or near signal, Horta will find the depth in z of the point and center on it correctly. This allows you to follow a neuron by clicking along its length with minimal depth changing.</li><li>Left-click and drag: move the viewpoint in the view plane.</li><li>Middle-click and drag: rotate the volume</li><li>Scroll wheel: change the zoom level</li><li>Right-click anywhere and choose &ldquo;Reset Horta rotation&rdquo; if you would like to return to the original image orientation.</li><li>In the Horta Control Center panel, the &ldquo;Go to location&mldr;&rdquo; button in the &ldquo;VIEWS&rdquo; section allows you to enter an x, y or x, y, z location, and the view will move to center itself at that point. If you don&rsquo;t enter z, the plane doesn&rsquo;t change. Commas are optional. Square brackets around the coordinates are ignored.</li></ul><h3 id=horta-2d-and-horta-3d-view-synchronization>Horta 2D and Horta 3D view synchronization</h3><p>If both viewers are open, you may synchronize the views by right-clicking on a point in either viewer and choosing &ldquo;Synchronize Views at This Location&rdquo;. This command moves the point to the center of the screen in each view. The zoom level is not changed.</p><h3 id=adjusting-colors-in-horta-3d>Adjusting colors in Horta 3D</h3><p>Adjusting colors and the general appearance of the data in Horta 3D can be challenging. Horta 3D has been tested and used with one or two data channels. The mixing feature especially may not work with more channels.</p><h4 id=basic-settings>Basic settings</h4><p>To make basic color adjustments in Horta 3D, Windows menu > Horta > Color sliders. In the window that appears, you can adjust color sliders as you would for the Horta 2D. Usually you will want to hide the third channel in this case.</p><h4 id=unmixing>Unmixing</h4><p>Often the two data channels are used to display a desired signal in one channel and a reference in the other channel. However, fluorescence from the reference channel can also appear in the signal channel. Subtracting it out can make the signal substantially more distinct. To make use of this feature:</p><ul><li>Adjust the signal and reference channels independently (see note below) with the third channel hidden (click the eye to the right of the third slider)</li><li>Right-click and choose Tracing channel > Unmix channel 1 using current brightness (or 2, depending on which channel is which)</li><li>Hide the first two channels and unhide the third</li><li>Adjust the third channel&rsquo;s contrast and brightness</li></ul><p>Note: finding good contrast/brightness settings for the first two channels so the unmixing works well is quite difficult! In general, you should set the channel color slider for the signal channel so the brightest part of the signal (usually the soma) is oversaturated and work from there.</p><p>Color model settings are saved as in 2D (see <a href=#adjusting-colors-in-horta-2d>Adjusting colors in Horta 2D</a> above). Note that this saves a wider array of setting than for Horta 2D, including rendering options!</p><h3 id=navigating-to-neurons-or-annotations>Navigating to neurons or annotations</h3><p>Once you&rsquo;ve begun annotation, you can easily navigate to neurons or their constituent annotations (see below for how to annotate).</p><p><strong>Neurons</strong>: If you double-click on a neuron name in the neuron list, the view will center on the center of the neuron&rsquo;s bounding box. Note that if a neuron spans a lot of area and you are zoomed in, you may not see any of the actual neuron!</p><p><strong>Annotations</strong>: If you double-click on an annotation in the annotation list, the view will center on the annotation.</p><h2 id=basic-tracing-and-editing>Basic tracing and editing</h2><p>Annotations are stored in workspaces. A workspace is associated with a sample, which contains the images. You must create a workspace before annotating. Multiple workspaces may be associated with the same sample. For example, multiple people may trace the same neuron independently as a quality control check. Alternatively, a single workspace may be shared among multiple users, usually tracing different neurons simultaneously.</p><p>In general, only one tracer should be working on any given neuron at the same time, to prevent one tracer&rsquo;s work from being overwritten by another&rsquo;s. Horta attempts to prevent this from happening, but it is possible.</p><p><strong>Note</strong> Most editing and tracing tools are containing in the Horta Control Center panel at right. If you&rsquo;re working on a small display, you may need to use the panel&rsquo;s scroll bar to make some of the lower tools visible.</p><h3 id=creating-a-workspace>Creating a workspace</h3><a href=../workspace-panel-2.png><img src=../workspace-panel-2.png class="rounded mx-auto" style=max-width:450px alt="workspace panel screenshot"></a><p>To create a workspace:</p><ul><li>Open a sample from the Data Explorer; it will appear in the Horta Control Center.</li><li>In the &ldquo;WORKSPACE&rdquo; section at the top of the editor panel at right (see screenshot above), click the &ldquo;+&rdquo; button.</li><li>Fill in the desired name for the workspace. By default, it has a structured name based on the date and other data. You may optionally click &ldquo;Manual override&rdquo; to name the workspace whatever you would like.<ul><li>(Note that &ldquo;Assign neurons&rdquo; has no effect for this method of creating a workspace.)</li></ul></li><li>The workspace will be created, and it will automatically immediately load in the Horta Control Center. The workspace name and sample name will appear in the &ldquo;WORKSPACE&rdquo; section. The workspace will also appear in the Data Explorer under &ldquo;Workspaces&rdquo; in your home directory (you may need to refresh the explorer).</li><li>Once the workspace has been created, you can open it again just like you&rsquo;d open a sample, by right-clicking the workspace in the Data Explorer and choosing &ldquo;Open in Horta&rdquo;.</li></ul><h3 id=operations-on-workspaces>Operations on workspaces</h3><p>You can perform a number of operations on the workspace. Some of these operations are common to all data in the workstation; these operations can be performed from the Data Explorer, typically by right-clicking on the workspace. These operations include moving, sharing, renaming, deleting the workspace.</p><p>Other operations are specific to Horta. These operations can be accessed by clicking the gear icon in the Horta Control Center, in the &ldquo;WORKSPACE&rdquo; section. Most of these will be discussed in other sections.</p><p><strong>Save as</strong>: If you need to make a copy of the workstation and all the annotations within it, choose &ldquo;Save as&mldr;&rdquo; from the workspace gear menu. You will be prompted for a new name just as if you were creating the workspace from scratch.</p><h3 id=creating-or-deleting-a-neuron>Creating or deleting a neuron</h3><p>Annotations are contained within neurons. Typically a neuron in Horta represents one biological neuron. Usually its root annotation is placed on the neuron&rsquo;s soma. Neurons may contain more than one annotation tree, however. For example, it can be convenient to trace large arbors individually and link them later. Neuron controls and the neuron list are located in the &ldquo;NEURONS&rdquo; section of the Horta Control Center (screenshot below).</p><a href=../neuron-panel.png><img src=../neuron-panel.png class="rounded mx-auto" style=max-width:450px alt="neuron panel screenshot"></a><p>To create a neuron:</p><ul><li>Open a workspace.</li><li>Click the &ldquo;Add&mldr;&rdquo; button below the neuron list.</li><li>Type in a name for the neuron and click &ldquo;OK&rdquo;.</li><li>The new neuron will appear in the neuron list, selected.</li></ul><p>To delete a neuron, select a neuron in the list, then click the &ldquo;Remove&rdquo; button below the neuron list. You will be shown a dialog box to confirm your decision.</p><h3 id=annotating-in-horta-2d>Annotating in Horta 2D</h3><p>To add points to a neuron in the Horta 2D viewer:</p><ul><li>Open a workspace.<ul><li>Create a neuron if one does not exist.</li></ul></li><li>In the neuron list, select a neuron by clicking on it.</li><li>Be sure you have the pen tool selected in the toolbar; this is the default, and it is rarely changed.</li><li>If there are no points in the neuron:<ul><li>Shift-left-click a location to place a point at that location.</li></ul></li><li>If there are already points in the neuron:<ul><li>Select the parent annotation you want to add a child to by clicking on it. The annotation will then be drawn with a &ldquo;P&rdquo; on it.</li></ul></li><li>Navigate to the location of the next annotation, possibly changing planes as you do.</li><li>Shift-click the location where the annotation should be placed.</li><li>A new point will be added, connected to its parent, and the new point will become the parent annotation for the next annotation added. In Horta 2D, this point is marked with a &ldquo;P&rdquo;.</li><li>The view will re-center on the new point.</li><li>Continue adding points by shift-clicking</li></ul><h3 id=annotating-in-horta-3d>Annotating in Horta 3D</h3><p>Adding points to neurons in the Horta 3D viewer is somewhat different than in the Horta 2D viewer because of the third dimension. In Horta 2D, when you add a point, it is added at the z-coordinate of the plane you are viewing. In Horta 3D, though, you are looking at a three-dimensional representation of the data, so a mouse-click might correspond to a number of locations in the data corresponding to various depths into the screen.</p><p><strong>Snap to signal</strong>: However, Horta 3D provides the user with assistance in placing annotations on signal. When you move the mouse cursor in Horta 3D, if it nears a bright signal (hopefully a labelled neuron and not background noise), the mouse cursor will change to a ball with a &ldquo;+&rdquo; sign, and it will jump to the center of the brightness automatically. If you shift-click to place a point, that point will be placed in three dimensional space on top of the brightest part of the data. In this way, you can annotate correctly in three dimensions without having to determine the exact depth of the signal manually.</p><p>Note that the &ldquo;snap to signal&rdquo; feature depends on which image channel has signal, and is therefore channel-dependent! Right-click and choose &ldquo;Tracing channel&rdquo; to determine whether signal is sought in the raw channels or a combination of multiple channels (average or unmixing; see above for unmixing details).</p><p>The complete procedure is then:</p><ul><li>Open a workspace.<ul><li>Create a neuron if one does not exist.</li></ul></li><li>Open the Horta 3D viewer</li><li>In the Horta Control Center, in the neuron list, select a neuron by clicking on it.</li><li>If there are no points in the neuron:<ul><li>Shift-left-click a location to place a point at that location in the LVV.</li><li>(need to replace this with horta 3D version!)</li></ul></li><li>Navigate to the location you want to annotate in Horta 3D.</li><li>Select the parent annotation you want to add a child to by clicking on it. The annotation will then be drawn with a &ldquo;P&rdquo; on it.</li><li>Navigate to the location of the next annotation, possibly rotating as you do. Move the mouse cursor to the location. A ball cursor with a &ldquo;+&rdquo; sign should appear.</li><li>Shift-click the location. Note that if there is no bright signal, the &ldquo;+&rdquo; cursor will not appear, and you will not be able to place an annotation!</li><li>A new point will be added, connected to its parent, and the new point will become the parent annotation for the next annotation added. This point is marked with a ball with a &ldquo;P&rdquo; on it.</li><li>The view will re-center on the new point.</li><li>Continue adding points by shift-clicking</li></ul><h3 id=editing-neurons>Editing neurons</h3><p>Horta contains several useful tools for manipulating neurons and annotations. Most of these operations are performed by right-clicking an annotation and choosing from the pop-up menu in one of the viewers. Some of the more commonly used actions are:</p><p>Mouse & keyboard actions:</p><ul><li><strong>Set next parent</strong>: left-click an selected annotation to set it to be the parent for the next added annotation</li><li><strong>Move annotation</strong>: to move an annotation, left-click and drag it to a new location</li><li><strong>Merge neurites</strong>: to merge one fragment with another, left-click and drag an annotation on top of another annotation; after a confirming dialog, the two neurites will be linked together between those two annotations<ul><li>The first neurite, with the dragged annotation, becomes a branch of the second annotation</li><li><strong>Note!</strong> The tolerance for this operation is quite small! This is best done zoomed quite far in.</li></ul></li><li><strong>Delete annotation</strong>: to delete the &ldquo;next parent&rdquo; annotation, press the delete key; this acts like the &ldquo;Delete link&rdquo; function, below; if no annotation is deleted, nothing happens</li></ul><p>Right-click menu actions (as named on the menu):</p><ul><li><strong>Delete link</strong>: deletes the clicked annotation; connects the annotation&rsquo;s parent and child; can&rsquo;t be used on branch points</li><li><strong>Delete subtree rooted at this anchor</strong>: deletes the clicked annotation and all annotations below it in the tree</li><li><strong>Split anchor</strong>: add a new annotation located between the clicked annotation and its parent; this annotation can then be dragged to a new location; this is used to annotate more densely after the fact</li><li><strong>Split neurite</strong>: break the neurite (neuron fragment) apart by removing the link between the clicked annotation and its parent; the clicked annotation becomes a root annotation</li></ul><h3 id=changing-neuron-appearance>Changing neuron appearance</h3><p><strong>Color</strong>: You can change the color of each neuron&rsquo;s annotations by clicking on the colored square in the neuron list (&ldquo;C&rdquo; column), by right-clicking the neuron in the neuron list and choosing &ldquo;Change neuron color&mldr;&rdquo;, or by right-clicking on one of its annotations and choosing &ldquo;Change neuron color&mldr;&rdquo;. In either case, you&rsquo;ll be presented with a dialog box that lets you choose the neuron color. If you choose &ldquo;Change neuron color&mldr;&rdquo; from the gear menu under the neuron list, you will change the color of all neurons currently visible in the neuron list.</p><p><strong>Visibility</strong>: It&rsquo;s often useful to hide some or most neurons from view. There are a variety of controls for accomplishing that.</p><p><em>Temporary</em>: To temporarily hide all neurons, hold down the &ldquo;v&rdquo; key. This function is useful for viewing the data under a neuron, often as it&rsquo;s being annotated.</p><p><em>Persistent</em>: Neurons can be toggled between visible and invisible (shown or hidden) for the duration of the annotation session (until the workspace is reloaded). There are multiple ways to do this:</p><ul><li>Right-click on an annotation and choose &ldquo;Hide neuron&rdquo;.</li><li>Click the eye icon in the &ldquo;V&rdquo; column in the neuron list; this column also indicates the current visibility of each neuron (open or closed eye).</li><li>Right-click the neuron name in the neuron list and choose one of the hide/show neurons options (show all, hide all, or hide all except the clicked neuron).</li><li>On the gear menu below the neuron list, choose one of the hide/show neurons options (show all, hide all, or hide all except the currently selected neuron). This will apply to all neurons currently displayed in the list</li></ul><p><strong>Note:</strong> The difference between the hide/show options on the right-click menu on each neuron in the neuron list, and the gear menu below the neuron list, can be subtle. The right-click options operate on all neurons, regardless of any text filters. &ldquo;Hide others&rdquo; and &ldquo;Show others&rdquo; act globally on all neurons.</p><p>The gear menu options work only on the neurons showing in the list. If there is no text filter active, that means all neurons. So &ldquo;Hide&rdquo; and &ldquo;Show&rdquo; work on all neurons, but &ldquo;Hide others&rdquo; and &ldquo;Show others&rdquo; do nothing, because there are no &ldquo;other&rdquo; neurons that are not visible in the neuron list (ie, there are no neurons that are filtered out).</p><p>When a text filter is active, though, the behavior of the gear menu commands only affects the neurons on the list, or acts relative to the neurons on the list. The &ldquo;Show neurons&rdquo; and &ldquo;Hide neurons&rdquo; options will only toggle visibility for neurons showing on the list, and likewise the &ldquo;Show others&rdquo; and &ldquo;Hide others&rdquo; operations only affect neurons not on the list (ie, the neurons that are filtered out).</p><h3 id=filtering-neurons>Filtering neurons</h3><p>The neuron list usually displays all neurons in the workspace, but its contents can be filtered to a subset of neurons, which is especially useful when the list is long.</p><ul><li><strong>Text filter</strong>: As you type characters into the box (2-3 or more), the list will update to show only neurons whose names contain the entered text somewhere in the name. Java regular expressions can be used.</li><li><strong>Ignore prefix</strong>: As you type characters into the box, the list will update to show only neurons whose names do not begin with the entered text. Again, regular expressions can be used.</li><li><strong>Tag filter</strong>: Neurons can be included or excluded from the displayed list based on their tags. See the &ldquo;Tags&rdquo; section in <a href=https://hortacloud.janelia.org/docs/user_manual/features/>Horta Features</a>.</li><li><strong>Spatial filter</strong>: When there are a large number of neurons (hundreds or more), perhaps computationally generated, performance can suffer if all of them are visible. Neurons can be filtered by spatial proximity to a neuron of interest. See the &ldquo;Spatial Filtering&rdquo; section in <a href=https://hortacloud.janelia.org/docs/user_manual/features/>Horta Features</a>.</li></ul><p>Note that any actions triggered from the gear menu below the neuron list will only act on neurons that are currently visible in the list! In this way, you can, for example, easily change colors or visibility of a specific subset of neurons.</p><p>The sort order of the neurons can be changed by choosing &ldquo;Sort&rdquo; from the neuron gear menu.</p><h3 id=filtering-annotations>Filtering annotations</h3><p>The &ldquo;ANNOTATIONS&rdquo; section is located below the &ldquo;NEURONS&rdquo; section in the right-hand panel. By default, the list displays annotations that are &ldquo;interesting&rdquo;: roots, branch points, end points, and any annotation with notes (see below). Note that the &ldquo;geo&rdquo; column is meant to suggest the neuron&rsquo;s geometry (see below). They are ordered by last update time (newest at the bottom). Only annotations from the currently selected neuron are shown.</p><table><thead><tr><th>symbol</th><th>geometry</th></tr></thead><tbody><tr><td><code>o--</code></td><td>root</td></tr><tr><td><code>---</code></td><td>link</td></tr><tr><td><code>--&lt;</code></td><td>branch</td></tr><tr><td><code>--o</code></td><td>end</td></tr></tbody></table><p><strong>Filter menu and buttons</strong>: The filter menu lets you switch between several pre-determined filters (with buttons provided to quickly switch to some of those filters without navigating the menu).</p><p>Note that some of these filters do not operate the way you&rsquo;d think! They are designed to assist tracers to locate specific classes of annotations in conjunction with the note system (see below) and one possible workflow.</p><table><thead><tr><th>filter</th><th>included annotations</th></tr></thead><tbody><tr><td>default</td><td>roots, branches, ends, annotations with a note</td></tr><tr><td>ends</td><td>endpoint that do not have a note &ldquo;traced end&rdquo; or &ldquo;problem end&rdquo; (ie, an endpoint that needs to be traced out = unfinished endpoint)</td></tr><tr><td>branches</td><td>has &ldquo;branch&rdquo; note (ie, manually marked as a place that should be a branch point)</td></tr><tr><td>roots</td><td>is a root node</td></tr><tr><td>notes</td><td>has any note</td></tr><tr><td>geometry</td><td>roots, branches, ends</td></tr><tr><td>interesting</td><td>has &ldquo;interesting&rdquo; note</td></tr><tr><td>review</td><td>has &ldquo;review&rdquo; note</td></tr></tbody></table><p><strong>Filter text</strong>: As you type characters into the box, the list will update to only show annotations whose note contains the entered text somewhere in the note. Regular expressions may be used. Note that this filter also operates on the &ldquo;geometry&rdquo; column! For example, if you type <code>o–-</code> in the text filter, you will only see root annotations. This can also be done via the menu (above), but it may be useful in some cases.</p><h3 id=adding-notes-text-annotations>Adding notes (text annotations)</h3><p>Arbitrary text notes may be added to any annotation. To bring up the dialog box for adding, editing, or deleting notes: right-click on the annotation and choose &ldquo;Add, edit, or delete note&mldr;&rdquo;, double-click on the &ldquo;note&rdquo; column in the annotation list corresponding to the annotation, or select the annotation and press the assigned keyboard shortcut. In the dialog that pops up, you may enter any text you like. You may also edit or delete the note from this dialog.</p><p><strong>Predefined notes</strong>: There are a set of buttons that insert predefined notes (such as &ldquo;branch&rdquo;, &ldquo;interesting&rdquo;, and &ldquo;review&rdquo;). The predefined notes interact in important ways with the annotation filters. The details are described in the &ldquo;Notes&rdquo; section of Horta Features.</p><p>Notes are imported and exported along with the neurons (see below).</p><h3 id=changing-neuron-ownership>Changing neuron ownership</h3><p>There are two kinds of ownership in Horta. First is the ownership that is managed by the Janelia workstation itself. The items that appear in the Data Explorer (workspaces and samples) are shared using the &ldquo;Permissions&rdquo; tab in the Data Inspector window. A tracer must have write access to the workspace before annotating. (This is usually only relevant when sharing workspaces. A tracer always has write access to workspaces they create.)</p><p>The ownership of individual neurons, by contrast, is managed within Horta itself. The &ldquo;O&rdquo; column of the neuron list displays an icon corresponding to the neuron&rsquo;s owner: an icon of a head for another user, an icon of a computer for a generic &ldquo;system&rdquo; group, and nothing (no icon) for the current user. In all cases, if you hover your mouse over the icon (or empty space without an icon), a tooltip will show the full name of the owner.</p><p>First of all, most operations are prohibited when a neuron is owned by another user or a group that the current user is not a member of. This includes adding or deleting points or notes. Changing color or visibility is allowed, however, and those changes will not be seen by others.</p><p>Second, if a neuron is owned by a group, then any member of that group may make any changes to that neuron. When they do, they will also become the owner of the neuron automatically.</p><p>You may change the owner of a neuron if you own it, you are a member of the group that owns it, or you are designated as an administrator of the group that owns the workspace.</p><p>To change the owner of a neuron, single-click in the &ldquo;O&rdquo; column corresponding to the neuron in the neuron list.</p><p>This will be an icon or an empty space. From the dialog box, choose a new owner (user or group) for the neuron. To change the owner for multiple neurons, filter the neuron list to the desired set of neurons, then choose &ldquo;Choose neuron owner&mldr;&rdquo; from the gear menu under the neuron list.</p><p>Admins in the system may change any neuron&rsquo;s owner at any time.</p><p>The gear menu in the &ldquo;WORKSPCE&rdquo; section contains the very dangerous &ldquo;Temp ownership admin&rdquo; checkbox which gives the user the ability to change neuron ownership as if they were an admin (but grants no other admin privileges). Use this sparingly! It&rsquo;s intended for use by a trusted and professional group to circumvent situations where a neuron owner is, eg, on vacation, and no admin is available to change it.</p><h2 id=exporting-data>Exporting data</h2><p>Horta use the SWC file format for importing and exporting neuron data. It&rsquo;s a multi-column text file that records the position and connectivity of the neurons and not much else. Note that an SWC file may contain more than one neuron or neuron fragment.</p><ul><li>To export all of the neurons in a workspace, choose &ldquo;Export SWC file&rdquo; from the gear menu in the &ldquo;WORKSPACE&rdquo; section.</li><li>To export one specific neuron, right-click on the neuron name in the neuron list and choose &ldquo;Export SWC file&mldr;&rdquo;.</li><li>To export all neurons in the neuron list (potentially filtered), from the gear menu in the &ldquo;NEURONS&rdquo; section, choose &ldquo;Export neurons&mldr;&rdquo;.</li></ul><p><strong>Output files</strong>: In all cases, you will be prompted to choose an output location for the exported neuron(s).</p><ul><li>If you are exporting one neuron, it will be saved in the chosen location.</li><li>If you are exporting more than one neuron, two versions of the data will be exported:<ul><li>A single SWC named for the workspace that contains all of the neurons.</li><li>A folder named for the workspace that contains one SWC file for each individual neuron.</li></ul></li></ul><p><strong>Options</strong>: When exporting neurons, there are two options on the right side of the location choosing dialog box:</p><ul><li><strong>Point density</strong>: This option can be ignored unless you are using automatically traced paths (described elsewhere). Click &ldquo;Help&rdquo; for more info.</li><li><strong>Export notes</strong>: When this option is checked, any notes (text annotations) on the neuron are also exported in a JSON file. The file has the same name as the SWC file but uses the .json file extension instead of .swc.</li></ul><p>See the <a href=https://hortacloud.janelia.org/docs/user_manual/reference/>Horta Reference</a> section for details on the SWC and note file formats.</p><h2 id=importing-data>Importing data</h2><p>SWC files may be imported into Horta either interactively or in the background. Because importing large numbers of neurons can be time-consuming, importing more than a dozen or so neurons should be done in the background if you want to use Horta while the files are imported.</p><h3 id=interactive>Interactive</h3><p>Because an SWC file may store one or more than one neuron per file, and in Horta, you may have multiple neuron fragments per neuron, there are two ways to handle the import. Both of these options are found on the gear menu in the &ldquo;WORKSPACE&rdquo; section.</p><ul><li><strong>Import SWC file as one neuron</strong>: This option reads all neurons in the SWC file(s), creates a single neuron, and places all neurons in the file in the newly created neuron (as what Horta calls neurites).</li><li><strong>Import SWC file as separate neurons</strong>: This option reads all neurons in the SWC file(s) and creates one neuron per root in the file(s).</li></ul><p><strong>Multiple files</strong>: In either case, you may choose either a single SWC file or a folder containing multiple SWC files. In the latter case, all SWC files in the folder are imported. Files in subfolders are not imported.</p><p><strong>Note</strong>: If the SWC file was exported from Horta and has an associated .json notes file, the notes will automatically be imported with the neurons.</p><h3 id=background>Background</h3><p>SWC files, especially large numbers of them, may be imported into a workspace that will be created for them in the background (on the server).</p><p>The SWC files to be imported must be collected in a folder that can be read by the workstation server.</p><ul><li>Right-click on the sample in the Data Explorer</li><li>Choose &ldquo;Import Linux SWC Folder into new Workspace on Sample&rdquo;</li><li>Give the new workspace a name in the first dialog box</li><li>(optional) Click the &ldquo;Assign Neurons&rdquo; box and provide a user or group that will be the owner of all the newly imported neurons</li><li>In the second dialog, enter the Linux file path to the folder containing the neurons.</li><li>(optional) There is a redundant check box to assign all neurons to the default common user group. In principle, this can be done from the previous dialog box as well.</li><li>After clicking OK, the import process will begin. It may show its progress in the &ldquo;Background Tasks&rdquo; tab.<ul><li>Do not attempt to load or use the workspace until the task completes!</li></ul></li></ul><p>Note that the import process will continue (on the server) even if you quit the workstation!</p><p>Important note: Unlike the interactive case, subfolders are recursively traversed, and all SWC files are imported!</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud imports and exports</h4><p>Because HortaCloud running via AppStream does not have direct access to the computer&rsquo;s hard drive, a two-step process must be used for importing and exporting SWC files and their associated JSON notes files. The process uses the &ldquo;My Files&rdquo; location in AppStream, which is a location for temporary files that last for the length of an AppStream session. If you click on the &ldquo;My Files&rdquo; folder icon on the top AppStream toolbar (screenshot below), a dialog box will open up. If you click on &ldquo;Temporary Files&rdquo;, it will open a folder where you can upload (via the button or by dragging) or download files (by clicking the downward-pointing arrow next to the filename). This &ldquo;Temporary Files&rdquo; location is visible from Horta, within any file dialog. So the process for importing SWC files is:</p><ul><li>Open &ldquo;My Files&rdquo;, then &ldquo;Temporary Files&rdquo;.</li><li>Upload SWCs by clicking &ldquo;Upload Files&rdquo; or by dragging.</li><li>In Horta, choose one of the SWC import options (see above), and navigate to &ldquo;Temporary Files&rdquo; in the file dialog.</li></ul><p>Export works the same way, in reverse: export to &ldquo;Temporary Files&rdquo;, then download from there.</p></div><a href=../AppStream-MyFiles.png><img src=../AppStream-MyFiles.png class="rounded mx-auto" style=max-width:318px alt="AppStream toolbar"></a></div><div class=td-content style=page-break-before:always><h1 id=pg-79b42b49477866bac32f7d6b422d54d7>2.5 - Features</h1><div class=lead>Horta features</div><p>This section discusses Horta features. It contains both details of basic operations that are covering in the <a href=https://hortacloud.janelia.org/docs/user_manual/basic_operations/>previous section</a> as well as descriptions of features that haven&rsquo;t yet been discussed.</p><h2 id=global>Global</h2><h3 id=preferencessettings>Preferences/settings</h3><p>There are a number of customization options for Horta.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>HortaCloud</h4>In HortaCloud, choose Tools > Options.</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Desktop</h4>If you&rsquo;re running Windows, choose Tools > Options if you&rsquo;re running Windows. On a Mac, the settings are called &ldquo;Preferences&rdquo; and are in the traditional place under the application menu at top right.</div><p>Here are some settings of interest:</p><ul><li><code>Core > Application</code>:<ul><li>Max Memory (desktop): This should be set to a high number, preferably 40G or more.</li><li>Max Memory (HortaCloud): This should be left blank; the system will set the memory correctly.</li></ul></li><li><code>Horta > Application</code>:<ul><li>&ldquo;Use http for file access&rdquo;: Must be left checked.</li><li>&ldquo;Load last opened sample&mldr;&rdquo;: This option is not currently working.</li><li>&ldquo;Verify neurons on load&rdquo; is never needed under normal circumstances. It can be enabled to check for some internal inconsistencies in neurons stored in the database.</li><li>&ldquo;Use anchors-in-viewport&rdquo; should be left enabled. This is a graphics optimization.</li><li>See below for &ldquo;Click mode for adding annotations&rdquo;</li><li>&ldquo;Z-slice thickness&rdquo;: The 2D view shown in Horta 2D actually shows annotations from multiple planes. This setting determines the depth of this effect. If you increase the number, annotations become visible on a large number of surrounding planes. Note however that there are some subtle behaviors in how the data and annotations are rendered, and changing this value dramatically away from its default value may not have the effect you want.</li></ul></li><li><code>Horta > Tile Loading</code>:<ul><li>In general, you can leave &ldquo;Concurrent tile loads&rdquo; and &ldquo;Number of tiles to cache&rdquo; to their defaults. Larger numbers <em>may</em> improve tile loading in Horta 3D.</li><li>See below for &ldquo;Click mode for adding annotations&rdquo;</li></ul></li><li><code>Keymap</code>:<ul><li>This section shows all of the user-changeable keyboard shortcuts for the Janelia workstation, including Horta. The shortcuts are listed by section.</li><li>New shortcuts will take effect after the application is restarted.</li><li>Note that some keyboard shortcuts in Horta cannot be changed from this dialog. Unfortunately, there is no central list of what they are.</li></ul></li></ul><h4 id=click-mode-for-adding-annotations>Click mode for adding annotations</h4><p>By default, to add annotations in Horta 2D and 3D, you select a parent annotation, then you shift-left-click on the desired location. For some people, holding down the shift key while making repeated annotations may cause stress on their hands, fingers, or wrists when done over a long period of time. For that reason, an option is provided to change that gesture to a simple left-click to add annotation (with no shift key). Note that this is set independently for Horta 2D and Horta 3D. The two settings are in different subpanels for historical reasons.</p><p>Note that if the &ldquo;left-click&rdquo; option is selected, some other behaviors in the two viewers will change, specifically those involving left-clicks. Most notably, in Horta 2D, idle clicks when (for example) closing right-click menus will register as an annotation.</p><p>Generally speaking, using the default group names:</p><ul><li>all users should be a member of <code>workstation_users</code></li><li>all users who want to interact with Horta samples or annotations should be a member of <code>mouselight</code></li><li>all regular Horta tracers should <em>also</em> be a member of <code>mouselight_tracers</code>; this group is used to populate some dialog boxes regarding neuron ownership, and project leadership, collaborators, and other non-tracers need not be in this group (it&rsquo;ll clutter the menus)</li></ul><h3 id=user-and-group-administration>User and group administration</h3><p>If you are an administrator, you can Windows > Core > Administration tool to manage users and groups. Note that these are users and groups within the Horta or Janelia Workstation applications. For HortaCloud, there is a second layer of users and administrator for AppStream that are managed separately.</p><p>An administrator within the Horta or Janelia Workstation system has a lot of power.</p><ul><li>see all data and assign permissions for all data</li><li>set privileges for all users and groups</li><li>use Tools > Admin > Run as&mldr; to connect as any user (usually used for debugging purposes)</li></ul><p>You should limit the number of people with admin privileges.</p><h2 id=horta-control-center-features>Horta Control Center features</h2><h3 id=notes>Notes</h3><p>Notes are text annotations that are attached to point annotations. They can be added, edited, or deleted from a dialog box triggered by a right-click on the annotation and choosing &ldquo;Add, edit, delete note&rdquo;. The contents can be arbitrary.</p><p>However, the note dialog does provide several pre-defined notes that can be used to support a simple tracing workflow. In addition, some of those pre-defined notes have specific effects on other operations and on the annotation filters.</p><table><thead><tr><th>predefined note</th><th>intended use</th><th>behavior</th></tr></thead><tbody><tr><td>traced end</td><td>to be added when the signal at that point has been traced as far as it can; it&rsquo;s a &ldquo;done&rdquo; marker</td><td><ul><li>must be placed on an endpoint</li><li>if another point is placed as a child, it&rsquo;s automatically removed</li><li>does not appear in the &ldquo;ends&rdquo; filter</li></ul></td></tr><tr><td>branch</td><td>to be added when the tracer finds a point where signal branches but doesn&rsquo;t want to follow the branch at that time; it&rsquo;s a &ldquo;come back to this&rdquo; marker</td><td><ul><li>cannot be placed on an existing branch</li><li>if another point is placed to make it an actual branch, it&rsquo;s automatically removed</li><li>does not appear in the &ldquo;branches&rdquo; filter</li></ul></td></tr><tr><td>interesting</td><td>indicates a point of interest</td><td>no special behavior</td></tr><tr><td>review</td><td>indicates a point that needs review by a second set of eyes, supervisor, or expert</td><td>no special behavior</td></tr><tr><td>problem end</td><td>indicates an endpoint that may or may not be able to be traced further by the current user; it&rsquo;s a &ldquo;done (but problematic)&rdquo; marker</td><td><ul><li>must be placed on an endpoint</li><li>if another point is placed as a child, it&rsquo;s automatically removed</li><li>does not appear in the &ldquo;ends&rdquo; filter</li></ul></td></tr><tr><td>(arbitrary text)</td><td>the user may place arbitrary text at any point</td><td>no special behavior</td></tr></tbody></table><h4 id=simple-workflow-with-notes-and-filters>Simple workflow with notes and filters</h4><p>All together, the notes and filters together were designed to support the following workflow:</p><ul><li>start tracing at a soma or a segment of interest</li><li>add point along the segment</li><li>at a branching point in the signal, add the &ldquo;branch&rdquo; note to the annotation to mark it as a point to be revisited; there is then no need to place a single point on the second branch to find it later</li><li>when a branch ends in a synapse or becomes too faint to trace, place a &ldquo;traced end&rdquo; or &ldquo;problem end&rdquo; note, indicating that the tracing is complete for this branch</li><li>if those notes are added consistently, then the &ldquo;branches&rdquo; and &ldquo;ends&rdquo; filters will identify those locations that need further work</li><li>when those two filters have no annotations in them, the neuron is done</li></ul><h3 id=tags>Tags</h3><p>Tags are user-defined, usually short, labels that are applied to neurons.</p><ul><li>To add or remove tags from a single neuron, right-click on the neuron in either the Horta 2D view or the neuron list and choose &ldquo;Edit neuron tags&rdquo;.<ul><li>The left &ldquo;Applied&rdquo; column contains tags that have already been applied to the neuron. Click on a tag in this column to removed it.</li><li>The right &ldquo;Available&rdquo; column contains existing tags that can be applied to the neuron by clicking on them.</li><li>To define a new tag, type the tag in the box below the &ldquo;Available&rdquo; column and click &ldquo;New tag&rdquo;. It will be created and applied immediately.</li><li>The list of &ldquo;available&rdquo; tags is the list of tags that exist on any neuron, plus two special tags.</li><li>The &ldquo;auto&rdquo; tag may be used freely. It is suggested to use this tag to mark neurons that were created by some automated process, to distinguish them from human-created neurons. When automatically created neurons are numerous, this can be used to filter them out (See &ldquo;Spatial filter&rdquo;).</li><li>The &ldquo;hidden&rdquo; tag is used internally and shouldn&rsquo;t be used.</li></ul></li><li>To add or remove a tag from multiple neurons, choose &ldquo;Edit tags&rdquo; from the gear menu in the neuron list. The tag will be added or removed from all the neurons in the filtered list, if applicable.</li><li>Tags can be used to filter the neuron list by either including or excluding neurons with a single tag.</li></ul><p>Tags can be used to control a few useful toggle behaviors. This feature is called &ldquo;Neuron group properties&rdquo;.</p><ul><li>First, add a tag to one or more neurons of interest using one of the above methods.</li><li>Right-click on a neuron and choose &ldquo;Edit neuron group properties&rdquo;.</li><li>The dialog box shows each user-applied tag as a &ldquo;Neuron group&rdquo; and indicates how many neurons are in the group.</li><li>Click on the cell in the third column of a row corresponding to a tag to assign a hotkey for the toggle.</li><li>Click on the fourth column to assign a toggleable property.</li><li>Click save. Now when keyboard focus is in Horta 2D, the hot key will toggle the property:<ul><li>Radius: the radii of the neuron(s) in Horta 3D will be toggled between their set size (either default or user-set) and a very thin radius</li><li>Visibility: the hotkey will hide or show the neurons(s)</li><li>Background: when this is toggled on, the neuron is placed in a &ldquo;background&rdquo; state that can be seen but not interacted with (ie, you cannot move, select, or add points to a background neuron)</li><li>Crosscheck: this is the same as &ldquo;background&rdquo; and &ldquo;radius&rdquo; together; it&rsquo;s designed to have a neuron visible but unobtrusive and unchangeable</li></ul></li><li>Note that this feature has been buggy in the past; sometimes you need to save repeatedly before the setting holds.</li></ul><h3 id=shared-workspaces>Shared workspaces</h3><p>When multiple users open and work in the same workspace, the server acts as the intermediary for all changes to the database.</p><ul><li>It ensures that changes occur one at a time, in order.</li><li>It prevents users from changing neurons they do not own.</li><li>It broadcasts the results of changes to all users, so users in the same workspace can see changes made by other users.</li></ul><p>See also &ldquo;Changing neuron ownership&rdquo; in the Horta Features section.</p><h3 id=spatial-filtering>Spatial filtering</h3><p>When a workspace has a large number of neuron fragments, such as those created by an automated segmentation process, two negative consequences may occur. First, the display becomes visually cluttered, and second and more important, performance of all kinds can degrade. These problems can be alleviated by only loading and displaying a small subset of all fragments in the region where the tracer is working. To enable spatial filtering:</p><ul><li>Click the gear menu under the neuron list and choose &ldquo;Set Neuron Filter Strategy&rdquo;.</li><li>The first check box enables or disables the filter.<ul><li>In all cases, only fragments owned by the tracing group are affected. Neurons owned by tracers (current tracer or other tracers) will always be loaded.</li></ul></li><li>There are currently two options for the filter:<ul><li>Proximity: fragments will be loaded if they are close to any non-fragment neuron.</li><li>Selection: fragments will be loaded if they are close to the last selected annotation.</li></ul></li><li>Distance: in either strategy, this controls how close fragments need to be to the target neuron(s) or point in order to be loaded.</li></ul><p>The three numbers next to the <code>Neurons</code> title of the neuron list tell you the current state of the filtering. If the display reads <code>Neurons (12/34/56)</code>, it indicates that there are 56 neurons in the workspace total, of which 34 are loaded into memory due to spatial filtering, and of which 12 are displayed in the neuron list due to text filtering.</p><p><strong>Note</strong>: If there are more than 100 neurons that are owned by the tracer group (<code>mouselight</code> in the Janelia instance) in a workspace, the spatial filter will be enabled automatically when the workspace is loaded. This can results in unexpectedly not seeing any neurons, or far fewer neurons, than expected, as they will be filtered out of the neuron list and the view.</p><h3 id=task-workflow--neuron-cam>Task workflow & Neuron Cam</h3><p>This feature is still being developed and will be documented later.</p><h3 id=movie-maker-and-scene-editor>Movie Maker and Scene Editor</h3><p>The Horta Movie Maker is designed to created fly-through movies, typically for presentations. It is not supported and not documented at this time.</p><h2 id=more-horta-2d-features>More Horta 2D features</h2><h3 id=right-click-operations>Right-click operations</h3><p>Horta 2D has a number of operations on its right-click menu. Many of them are described elsewhere, especially in the <a href=https://hortacloud.janelia.org/docs/user_manual/basic_operations/>Horta Basic Operations</a> section. We will quickly summarize most of the operations here.</p><h4 id=right-click-in-empty-space>Right-click in empty space</h4><p>Some options appear when you click in empty space in the 2D view, with no annotation under the mouse pointer.</p><ul><li>Scroll through Sample (Z): The camera will move to the lowest plane (smallest z) at the mouse pointer location and smoothly move through the planes until it reaches the highest plane. The zoom level is not changed.</li><li>File: All the operations on this menu are deprecated and should not be used.</li><li>Copy (various): When any of these options are selected, information about the location of the mouse pointer is copied to the clipboard. Note that for HortaCloud, the data is copied to the AppStream clipboard, and you must click the icon in the toolbar to copy it to the clipboard of your local computer<ul><li>Micron coords: the x, y, z location in µm in this form: <code>[75556.8, 43819.6, 23460.8]</code></li><li>Octree location: the location in the file hierarchy of the 2D tile under the mouse pointer. See the Horta Reference section for more details on the file layout. The format is this: <code>/5</code></li><li>Raw file tile location: the file path to the raw microscope tile that produced the rendered data under the mouse pointer, if available.</li><li>Octree filepath: the file path to the rendered tile under the mouse pointer.</li></ul></li><li>Task Workflow: see below</li><li>View: The view submenu replicates a number of buttons on the Horta 2D toolbar and side navigation panel. It is redundant and likely to be removed at some point in the future.</li></ul><h4 id=right-click-on-an-annotation>Right-click on an annotation</h4><p>If you right-click on an annotation in Horta 2D, a longer set of operations appears in addition to those described above. Note that an annotation will become visibly slightly larger when the mouse pointer is over it, indicating that the annotation will be the target of the click. Again, some of the operations are either deprecated or may be removed from the menu.</p><ul><li>Trace path to parent: generate an automatically traced path from the selected annotation to its parent (see &ldquo;Automatic point refinement and tracing&rdquo;, below)</li><li>Delete subtree: deletes the annotation under the mouse pointer and all annotations in the tree below it</li><li>Delete link: deletes the annotation under the mouse pointer if it is an endpoint, an isolated single point, or a point with a single parent and child (in which case the parent and child are connected). You cannot delete a branch point or a root point with children; use &ldquo;delete subtree&rdquo; instead.</li><li>Merge chosen neurite&mldr;: see &ldquo;Smart merge&rdquo; below</li><li>Transfer neurite: As described in Horta Concepts, a &ldquo;neurite&rdquo; is a structure rooted at a single root annotation, while a &ldquo;neuron&rdquo; is a container that may hold several neurites. This operation moves the selected neurite to another existing neuron (chosen from a dialog), or to a newly created neuron, which you are prompted to name.</li><li>Split anchor: This operation creates a new annotation between the selected annotation and its parent, placed close to the selected annotation. It&rsquo;s used to increase the density of points in the neuron.</li><li>Split neurite: This operation splits the current neurite into two, with the selected annotation cut from its parent into a new root.</li><li>Add, edit, delete note: See &ldquo;Notes&rdquo; section below.</li><li>Edit neuron tags/group properties: See &ldquo;Tags&rdquo; section below.</li><li>Generate neuron review tree/Select point in Task View: See &ldquo;Task workflow&rdquo; section below.</li><li>Set neuron radius: This operation allows the user to set the radius associated with the annotation. By default it is set to 1.0 µm.</li></ul><h3 id=automatic-point-refinement-and-path-tracing>Automatic point refinement and path tracing</h3><div class="alert alert-primary" role=alert><h4 class=alert-heading>Desktop only</h4><p>These features only work in the desktop version of Horta. HortaCloud data does not contain the high-resolution 2D data needed to make them work.</p><p>If you are working on a rare dataset that <em>does</em> have the full 2D octree in HortaCloud, it should work.</p></div><ul><li>Automatic point refinement: This option can be toggled on and off from the gear menu in the workspace information area. It only applies to Horta 2D.<ul><li>When this feature is toggled on, annotations will be placed at the x, y location of the click as usual. However, the annotation will be placed on the z-plane which has the brightest signal in the first channel within five planes of the click.</li></ul></li><li>Automatic path tracing: This option can be toggled on and off from the gear menu in the workspace information area.<ul><li>When this feature is toggled on, when the user adds a new annotation, Horta 2D places an additional set of annotations between the new annotation and its parent.</li><li>The &ldquo;automatic path&rdquo; is calculated automatically to follow the signal in three dimensions in the first channel using an A-* (A-star) algorithm. The details are contained in the reference section. The points are placed densely, approximately one pixel apart.</li><li>These paths are also drawn in a different style than the links between manually-placed points.</li><li>While the toggle is active, the paths are automatically recalculated whenever any manually-placed annotation changes. So if an annotation is moved by hand, all of the links to its parent and children will be updated with new automatic paths.</li><li>If you are using this feature, you should place annotations not too far apart. The algorithm is limited so it will not run more than a handful of seconds, and if points are too far apart, the algorithm may not find a path before it runs out of time.</li><li>These points may be exported as other points are. The &ldquo;Export SWC&rdquo; dialog contains one option to let you control how many points are exported. The &ldquo;Point density&rdquo; value should be set to 0 if you don&rsquo;t want to export any automatically placed points, set to 1 if you want to export all of them, or to a positive integer n if you want to export every nth point.</li></ul></li></ul><p>Note that you may request an automatic path tracing from an annotation to its parent explicitly from the right-click annotation menu.</p><h3 id=smart-merging>Smart merging</h3><p><strong>Note</strong>: this feature is experimental!</p><p>When presented with a large number of neuron fragments that must be assembled into reconstructed neurons, such as those provided by automated image analysis, the amount of time merging each neuron pair should be minimized. The &ldquo;smart merge&rdquo; feature tries to make it easier for the user to do a large number of repeated merges.</p><ul><li>To use this feature, select any point on the first neuron fragment. Then right-click on any point in the second neuron fragment and choose &ldquo;Merge chosen neurite to selected neurite&rdquo;.</li><li>Horta 2D will attempt to find the two endpoints in the two fragments that are closest.</li><li>Horta 2D will then move the point selection (the next parent selection) to the farthest endpoint in the merged neuron.</li></ul><h3 id=arrow-key-navigation>Arrow key navigation</h3><p>You may navigate along the neuron backbone in Horta 2D using the arrow keys. With a point in a neuron selected (set as next parent), pressing an arrow key moves the selection to another point and recenters the screen on that point.</p><ul><li>Right arrow: moves to the next branch point or endpoint farther away from the neuron root; if there are multiple possible branches, the first is followed (see below)</li><li>Left arrow: moves to the previous branch point or root toward the root</li><li>Alt + left/right arrow: as before, but move by only one point instead of until next branch/root/end</li><li>Up/down arrows:<ul><li>In general, the up and down arrows move you among parallel branches</li><li>When on a neuron segment that has another segment in parallel (another segment with the same branch point parent), move to the next such branch in sequence, positioned at the first point beyond the branch point.</li><li>When on a branch point or root, or segment without parallel branches, does nothing.</li></ul></li><li>The order of branches in all cases (&ldquo;first&rdquo; for right arrow, or parallel branches for up/down arrow) is determined by the order the children of the branch appear in internal data structures</li></ul><h3 id=other>Other</h3><p>The &ldquo;Volume cache&rdquo; checkbox and &ldquo;Clear cache&rdquo; button to the right of the 2D view area should generally be ignored.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Desktop</h4>Since the desktop version of Horta uses the full 2D octree, prolonged browsing in the 2D view can fill up the 2D tile cache. Usually the system will clear its cache automatically, but in rare cases, when the cache is near full, the system will spend too much time managing the cache relative to loading tiles, and performance will suffer. When noticing a slowdown in tile loading, the user can press &ldquo;Clear Cache&rdquo;, and this may alleviate the issue.</div><h2 id=more-horta-3d-features>More Horta 3D features</h2><h3 id=right-click-operations-1>Right-click operations</h3><p>Horta 3D has a number of operations on its right-click menu. As with Horta 2D, some appear only when you right-click over an annotation, and others appear all the time. The options that always appear relate to display, and they are described below in &ldquo;Display options&rdquo;.</p><p>The operations that pertain the the annotation (anchor) or neuron under the mouse pointer replicate the corresponding functions in Horta 2D&rsquo;s UI (see above).</p><h3 id=display-options>Display options</h3><p>There are a number of view options that can be adjusted in Horta. Many of them are located on the right-click menu under &ldquo;View&rdquo;.</p><h4 id=view--projection>View > Projection</h4><ul><li>Maximum Intensity Projection (MIP) is the default display projection mode in Horta. MIP projection provides a robust, informative view of volumetric imagery data, under a wide variety of brightness settings.</li><li>Occluding projection (&ldquo;true&rdquo; volume rendering) can convey a better sense of relative depth, compared to MIP, which can be useful for discriminating neurites that approach one another closely in space. The downside of this superior display quality is that it is very sensitive to the exact brightness settings. The user should probably adjust the brightness settings (Window->Horta->Brightness), especially the minimum intensity value, before switching to the &ldquo;Occluding&rdquo; mode.</li></ul><h4 id=view--rendering-filter>View > Rendering Filter</h4><p>Horta provides three sub-voxel filtering options: Nearest Neighbor, Trilinear, and Tricubic. These filtering options can be used to trade off speed for image quality.</p><ul><li>Nearest-neighbor filtering shows the individual voxels of the raw image tile as discrete blocks. This mode is not particularly useful for visualization, but it is fast, and it is very useful for debugging, and for directly demonstrating the true spatial resolution of the underlying imagery data.</li><li>Trilinear filtering, the default option, interpolates between adjacent voxel intensities using a fast hardware-accelerated computation. This is a good compromise between render speed and image quality.</li><li>Tricubic interpolation is significantly slower than trilinear interpolation, but yields a smoother appearance, which can make it easier to see the true structure of the tissue being observed.</li></ul><h4 id=other-view-options>Other View options</h4><ul><li>View > Stereo3D lets you choose between multiple methods of displaying images if you have appropriate 3D hardware support.</li><li>View > Compress voxels in z: This option, when checked, compresses voxels in the z direction to make them appear more cubic. Normally, the data has a worse resolution in z, giving the image volume a stretched look. The user may choose which appearance they prefer.</li><li>View > Save viewer settings: If you make changes to the color sliders, tracing channel settings, or any other Horta view settings, you must choose this command to save those changes.<ul><li><strong>Note</strong>: unlike Horta 2D color model settings, which are saved with the workspace, these settings are save on a per-user basis! If you switch to another workspace, the same Horta color settings will be used.</li></ul></li><li>Tracing channel: As described in Horta Basic operation, annotation in Horta 3D is assisted by Horta 3D&rsquo;s &ldquo;Snap to Signal&rdquo; feature. This menu allows the user to choose which channel or combination of channels will be used to determine signal brightness.</li></ul><h4 id=tiles>Tiles</h4><p>The tiles submenu controls loading of the 3D data tiles. Note that in normal operation, tiles are loaded automatically as you navigate through the volume, typically displaying 5-8 tiles surrounding the last mouse click.</p><ul><li>Tiles > Load Horta Tile at Cursor/Focus: Force load a tile at either the center of the screen (Focus) or the location of the mouse cursor; occasionally useful if the automatic algorithm isn&rsquo;t doing what you want.</li><li>Tiles > Prefer rendered ktx tiles: When checked, Horta will prefer to load the ktx file format tiles. This is the default; ktx tiles load much faster than the alternative raw tiles. If this setting is unchecked, raw tiles, if available, will be loaded instead. Note that you must save viewer settings and restart the application if you change this setting.</li><li>Tiles > Clear all volume blocks: Choosing this operation forces all tiles to be discarded from the screen and cache and reloaded.</li><li>Auto-load image tiles: When checked, tiles are loaded automatically as you navigate; when unchecked, you must manually specify load of each desired tile using the other operations (Load at Cursor or Focus).</li></ul><p>Normally the user will not change any of these options or use any of these operations.</p><h4 id=horta-3d-auxiliary-windows>Horta 3D auxiliary windows</h4><p>Horta 3D has a number of panels containing a variety of supplemental controls. They can be opened from the Window menu > Horta. All of them can be undocked, moved, and redocked anywhere you like.</p><ul><li>Horta 2D, Horta 3D: opens the view window but does not load any data (if data has already been loaded, it will be visible)</li><li>Camera Control: provides another way to control the camera in Horta 3D<ul><li>Center focus, rotation, and zoom: replicate mouse commands</li><li>View Slab: adjusts how thick the visible slab of data is; the default preset II shows a nice chunk of data; preset I shows a very thin slab, closely resembling the 2D view<ul><li>In this pseudo-2D view, hotkeys (shift-A and shift-Z by default) move the camera along the axis into the screen, mimicking scrolling through a z-stack in a 2D view.</li></ul></li></ul></li><li>Color Sliders: used to adjust the color settings for the image data channels and the tracing channel (as described in Horta Basic operation)</li><li>Movie Maker and Scene Editor: not supported or documented</li><li>Graphics Speed: used for debugging; displays some graphics performance data</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b1961a5565e77677ad7d5e4b849b6ec>2.6 - Reference</h1><div class=lead>Horta reference</div><h2 id=importexport-file-formats>Import/export file formats</h2><h3 id=swc>SWC</h3><p>The swc file format is a standard format for recording neuron skeletons. Unfortunately, while the basic format is widely used, there is no single standard for defining the format, and as a result, there are differences in implementation among various swc writers and readers. The basic spec can be seen <a href=http://www.neuronland.org/NLMorphologyConverter/MorphologyFormats/SWC/Spec.html>here</a>.</p><p>In summary, an SWC file:</p><ul><li>is a text file</li><li>contains a number of header lines, each beginning with a &lsquo;#&rsquo; character</li><li>followed by a list of points, one per line, with parents preceding children</li></ul><p>Each line consists of seven numbers separated by whitespace in the following order: <code>id type x y z radius parent</code>, with:</p><table><thead><tr><th>field</th><th>value</th></tr></thead><tbody><tr><td>id</td><td>integer identifying the point, in ascending order</td></tr><tr><td>type</td><td>integer indicating the type of the previous segment, with:<br>0 = undefined<br>1 = soma<br>2 = axon<br>3 = dendrite<br>4 = apical dendrite<br>5 = fork point<br>6 = end point<br>7 = custom</td></tr><tr><td>x, y, z</td><td>floating point coordinates of the point</td></tr><tr><td>radius</td><td>floating point radius of the previous segment</td></tr><tr><td>parent</td><td>id value of the parent for the current point; a root point has parent = -1</td></tr></tbody></table><p>Notes:</p><ul><li>two fields are non-critical for rendering the basic neuron skeleton:<ul><li>the <code>type</code> field describes but does not affect connectivity and can usually be ignored</li><li>the <code>radius</code> field does not affect connectivity; it&rsquo;s only necessary if you are rendering neuron volumes (skeletons with width)</li></ul></li><li>a node&rsquo;s <code>id</code> must appear in the <code>id</code> column before it appears as a <code>parent</code>; that is, child nodes must appear lower in the list than parent nodes</li></ul><h4 id=janelia-specific-details>Janelia-specific details</h4><ul><li>Only nodes with <code>type</code> 5 and 6 are marked by Horta, as they are the only types that can be inferred from geometry at export time. All other points are marked as <code>type</code> 0. On import, the <code>type</code> column is ignored.</li><li>Coordinates and radii are assumed to be in microns.</li><li>A few headers are used by Horta:<ul><li><code>ORIGINAL_SOURCE</code>, a fairly standard header, is set to &ldquo;Janelia Workstation Large Volume Viewer&rdquo;<ul><li>That is the original name for the software, back when it was only 2D, and we decided not to change this identifier.</li></ul></li><li>The x, y, z locations of the nodes are centered on the origin at export time because not all SWC viewers can handle the large coordinates (Horta can). The header field <code>OFFSET</code> gives the x, y, z offset needed to reproduce the original annotation location. The values are whitespace-delimited floating point numbers. Horta correctly handles this field during its own import and export; it will always use the field on export, but it doesn&rsquo;t complain if it&rsquo;s missing on import. If an swc reader ignores this header, the neuron will be of correct shape but shifted in space from its original location.</li><li>The color of the exported neuron (optional) is recorded in the header field <code>COLOR</code> as a comma-separated list of floating point RGB values ranging from 0 to 1.</li><li>Other headers are ignored at import.</li></ul></li><li>The name of the neuron is not stored inside the swc file. However, when imported, the neuron will be named like the swc file.</li></ul><p>Here is an example swc file:</p><pre tabindex=0><code># ORIGINAL_SOURCE Janelia Workstation Large Volume Viewer
# OFFSET 76290.282407 42379.443335 23460.277313
# COLOR 0.501961,0.000000,1.000000
1 0 -870.258314 84.790733 0.000000 1.000000 -1
2 0 -408.096941 6.007367 0.000000 1.000000 1
3 5 54.064431 -72.775998 0.000000 1.000000 2
4 0 232.512856 -256.688292 0.000000 1.000000 3
5 6 600.186790 -429.961032 0.000000 1.000000 4
6 0 159.078322 142.548313 0.000000 1.000000 3
7 6 232.512856 526.078910 0.000000 1.000000 6
</code></pre><h3 id=json>JSON</h3><p>When neurons are exported from Horta in swc format, any notes attached to the neuron&rsquo;s points are also exported. The notes are contained in a JSON file of the same name as the swc file but with a &ldquo;.json&rdquo; extension. The JSON file contains a dictionary with the following fields:</p><ul><li>workspaceID: contains the integer workspace ID number</li><li>username: contains the workstation username of the user doing the export</li><li>offset: contains a list of floating point numbers [x, y, z] holding the offset as described in the section above</li><li>neurons: contains a list of dictionaries, one per neuron exported; each dictionary has fields:<ul><li>neuronID: contains the integer neuron ID number</li><li>notes: contains a list of neuron notes; each note is a list of [x, y, z, note]</li></ul></li><li>on import, the username and workspace and neuron IDs are ignored</li></ul><p>The x, y, z, coordinates of each note will match the coordinates of the corresponding annotation in the corresponding swc file, as they use the same offset system. Horta automatically imports and exports the JSON files when the swc files are imported or exported.</p><p>Here is an example JSON file that corresponds to the above example swc file:</p><pre tabindex=0><code>{
  &#34;workspaceID&#34; : 2229358932059488401,
  &#34;username&#34; : &#34;olbrisd&#34;,
  &#34;neurons&#34; : [ {
    &#34;neuronID&#34; : 2653026075256291473,
    &#34;notes&#34; : [ [ 232.51285642151197, 526.0789095035507, 3.637978807091713E-12, &#34;traced end&#34; ], [ 232.51285642151197, -256.68829229611583, 3.637978807091713E-12, &#34;interesting&#34; ] ]
  } ],
  &#34;offset&#34; : [ 76290.28240663109, 42379.443335160235, 23460.2773125 ]
}
</code></pre><h2 id=image-file-formats>Image file formats</h2><h3 id=raw-tiff-stacks>Raw tiff stacks</h3><p>The raw microscope data is stored in tiff stacks. They can be displayed in Horta 2D on demand, but they are typically used only in rare instances when stitching in the rendered images is not perfect. Typically this data is only available in the desktop version of the software at the site the sample was imaged.</p><p>Details of the files and their organization will be added later.</p><h3 id=rendered-2d-images>Rendered 2D images</h3><p>The raw microscope data is transformed and stitched together into a contiguous rendered whole. It&rsquo;s also stored in tiff stacks, rendered at multiple resolutions and arranged in an octree. For HortaCloud, this data likely only has the a single low-resolution image for each channel.</p><p>Details of the files and their organization will be added later.</p><h3 id=hortaktx-3d-volumes>HortaKTX 3D volumes</h3><p>Horta&rsquo;s 3D images are optimized for fast loading into the Horta viewer. The HortaKTX format is based on the <a href=https://registry.khronos.org/KTX/specs/1.0/ktxspec_v1.html>KTX file format</a> which is designed to load directly into graphics cards. In order to keep the files both small enough to load rapidly and small enough to economically store, the rendered data is transformed and down-sampled before KTX tile creation. These files are also arranged in a multiscale octree for full volume viewing.</p><h2 id=a-algorithm-for-automatically-traced-paths>A* algorithm for automatically traced paths</h2><p>The algorithm for computing the path is:</p><ul><li>Extract a rectangular solid block of voxels containing the two endpoints, plus a small buffer region in all three dimensions. (Thus, if the neuron meanders outside of this block, the technique will not work well. Try to choose anchors with relatively straight connections between them.)</li><li>Measure the variation in voxel intensity within that block: record mean and standard deviation.<ul><li>Currently, only the first channel is examined!</li></ul></li><li>Assume that the background (non-neuron) intensities follow a normal distribution, with the measured parameters (mean and standard deviation).</li><li>Define the path weight for a particular voxel, as the probability that an intensity greater than or equal to the voxel intensity, could have arisen randomly from the background distribution. Thus dim voxels get a large path weight, and bright voxels get a small path weight. This value can get extremely small for very bright pixels (think 10 raised to the minus seventy power). You can think of this weight as (1.0 minus the probability this voxel is a neuron), assuming all voxels are either background or neurons.<ul><li>weight = erf( (intensity - mean) / (standard_deviation) ), where erf() is the <a href=http://en.wikipedia.org/wiki/Error_function>error function</a>.</li></ul></li><li>Because it uses the mean and standard deviation of intensities, this method of path weighting is robust in the face of large uniform intensity bias offsets, like we sometimes see in the mouse brain imagery.</li><li>Use the <a href=https://en.wikipedia.org/wiki/A*_search_algorithm>A* (A-star) algorithm</a> to compute the lowest cost path connecting the two endpoints. This path is guaranteed to be optimal.</li><li>The algorithm will be terminated if it takes more than 10 seconds to finish.</li></ul><h2 id=user-groups-for-ownership-purposes>User groups for ownership purposes</h2><p>There are two user groups in the workstation that are used in neuron ownership operations. They are set at compile time to values specified in the <code>console.properties</code> file.</p><pre tabindex=0><code>console.LVVHorta.tracersgroup=group:mouselight
console.LVVHorta.activetracersgroup=group:mouselight_tracers
</code></pre><ul><li>The &ldquo;tracersgroup&rdquo; variable should be set to a group that contains all of the people using Horta to trace neurons. If a neuron is owned by this group, any member of the group can take ownership immediately. This group is expected to be used for ownership of samples and workspaces as well, so it may contain people who are not tracers but who will be looking at the same data and/or the tracers&rsquo; work.</li><li>The &ldquo;activetracersgroup&rdquo; variable should be set to a group containing only people who are tracing. The members of this group will be listed in some neuron ownership change dialogs for convenience.</li><li>If either group does not exist in the workstation database, the corresponding features will be disabled.</li><li><strong>Note</strong>: This scheme assumes that all tracers are members of one group that shares data freely. If you need to support multiple groups that will not be sharing data, you should currently deploy separate infrastructure (servers, etc) to support each group.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b1d565f35ba3dfe73fe7ebb6e3497f34>2.7 - Synchronized Folders</h1><div class=lead>How to use Synchronized Folders to make data available to Horta</div><h2 id=what-are-synchronized-folders>What are Synchronized Folders</h2><p>If you are incrementally adding a lot of data to the system, using the <strong>File</strong> → <strong>New</strong> → <strong>Horta Sample</strong> menu option can become tedious. If you create a Synchronized Folder, your data will be discovered as it is placed in storage, and Horta Samples will be automatically generated. The new Horta Samples can be made available to you or a group of users of your choice.</p><p>Synchronized Folders also load traced neurons, when those tracings are made available in a specific format. The <a href=https://registry.opendata.aws/janelia-mouselight/>MouseLight Open Data</a> contains traced neurons alongside the imagery. If you use a Synchronized Folder to bring that data into Horta, you&rsquo;ll also get Workspaces containing the published neurons that were traced on each sample.</p><h2 id=creating-a-synchronized-folder>Creating a Synchronized Folder</h2><p>You can find Synchronized Folders near the top of the Data Explorer:</p><p><img src=../synchronized_folders.png alt="Synchronized folders"></p><p>To add a new Synchronized Folder, right-click the &ldquo;Synchronized Folders&rdquo; node and choose &ldquo;Add Synchronized Folder&mldr;&rdquo;</p><p><img src=../add_sync_folder.png alt="Adding synchronized folder"></p><p>You can fill out the form as follows:</p><ul><li>The <strong>path</strong> you want to synchronize needs to be mounted and accessible through the back-end. Typically, S3 buckets are mounted as <code>/s3data/&lt;bucket name></code>. If you don&rsquo;t know the path to use, talk to your system administrator.</li><li>You can choose any <strong>name</strong> (i.e. label) for your synchronized folder. This is the name that will appear in the Data Explorer. It can include spaces and special characters if you wish.</li><li>The <strong>depth</strong> is the depth of the hierarchy to traverse before reaching data to discover. In the example above we specify a depth of 1, since we are searching in the images subfolder. If we wanted to search the entire bucket (i.e. at the parent folder level), we would need to specify a depth of 2 to find the same Horta Samples.</li><li>The <strong>owner</strong> is the user or group that will &ldquo;own&rdquo; the objects in the Workstation. This primarily affects who can see the objects in the Data Explorer. For example, if you choose a group here then everyone in the group will see the samples you discover.</li><li>Finally, you should choose the data types that should be discovered while synchronizing with the file system. Typically, you&rsquo;ll want to select <strong>Horta Samples</strong> here, but you can also discover other data types such as <strong>Zarr Containers</strong>, which can be viewed in 2D with the BigDataViewer modules.</li></ul><p>Once you click &ldquo;Save and Synchronized&rdquo;, the backend will try to explore the path you provided and create objects corresponding to any data it finds. You can watch the progress in the &ldquo;Background Tasks&rdquo; panel (typically found on the right side of the screen, it can also be accessed via the <strong>Window</strong> → <strong>Core</strong> menu). Synchronization can take a while when there are a lot of traced neurons, such as with the MouseLight Open Data. Once the process is complete, you can click the Refresh button in the Data Explorer to see what was discovered.</p><p>Currently, synchronization is done only on-demand. If you add data later, make sure to right-click your Synchronized Folder and choose &ldquo;Refresh Synchronized Folder&rdquo;.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-76ebc5b0c62cb5e65c114e0581fb7578>2.8 - Reporting issues</h1><div class=lead>How to report issues with HortaCloud</div><p>If you encounter an issue while running Horta, or if you have comments, questions, or suggestions, there are multiple ways you can contact the Horta development team.</p><h2 id=inside-horta>Inside Horta</h2><p>(desktop) You may report a bug at any time within Horta. Simply choose &ldquo;Report a bug&rdquo; from the Help menu. Provide a description of what you were doing at the time of the issue! Sometimes Horta will encounter problems and display a dialog box with an ugly-looking error message. At the bottom of this dialog box, you&rsquo;ll also see a &ldquo;Report&rdquo; button. Again, please let us know what you were doing at the time of the issue if you choose to report an issue at this time.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Coming soon</h4>This feature does not currently work in HortaCloud! The dialog works, but email is not sent!</div><h2 id=github>GitHub</h2><p>GitHub is where the HortaCloud and Janelia Workstation source code is stored. If you are a GitHub user and would like to open an issue:</p><ul><li>the Janelia Workstation repository: <a href=https://github.com/JaneliaSciComp/workstation>https://github.com/JaneliaSciComp/workstation</a><ul><li>this repo contains the code for the Horta application; if you have issues inside the application, this is the place to report them</li></ul></li><li>the HortaCloud repository: <a href=https://github.com/JaneliaSciComp/hortacloud>https://github.com/JaneliaSciComp/hortacloud</a><ul><li>this repository contains the code for managing the AWS infrastructure that deploys and runs Horta in AppStream; if you are a system admin and have deployment or management issues, report them here</li></ul></li></ul><h2 id=x>X</h2><p>The HortaCoud X address is <a href=https://twitter.com/HortaCloud>HortaCloud</a>.</p><h2 id=google-groups>Google groups</h2><p>You can ask to join the Google group for HortaCloud support <a href=https://groups.google.com/g/hortacloud-support>here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9d2b3fd06ac095b9dc68b7aa8fbf324e>3 - Administration guide</h1><div class=lead>How to deploy and administer the HortaCloud system</div><p>The recommended way to deploy HortaCloud is to use <a href=aws>Amazon Web Services (AWS)</a>.</p></div><div class=td-content><h1 id=pg-80336952a101429f70d9a84e05c2d806>3.1 - AWS</h1><div class=lead>Learn how to deploy and operate your own HortaCloud instance on AWS</div><p>HortaCloud is easily deployed on Amazon Web Services (AWS) using the AWS CDK to automatically provision resources.</p></div><div class=td-content><h1 id=pg-aa09ac4c336c90970d422edf7c37abe2>3.1.1 - Costs</h1><div class=lead>Costs of running the system in the cloud</div><p>Deploying this system on Amazon Web Services (AWS) incurs a monthly cost for AWS service usage.</p><p>In particular, the cost breakdown is roughly:</p><ul><li>$382/mo - Per user costs for running the Horta client on AppStream</li><li>$277/mo - Back-end services running on EC2 (with Savings Plan)</li><li>$76/mo - Storage (3 TB) for one sample image on S3</li><li>$34/mo - Virtual Private Cloud (VPC)</li></ul><p>Therefore, the minimum total cost per month for a single user would be about $770 ($9,237/year). For 2 users, the monthly cost would be $1130 ($13,570/year), etc. The full estimate can be <a href="https://calculator.aws/#/estimate?id=ecbba8c6713281bc419c70de414d8a1db19dd345">found here</a>.</p><p>We are assuming 8 hours of tracing per day, 5 days a week. If the system is not used for 8 hours a day, the cost will be less. You can dial in your own expected usage in the <a href="https://calculator.aws/#/estimate?id=ecbba8c6713281bc419c70de414d8a1db19dd345">AWS calculator</a> for an accurate cost estimate.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a6019a15515da980daf6ab4a20aa0a20>3.1.2 - Deployment</h1><div class=lead>How to deploy HortaCloud to your own AWS account</div><p>The deployment uses AWS CDK to create AWS resources on your AWS account as shown in the diagram below. All services run in a secured Virtual Private Cloud (VPC).</p><a href=../cloud_architecture.png><img src=../cloud_architecture.png class="rounded mx-auto" style=max-width:800px alt="cloud architecture diagram"></a><h2 id=install-prerequisites>Install prerequisites</h2><p>You should have <strong>node > v16</strong> installed on your local machine. We recommend using <a href=https://github.com/nvm-sh/nvm>nvm</a> to install and activate this version of node.</p><ul><li>Install AWS CLI<ul><li>AWS CDK requires AWS CLI to be installed and configured on the computer from which one runs the deployment procedure. <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html>Installation</a> & <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html>configuration</a> instructions can be found in the AWS documentation.</li></ul></li></ul><h2 id=get-the-deployment-scripts>Get the deployment scripts</h2><p>Clone the <a href=https://github.com/JaneliaSciComp/hortacloud>HortaCloud GitHib repository</a> containing the deployment scripts:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/JaneliaSciComp/hortacloud/
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> hortacloud
</span></span></code></pre></div><p>Install the dependencies:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>npm run setup -- -i
</span></span></code></pre></div><p>This command will install all packages that are needed to run the deployment procedure. The &lsquo;-i&rsquo; flag will tell the setup script to install npm packages for all application modules: cognito_stack, vpc_stack, workstation_stack and admin_api_stack. If you do not specify the &lsquo;-i&rsquo; flag, the command will only check the .env file and create it in case it&rsquo;s missing. Notice how the &lsquo;-i&rsquo; flag is preceded by two hyhens &lsquo;&ndash;&rsquo; - this is specific to npm not to cdk, so all script specific flags must be after the double hyphen separator.</p><h2 id=configure-environment>Configure environment</h2><p>The following values must be set in the <code>.env</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>AWS_REGION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your aws region&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>AWS_ACCOUNT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;your aws account&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>HORTA_ORG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;app qualifier name&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>ADMIN_USER_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;admin email&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_JWT_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;a 32 byte jwt secret&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_MONGO_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;a 32 byte mongo secret&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_APP_PASSWD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;app password&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>RABBITMQ_PASSWD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;rabbitmq password&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JACS_API_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;jacs api key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>JADE_API_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;jade api key&gt;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>HORTA_DATA_BUCKETS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;s3 buckets that hold MouseLight data&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c4a000>NEW_HORTA_ENVIRONMENT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true</span>
</span></span></code></pre></div><p>The api keys and secrets have been randomly generated during the setup step, but you can generate new ones with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl rand -hex <span style=color:#0000cf;font-weight:700>32</span>
</span></span></code></pre></div><p>We prefer this procedure because these values will be handled during the installation using the <code>sed</code> command and it is preferable that they not contain any characters that require escaping in a sed command.</p><p>If you already have data on some S3 buckets you can add them to <code>HORTA_DATA_BUCKETS</code> as a comma separated list. For example, if you want to use Janelia&rsquo;s Open Data bucket but in addition you also have your data on a private bucket (&lsquo;janelia-mouselight-demo&rsquo; in this example) you need to set <code>HORTA_DATA_BUCKETS="janelia-mouselight-imagery,janelia-mouselight-demo"</code>. By default, only the MouseLight Open Data bucket is mounted. Every bucket specified in the &lsquo;HORTA_DATA_BUCKETS&rsquo; list will be available in Horta as <code>/s3data/&lt;s3BucketName></code> directory.</p><p>If this is the first installation of HortaCloud and no restore from an existing backup is done, ensure that <code>NEW_HORTA_ENVIRONMENT=true</code> - this is needed to create the default admin user. For environments that are restored from an existing backup the flag must be set to <code>NEW_HORTA_ENVIRONMENT=false</code>.</p><p>If you want to change the setting for <code>HORTA_WS_INSTANCE_TYPE</code>, keep in mind that you may have to change <code>HORTA_WS_IMAGE_NAME</code>.</p><p>For <code>HORTA_WS_INSTANCE_TYPE</code> set to any <code>stream.graphics.g4dn.*</code> instances:</p><ul><li><code>stream.graphics.g4dn.xlarge</code></li><li><code>stream.graphics.g4dn.2xlarge</code></li><li><code>stream.graphics.g4dn.4xlarge</code></li><li><code>stream.graphics.g4dn.8xlarge</code></li><li><code>stream.graphics.g4dn.12xlarge</code></li><li><code>stream.graphics.g4dn.16xlarge</code></li></ul><p>use: <code>HORTA_WS_IMAGE_NAME=AppStream-Graphics-G4dn-WinServer2019-09-01-2022</code> image.</p><p>For <code>HORTA_WS_INSTANCE_TYPE</code> set to any <code>stream.graphics-pro.*</code> instances:</p><ul><li><code>stream.graphics-pro.4xlarge</code></li><li><code>stream.graphics-pro.8xlarge</code></li><li><code>stream.graphics-pro.16xlarge</code></li></ul><p>use <code>HORTA_WS_IMAGE_NAME=AppStream-Graphics-Pro-WinServer2019-09-01-2022</code> image</p><p>Note: AWS deprecates the AppStream images relatively frequently so please make sure you use an AppStream-Graphics image that is available on AWS. You can see the available images from the AWS console if you select the &ldquo;AppStream 2.0&rdquo; service and then search &ldquo;Images > Image Registry&rdquo;</p><h2 id=configure-aws-account>Configure AWS account</h2><h3 id=iam-required-roles>IAM Required Roles</h3><p>In order to create an AppStream Image Builder, which is needed to create the Workstation Image, you need to have all <a href=https://docs.aws.amazon.com/appstream2/latest/developerguide/roles-required-for-appstream.html>roles required by AppStream</a>. Check that by simply connecting to the AWS console and check if the Roles are available in the IAM Service - select &ldquo;Services&rdquo; > &ldquo;Security, Identity, Compliance&rdquo; > &ldquo;IAM&rdquo; then verify that the required roles are present:</p><ul><li>AmazonAppStreamServiceAccess</li><li>ApplicationAutoScalingForAmazonAppStreamAccess</li><li>AWSServiceRoleForApplicationAutoScaling_AppStreamFleet</li></ul><h3 id=enable-google-drive-andor-onedrive-for-horta-cloud-workstation>Enable Google Drive and/or OneDrive for Horta Cloud Workstation</h3><p>Data access from Google Drive or OneDrive can be enabled at deployment time by simply setting the corresponding enterprise domains in <code>HORTA_GOOGLE_DOMAINS</code> or <code>HORTA_ONE_DRIVE_DOMAINS</code>. This can also be done after deployment directly from the AWS Console while the stack is running. Check <a href=https://docs.aws.amazon.com/appstream2/latest/developerguide/persistent-storage.html>AWS Appstream docs</a> how to enable these options directly from the AWS Console.
If your application does not see Google Drive and/or OneDrive for uploading or saving files, the storage must be added directly from the AppStream toolbar using the following steps (this procedure is fully documented in the <a href=https://docs.aws.amazon.com/appstream2/latest/developerguide/google-drive-end-user.html>AWS Docs</a>):</p><ul><li><p>Select <strong>My Files</strong> icon from the toolbar: <img src=/images/MyFiles.png width=25px></p></li><li><p>In the <strong>My File</strong> dialog click on <em>Add Storage</em> on the top right of the <strong>My Files</strong> dialog
<img src=/images/MyFiles_AddStorageDlg.png alt="Add Storage"></p></li><li><p>Then select the Drive and the account you want to use.
<img src=/images/MyFiles_StorageOptions.png alt="Select Storage"></p></li><li><p>At this point if AppStream has not yet been authorized to access the selected storage, Google Drive or OneDrive may ask you to authorize AppStream to access the storage.
<img src=/images/OneDrive_AuthRequest.png alt="OneDrive Auth">
<img src=/images/GoogleDrive_AuthRequest.png alt="Google Auth"></p></li><li><p>Once you authorized access to your storage, it will appear in the <strong>My Files</strong> dialog, and the <strong>Add Storage</strong> button will no longer be available
<img src=/images/MyFiles_AllStorageAdded.png alt="All storage added"></p></li><li><p>In the applications the new added storage options will look like this:
<img src=/images/AppStorageOptions.png alt="App Open Files"></p></li></ul><h3 id=aws-limits>AWS Limits</h3><p>Most AWS services allow you to setup restrictions on the number of active instances. The default limits, especially for some AppStream resources, such as &ldquo;Maximum ImageBuilders&rdquo; for some graphics instances - &ldquo;stream.graphics.g4dn.xlarge&rdquo; may be really low (0 in some cases). Connect to AWS console &ldquo;Service Quotas&rdquo; service and increase the limit for in case you see a <code>limit was exceeded</code> error. Typically take a look at the limits setup for your account for EC2, VPC, AppStream, S3. Keep in mind that limits may be different from instance type to instance type for AppStream service, so you may have to adjust the limits based on the AppStream instance type selection.</p><h2 id=deploy-hortacloud-services>Deploy HortaCloud services</h2><p>If this is the first time the application is deployed you will need to create a user login pool. This must be explicitly specified using &lsquo;-u&rsquo; flag [See <strong>Deploy the user login stack</strong> section below]:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy -- -u
</span></span></code></pre></div><blockquote><p><span style=background:#842029;color:#ea868f;padding:.3em>⚠️ <strong>The user pool should only be created once.</strong>:</span> including the &lsquo;-u&rsquo; flag on a future update or deployment will replace all your users accounts!</p></blockquote><p>After the setup is complete, subsequent deployments and updates to the application can be done by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy
</span></span></code></pre></div><p>There are a few steps during the deployment that require manual intervention. The deploy script will indicate when these steps should be taken with a ⚠️ warning message.</p><p>The full deployment of the application is done in 3, or 4 steps - if user login stack is deployed too, that run automatically one after the other,
with some manual intervention for <strong>AppStream builder</strong> step (third step outlined below):</p><ol><li><p><strong>Deploy the user login stack</strong> - this step is optional and practically is only needed first time the application is deployed. To create the user login stack you need to pass in &lsquo;-u&rsquo; flag to the deploy command (<code>npm run deploy -- -u</code>) which will automatically create a Cognito user pool and the &lsquo;admin&rsquo; user and &lsquo;admins&rsquo; group. You also have an option to import cognito users from a backup (<code>npm run deploy -- -u \ -r -b janelia-mouselight-demo -f hortacloud/backups/20220511030001/cognito</code>) but in this case you may need to skip the creation of the default admin user and group.</p></li><li><p><strong>Deploy the back-end stacks</strong> - this includes the AppStream builder. At the back end deployment the installation process will also create the admin user configured in <code>ADMIN_USER_EMAIL</code>.</p></li><li><p><strong>Connect to AppStream builder and install the Horta application</strong> - This is a semiautomated step that involves copying and running two PowerShell scripts onto the AppStream builder instance.</p></li><li><p><strong>Deploy the administration stack.</strong></p></li></ol><h3 id=install-the-horta-desktop-application>Install the Horta desktop application</h3><p>For client installation start and connect to the AppStream builder instance then copy the following scripts from this repo to the AppStream instance:</p><ul><li><a href=https://github.com/JaneliaSciComp/hortacloud/blob/main/vpc_stack/src/asbuilder/installcmd.ps1>installcmd.ps1</a> - installs JDK and the Horta application</li><li><a href=https://github.com/JaneliaSciComp/hortacloud/blob/main/vpc_stack/src/asbuilder/createappimage.ps1>createappimage.ps1</a> - creates the AppStream image</li></ul><p>After you copied or created the scripts:</p><ul><li>Log in to the AWS console and go to <a href=https://console.aws.amazon.com/appstream2>https://console.aws.amazon.com/appstream2</a></li><li>Find your new builder in the &ldquo;Images > Image Builder&rdquo; tab</li><li>Click on the image name and open an &ldquo;Administrator&rdquo; window by clicking on the &ldquo;Connect&rdquo; button.</li><li>Copy the installation scripts from your local machine to AppStream:<ul><li>Click on the folder icon at the top left of the window</li><li>Select the <code>Temporary Files</code> folder</li><li>Use the <code>Upload Files</code> icon to find the files on your machine and upload them.</li></ul></li><li>Open the powershell by typing &ldquo;`Power shell&rdquo; in the search found at the bottom left of the window. This step used to require an &ldquo;Administrator Power Shell&rdquo; but now it needs only a regular user power shell and it may actually fail the install if you run it in an Administrator Power Shell.</li><li>Change to the directory where you uploaded the installation scripts, eg:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#204a87>cd </span><span style=color:#4e9a06>&#39;C:\Users\ImagebuilderAdmin\My Files\Temporary Files&#39;</span>
</span></span></code></pre></div><ul><li>Run the installcmd script to install Horta. &lt;serverName> is the name of the backend EC2 instance, typically it looks like <code>ip-&lt;ip4 with dashes instead of dots>.ec2.internal</code>. Instructions for locating this are provided as output from the installer script. The Horta client certificate is signed using the ec2 internal name so do not use the actual IP for the &lt;serverName> parameter, because user logins will fail with a certificate error.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>installcmd</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>serverName</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>This will install the JDK and Horta. The installer will run silently and it will install the Horta application under the <code>C:\apps</code> folder. If it prompts you for the install directory, select <code>C:\apps</code> as the JaneliaWorkstation location.</p><ul><li><em>Optional</em> - To start Horta for testing, run:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>c:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>apps</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>runJaneliaWorkstation</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span>
</span></span></code></pre></div><ul><li><p>when prompted, login as the admin user you set in ADMIN_USER_EMAIL (leave the password empty)</p></li><li><p>Navigate through the menus to make sure Horta is working. <em>Do not create any user accounts at this time as they will get created from the Admin web application.</em></p></li><li><p>When testing is finished, close down Horta.</p></li><li><p>Finalize the creation of the AppStream image, run:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>createappimage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span>
</span></span></code></pre></div><p>Keep in mind that once you start this step the builder instance begins the snap shotting process and it will not be usable until it completes. After this is completed the AppStream image should be available and the builder will be in a stop state. To use it again you need to start it and then you can connect.</p><ul><li>You can now safely close the AppStream session and return to the AppStream console. There you will see a new image in the image registry with a status of <code>Pending</code>.</li><li>Once the image status has changed to a status of <code>Available</code> you can start the fleet by going to the <code>Fleets</code> page on the AppStream site.<ul><li>Select your fleet from the list of fleets and then select &lsquo;Start&rsquo; from the <code>Action</code> menu.</li></ul></li><li>At this point the installation script you started on your host machine, should continue to completion.</li></ul><h2 id=customizing-the-portal-url>Customizing the portal URL</h2><p>By default the application will have a very long url that is not easy to remember, something like:
<code>http://janelia-hortacloudwebapp-janeliahortacloudwebadmi-yefcny29t8n6.s3-website-us-east-1.amazonaws.com/</code>. Follow these instructions to create a shorter domain for use with your installation.</p><ul><li>Register a domain with Route53 or your domain provider.<ul><li>The Route53 page in the AWS console has a &ldquo;Register domain&rdquo; form.</li><li>Alternative providers can also be used, but it requires a little more work.</li></ul></li><li>Purchase an SSL certificate for your domain.<ul><li>This can be done with <a href=https://aws.amazon.com/certificate-manager/>AWS Certificate Manager</a></li><li>or an external certificate provider, often it can be done with the same company that provided your domain registration. Use the &ldquo;Import a certificate&rdquo; button to register your certificate with AWS.</li></ul></li><li>Use the &ldquo;Create distribution&rdquo; button on the CloudFront console to attach your registered domain to the s3 bucket that hosts the admin portal.<ul><li>the only things that need to be changed from the defaults are<ul><li>&ldquo;Origin domain&rdquo; - this should be the domain that was originally generated for your admin portal.
eg: <em>janelia-hortacloudwebapp-janeliahortacloudwebadmi-yefcny29t8n6.s3-website-us-east-1.amazonaws.com</em></li><li>&ldquo;Viewer protocol policy&rdquo; - Change this to &ldquo;Redirect HTTP to HTTPS&rdquo;</li><li>&ldquo;Custom SSL certificate&rdquo; - Select the certificate that you registered with AWS Certificate Manager</li></ul></li><li>Finally, click the &ldquo;Create distribution&rdquo; button.</li></ul></li></ul><h2 id=uninstalling-hortacloud-services>Uninstalling HortaCloud services</h2><p>To completely uninstall the application run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run destroy -- -u
</span></span></code></pre></div><p>The command will uninstall all stacks including the user logins (Cognito) stack.</p><p>Note in the previous <a href=#Upgrading_HortaCloud_services_to_AWS>system upgrade section</a> that an upgrade typically does not require removing and recreating the user pool stack.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=troubleshooting-client-app-installation>Troubleshooting client app installation</h3><p>If the client app installation fails for any reason, before you attempt the install again you must remove everything that was installed by the install script. Uninstall all applications installed with scoop and remove the &lsquo;C:\apps&rsquo; folder. To do that run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000>scoop</span> <span style=color:#000>uninstall</span> <span style=color:#000>scoop</span>
</span></span><span style=display:flex><span><span style=color:#204a87>del </span><span style=color:#000>c:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>apps</span>
</span></span></code></pre></div><p>When prompted whether you really want to uninstall everything, select &ldquo;yes&rdquo; or &ldquo;all&rdquo;.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-47be1a16b5df5bb00564696755d43828>3.1.3 - Backup & Restore</h1><div class=lead>How to backup your HortaCloud data</div><h2 id=system-backup>System backup</h2><p>The system can be configured to take nightly backups. All it is needed is to specify a writeable bucket (<code>HORTA_BACKUP_BUCKET</code>) that will hold the backups. You can also specify the base prefix for the backups using <code>HORTA_BACKUP_FOLDER</code>. If this is not specified the prefix will default to &ldquo;/hortacloud/backups&rdquo;.</p><p>Currently the backup contains the Cognito users and the Mongo database (user-generated metadata and tracing data). Each backup will be stored in a timestamp (with format &ldquo;yyyyMMddHHmmss&rdquo;) folder under the base backup prefix. The location of the backups will be <code>s3://&lt;backup_bucket>/&lt;backup_folder_prefix>/&lt;timestamp>/jacs</code> for the database and <code>s3://&lt;backup_bucket>/&lt;backup_folder_prefix>/&lt;timestamp>/cognito</code> for cognito users.</p><p>The backup is configured as a cron job that runs daily at 3 AM local time on the EC2 host on which the backend services run.</p><h2 id=system-restore>System restore</h2><p>If system backups are available, the sample and tracing data can be restored by specifying a specified backup bucket (<code>HORTA_RESTORE_BUCKET</code>) and prefix (<code>HORTA_RESTORE_FOLDER</code>) which typically was created by the nightly backup job.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e807886fdd82accb7b13ffd06c600de7>3.1.4 - Upgrading</h1><div class=lead>Upgrading to a new version of HortaCloud</div><p>There are two ways to upgrade to a new version of the code: <a href=#full-upgrade>Full Upgrade</a> and <a href=#incremental-upgrade>Incremental Upgrade</a>.</p><h2 id=full-upgrade>Full Upgrade</h2><p>This method backs up all of the data, removes the existing HortaCloud stack, installs a new version from scratch, and restores the data. This is currently the most automated way to upgrade, and requires the least amount of effort.</p><h3 id=backup-your-data>Backup your data</h3><p>First, ensure that you have a recent data backup. If you have not <a href=../backups>configured backups</a>, do that first. For most upgrades, you only need to check if a backup for the JACS Mongo database exists. Typically this is located at <code>s3://&lt;HORTA_BACKUP_BUCKET value>/&lt;HORTA_BACKUP_FOLDER value>/&lt;timestamp>/jacs</code></p><h3 id=remove-hortacloud-environment>Remove HortaCloud environment</h3><p>To remove the current HortaCloud environment run this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run destroy
</span></span></code></pre></div><p>This command will uninstall the frontend and the backend AWS Cloudformation stacks, i.e., Admin, Appstream and JACS stacks, but it will not uninstall Cognito stack, so no user accounts will be removed.</p><h3 id=deploy-new-version-of-hortacloud>Deploy new version of HortaCloud</h3><p>The next step is to upgrade the local git repo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git pull
</span></span></code></pre></div><p>You should also check out a specific version tag that you want to deploy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git checkout &lt;version&gt;
</span></span></code></pre></div><p>In order to restore the database from an existing backup make sure the following properties are set:</p><pre tabindex=0><code>NEW_HORTA_ENVIRONMENT=false
HORTA_RESTORE_BUCKET=&lt;backup bucket name&gt;
HORTA_RESTORE_FOLDER=&#34;/hortacloud/backups/latest&#34;
</code></pre><p>HORTA_RESTORE_BUCKET is the name of the backup bucket and HORTA_RESTORE_FOLDER must reference the parent prefix containing the &lsquo;jacs&rsquo; folder - the location of the actual mongo backup. Typically the backup job creates a &ldquo;softlink&rdquo; - &ldquo;/hortacloud/backups/latest&rdquo; so if you simply set the restore folder to that it should pick up the latest backup. If the backup was a manual backup or you need to restore to a previous date set the restore folder to that folder. For example setting <code>HORTA_RESTORE_FOLDER=/hortacloud/backups/20220609030001</code> will restore the database to the content saved on Jun 9, 2022.</p><p>NEW_HORTA_ENVIRONMENT must be set to false so that we don&rsquo;t try to create another admin user which may clash with the one restored from the backup.</p><p>After setting these properties you can proceed with the actual deploy procedure which will only install the backend and the frontend stack (skipping any Cognito installation):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy
</span></span></code></pre></div><p>From here on, this approach is identical with the initial deployment, with the only exception that data and users should already exist once the backend stack is fully deployed.</p><p>After you start the deploy command, follow the instructions you see on the screen which will prompt you when you need to setup the AppStream Builder exactly as it is described in the <a href=#workstation-app-installation>Workstation app-installation section</a></p><p>If somehow you need to recreate the user login accounts because you inadvertently removed the Cognito stack as well (e.g. using <code>-u</code> flag) you can restore all the accounts from a previous backup using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run deploy -- -u -r -b &lt;backup bucket&gt; -f hortacloud/backups/manual-backup/cognito
</span></span></code></pre></div><p>The folder parameter must point to the actual cognito prefix, where &lsquo;users.json&rsquo; and &lsquo;groups.json&rsquo; are located</p><h2 id=incremental-upgrade>Incremental Upgrade</h2><p>Incremental approach requires more manual steps, but it does not require any data restore. It basically removes only the frontend stacks, i.e. Appstream and Admin App, and it requires a manual update of the backend stack and the workstation.</p><p>The steps for the incremental approach are the following:</p><ul><li><p>Remove only the frontend stacks:
<code>npm run destroy -- -b</code></p></li><li><p>From the AWS console connect to the EC2 instance (<code>&lt;ORG>-hc-jacs-node-&lt;STAGE></code>) running the JACS stack using the &ldquo;Session Manager&rdquo;. To be more specific, from the EC2 instances page, select the instance <code>&lt;ORG>-hc-jacs-node-&lt;STAGE></code> and click on the &ldquo;Connect&rdquo; button. This will take you to the instance page, and then from there select the &ldquo;Session Manager&rsquo; tab and click the &ldquo;Connect&rdquo; button again. The &ldquo;Connect&rdquo; button should be enabled - if it&rsquo;s not there either was a problem with the deployment or there might be a problem with the instance itself.</p></li><li><p>Once connected run the following commands</p><pre tabindex=0><code>cd /opt/jacs/deploy
./manage.sh compose down
sudo git pull origin master
sudo git checkout &lt;version&gt;
./manage.sh compose up -d
</code></pre></li><li><p>Start AppStream builder (<code>&lt;ORG>-hc-image-builder-&lt;STAGE></code>)</p></li><li><p>Connect as Administrator</p></li><li><p>Check that &lsquo;reinstallwsonly.ps1&rsquo; script is available, in the Admin&rsquo;s home directory. If not copy it from the application repo or just create it like the other install scripts, (&lsquo;installcmd.ps1&rsquo; and &lsquo;createappimage.ps1&rsquo;) were created on the initial deployment.</p></li><li><p>Run the reinstallwssonly.ps1 script:</p><pre tabindex=0><code>.\reinstallwssonly.ps1 &lt;IP of host running JACS stack&gt;
</code></pre><p>The IP of the host running JACS is the same used for initial run of &lsquo;installcmd.ps1&rsquo; and it can be found from the AWS console.</p></li><li><p>Try out the workstation application to make sure it works</p><pre tabindex=0><code>C:\apps\runJaneliaWorkstation.ps1
</code></pre></li><li><p>Make sure you have the latest &lsquo;createappimage.ps1&rsquo; script from the application git repository. If you don&rsquo;t copy the latest script that supports &lsquo;&ndash;skip-registration&rsquo; flag.</p></li><li><p>Start the script for creating the AppStream image but skip the application registration: <code>.\createappimage.ps1 --skip-registration</code></p></li><li><p>Reinstall the frontend stacks</p><pre tabindex=0><code>npm run deploy -- --skip-vpc
</code></pre><p>If no changes were made to the code AWS CDK will only update the missing stacks, leaving JACS stack as it was since it practically has not been changed from AWS&rsquo; perspective</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-758c43e554607493c78a37aa827034b2>3.1.5 - Data Import</h1><div class=lead>How to get image data into the system</div><h3 id=adding-the-mouselight-open-data>Adding the MouseLight Open Data</h3><p>The MouseLight project at Janelia has made available the complete imagery and neuron tracing annotations for its published data sets on the <a href=https://registry.opendata.aws/janelia-mouselight/>AWS Open Data Registry</a>.</p><p>You can easily make these available in your own HortaCloud instance by <a href=/docs/user_manual/synchronized_folders/>creating a Synchronized Folder</a> which points to <code>/s3data/janelia-mouselight-data</code>.</p><h3 id=adding-a-single-volume>Adding a single volume</h3><p>A Horta Sample is an object representing a single 3D volume that can be visualized and traced with Horta.</p><p>If you already have the HortaKTX format data in your mounted S3 buckets, select <strong>File</strong> → <strong>New</strong> → <strong>Horta Sample</strong>, and then set &ldquo;Sample Name&rdquo; to <code>&lt;sampleDirectoryName></code> and &ldquo;Path to Render Folder&rdquo; as <code>/s3data/&lt;bucketName>/&lt;sampleDirectoryName></code>.</p><p>Open the Data Explorer (<strong>Window</strong> → <strong>Core</strong> → <strong>Data Explorer</strong>) and navigate to Home, then &ldquo;3D RawTile Microscope Samples&rdquo;, and your sample name. Right-click the sample and choose &ldquo;Open in Horta&rdquo;. This will open the Horta Panel and then from the Horta Panel you have options to create a workspace or to open the 2D or the 3D volume viewer.</p><h3 id=converting-your-data>Converting your data</h3><p>If your data has not been converted into HortaKTX format, you can use the <a href=https://github.com/JaneliaSciComp/hortacloud-importer>HortaCloud Data Importer</a> to convert it. This tool supports many common image formats, and can be easily extended in Python to support your favorite format.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0941c9f4c254e615d6587436cb91b5f6>3.1.6 - Troubleshooting</h1><div class=lead>Troubleshooting HortaCloud services</div><h2 id=no-user-can-login-to-the-workstation>No user can login to the workstation</h2><p>We have seen this behavior if the &ldquo;/data&rdquo; volume ran out of space. You can check this by connecting to the EC2 instance running the JACS stack and running <code>df -h /data</code>.</p><p>If the disk is full you, you can try to find anything that could be removed but if the limit was reached because the size your data you really have to resize the volume. The steps to resize an EBS volume can be found in the AWS documentation. First run <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/requesting-ebs-volume-modifications.html>the instructions to increase the size of and EBS volume</a> and then <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html>the instructions that make the entire new disk space available to the EC2 instance</a></p><p>If users still cannot use the workstation for tracing, after the <code>/data</code> volume was resized, and there is plenty of disk space available, the reason might be that RabbitMQ failed to start properly, which may happen if RabbitMQ runs out of disk space. Users can also inspect the log from the workstation and look for errors like:</p><pre tabindex=0><code>java.lang.IllegalStateException: Message connection could not be opened to host &lt;hostip&gt; after &lt;n&gt; attempts
</code></pre><p>If this is case check the size of the file <code>/data/db/rabbitmq/jacs/mnesia/rabbit\@jacs-rabbit/msg_stores/vhosts/628WB79CIFDYO9LJI6DKMI09L/recovery.dets</code> If the file exists and its size is 0 then remove the file and restart the entire stack.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e2af44929e77d40d5c3af05dfa4f6721>3.2 - Bare metal</h1><div class=lead>Learn how to deploy a Horta instance on your own servers</div><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>This deployment method is no longer supported as we are shifting our development resources to the cloud deployment. You are on your own!</div><p>The recommended way to deploy HortaCloud is to use <a href=aws>Amazon Web Services (AWS)</a>, but you can also deploy the Horta services locally on your own client/server machines.</p><p>Using Docker Swarm, you can choose to deploy on two or three servers. The primary benefit of using three servers is that the MongoDB cluster will have a complete replica set for high availability.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ad51fc64a31547dbb98cadc6e22fdf62>3.2.1 - Two-server deployment</h1><div class=lead>How to deploy Horta to a pair of servers</div><p>This document describes the canonical two-server Janelia Workstation deployment for supporting neuron tracing for the <a href=https://www.janelia.org/project-team/mouselight>MouseLight project</a> at the Janelia Research Campus and other research institutions. This deployment uses Docker Swarm to orchestrate prebuilt containers available on Docker Hub.</p><h2 id=deployment-diagram>Deployment Diagram</h2><a href=../TwoServerDeployment.png><img src=../TwoServerDeployment.png class="rounded mx-auto" style=max-width:700px alt="two-server deployment diagram"></a><h2 id=hardware-setup>Hardware Setup</h2><p>The JACS backend consists of several services which need to be deployed on server hardware. We have tested the following configuration:</p><ul><li>Two Dell PowerEdge R740XD Servers<ul><li>Each server has 40 cores (e.g. Intel Xeon Gold 6148 2.4G)</li><li>Each server has 192 GB of memory</li><li>The hard drives are configured as follows:<ul><li>2 x 200GB SSD in RAID1 - Operating system (/)</li><li>2 x 960GB SSD in RAID1 - Databases, user preferences, etc. (/opt)</li><li>12 x 10TB in RAID6 - Image files (/data)</li></ul></li></ul></li></ul><p>The rest of this guide assumes that you have two server hosts dedicated to deploying this system, which are configured as listed above. They will be referred to as <strong>HOST1</strong> and <strong>HOST2</strong>.</p><p>This two-server deployment can support 5-10 concurrent users. We use the following configuration for client machines:</p><ul><li>Dell Precision 5820 Tower<ul><li>Minimum of 8 cores (e.g. Intel Xeon W-2145 3.7GHz)</li><li>128 GB of memory</li><li>Nvidia GTX1080Ti 11GB (reference card, blower fan style)<ul><li>Other similar cards will work fine: GTX1070, GTX1080, RTX2080</li></ul></li><li>Windows 10</li></ul></li></ul><h2 id=install-oracle-linux-8>Install Oracle Linux 8</h2><p>The backend software runs on any operating system which supports Docker. However, Oracle Linux is used at Janelia and has been extensively tested with this software. Therefore, we recommend installing the latest version of Oracle Linux 8.</p><h2 id=install-docker>Install Docker</h2><p>To install Docker and Docker Compose on Oracle Linux 8, follow <a href=../installingdocker>these instructions</a>.</p><h2 id=setup-docker-swarm>Setup Docker Swarm</h2><p>On <strong>HOST1</strong>, bring up swarm as a manager node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker swarm init
</span></span></code></pre></div><p>On <strong>HOST2</strong>, copy and paste the output of the previous command to join the swarm as a worker.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker swarm join --token ...
</span></span></code></pre></div><p>All further commands should be executed on <strong>HOST1</strong>, i.e. the master node. One final step is to label the nodes. Each node needs the &ldquo;jacs=true&rdquo; label, as well as &ldquo;jacs_name=nodeX&rdquo;.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs_name</span><span style=color:#ce5c00;font-weight:700>=</span>node1 <span style=color:#204a87;font-weight:700>$(</span>docker node ls -f <span style=color:#4e9a06>&#34;role=manager&#34;</span> --format <span style=color:#4e9a06>&#34;{{.ID}}&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs_name</span><span style=color:#ce5c00;font-weight:700>=</span>node2 <span style=color:#204a87;font-weight:700>$(</span>docker node ls -f <span style=color:#4e9a06>&#34;role=worker&#34;</span> --format <span style=color:#4e9a06>&#34;{{.ID}}&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#204a87;font-weight:700>$(</span>docker node ls -f <span style=color:#4e9a06>&#34;role=manager&#34;</span> --format <span style=color:#4e9a06>&#34;{{.ID}}&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#204a87;font-weight:700>$(</span>docker node ls -f <span style=color:#4e9a06>&#34;role=worker&#34;</span> --format <span style=color:#4e9a06>&#34;{{.ID}}&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Finally, you can run this command to ensure that both nodes are up and in Ready status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker node ls
</span></span></code></pre></div><h2 id=download-the-installer>Download the installer</h2><p>Download the installer and extract it onto the master node, as follows. <code>VERSION</code> should be set to the <a href=https://github.com/JaneliaSciComp/jacs-cm/releases>latest stable version</a> available on the releases page.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;version_number_here&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /opt
</span></span><span style=display:flex><span>sudo mkdir deploy
</span></span><span style=display:flex><span>sudo chown <span style=color:#000>$USER</span> deploy
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> deploy
</span></span><span style=display:flex><span>curl https://codeload.github.com/JaneliaSciComp/jacs-cm/tar.gz/<span style=color:#000>$VERSION</span> <span style=color:#000;font-weight:700>|</span> tar xvz
</span></span><span style=display:flex><span>ln -s jacs-cm-<span style=color:#000>$VERSION</span> jacs-cm
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> jacs-cm
</span></span></code></pre></div><h2 id=configure-the-system>Configure The System</h2><p>Next, create a <code>.env.config</code> file inside the intaller directory. This file defines the environment (usernames, passwords, etc.) You can copy the template to get started:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp .env.template .env.config
</span></span><span style=display:flex><span>vi .env.config
</span></span></code></pre></div><p>At minimum, you must customize the following:</p><ol><li>Set <code>DEPLOYMENT</code> to <strong>mouselight</strong>.</li><li>Ensure that <code>REDUNDANT_STORAGE</code> and <code>NON_REDUNDANT_STORAGE</code> point to the disk mounts you used during the operating system installation. Alternatively, you can make symbolic links so that the default paths point to your mounted disks.</li><li>Set <code>HOST1</code> and <code>HOST2</code> to the two servers you are deploying on. Use fully-qualified hostnames here &ndash; they should match the SSL certificate you intend to use.</li><li>Fill in all the unset passwords with >8 character passwords. You should only use alphanumeric characters, special characters are not currently supported.</li><li>Generate 32-byte secret keys for JWT_SECRET_KEY, MONGODB_SECRET_KEY, JACS_API_KEY, and JADE_API_KEY.</li><li>If you want to enable automated error reporting from the Workstation client, set <code>MAIL_SERVER</code> to an SMTP server and port, e.g. smtp.my.org:25.</li></ol><h2 id=deploy-services>Deploy Services</h2><p>Now you can follow the <a href=../swarmdeployment>Swarm Deployment instructions</a> to actually deploy the software.</p><h2 id=import-imagery>Import Imagery</h2><p>If you have your own imagery, you will need to <a href=../dataimport>convert it</a> before importing.</p><p>Each brain image is referred to as a &ldquo;sample&rdquo;. You should place each sample in <code>$DATA_DIR/jacsstorage/samples</code> on one of the servers. If you place the sample on the first server, in <code>$DATA_DIR/jacsstorage/samples/&lt;sampleDirectoryName></code>, then in the Workstation you will refer to the sample as <code>/jade1/&lt;sampleDirectoryName></code>.</p><p>As a side note if you use &rsquo;lvDataImport&rsquo; service to generate the imagery, the service does not use JADE to persist the data. So if you need the data to be on a storage that is only accessible on certain hosts, JACS must run on that host in order to be able to write the data to the corresponding location. If that is not an option you can generate the data to a temporary location then move it to the intended sample directory.</p><p>In the Workstation, select <strong>File</strong> → <strong>New</strong> → <strong>Horta Sample</strong>, and then set &ldquo;Sample Name&rdquo; to <code>&lt;sampleDirectoryName></code> and &ldquo;Path to Render Folder&rdquo; as <code>/jade1/&lt;sampleDirectoryName></code>.</p><p>Open the Data Explorer (<strong>Window</strong> → <strong>Core</strong> → <strong>Data Explorer</strong>) and navigate to Home, then &ldquo;3D RawTile Microscope Samples&rdquo;, and your sample name. Right-click the sample and choose &ldquo;Open in Large Volume Viewer&rdquo;. The 2D imagery should load into the middle panel. You should be able to right-click anywhere on the image and select &ldquo;Navigate to This Location in Horta (channel 1)&rdquo;, to load the 3D imagery.</p><h2 id=find-more-information>Find More Information</h2><p>This concludes the MouseLight Workstation installation procedure. Further information on using the tools can be found in the <a href=../../../user_manual>User Manual</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a6700f837d490c2f8cce74416e4c5a0>3.2.2 - Three-server deployment</h1><div class=lead>How to deploy Horta to three servers</div><p>This document describes the full three-server Janelia Workstation deployment for supporting both FlyLight and MouseLight at Janelia Research Campus. This deployment uses Docker Swarm to orchestrate containers available on Docker Hub.</p><p>Multiple <em>environments</em> are supported with this deployment:</p><ul><li><strong>prod</strong></li><li><strong>dev</strong></li></ul><h2 id=deployment-diagram>Deployment Diagram</h2><a href=../FullDeployment.png><img src=../FullDeployment.png class="rounded mx-auto" style=max-width:700px alt="three-server deployment diagram"></a><h2 id=hardware-setup>Hardware Setup</h2><p>This guide assumes that you have three high-end servers which can be dedicated to running Docker Swarm. We use 40-core servers with at least 192 GB of RAM. YMMV.</p><p>We&rsquo;ll refer to the three deployment hosts as <strong>HOST1</strong>, <strong>HOST2</strong>, and <strong>HOST3</strong>.</p><p>Note that an additional server or VM is necessary to run the JACS Async Services outside of Docker, if you are planning to submit image processing jobs to an HPC cluster, such as with the Image Processing Pipeline (IPP).</p><h2 id=install-oracle-linux-8>Install Oracle Linux 8</h2><p>The backend software should run on any operating system which supports Docker. However, Oracle Linux is used at Janelia and has been extensively tested with this software. Therefore, we recommend installing the latest version of Oracle Linux 8. Previously, we used Scientific Linux 7 and that is also known well although it&rsquo;s no longer supported.</p><h2 id=install-docker>Install Docker</h2><p>To install Docker and Docker Compose on Oracle Linux 8, follow <a href=../installingdockerol8>these instructions</a>.</p><h2 id=setup-docker-swarm>Setup Docker Swarm</h2><p>On <strong>HOST1</strong>, bring up swarm as a manager node, and give it a label:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker swarm init
</span></span></code></pre></div><p>On <strong>HOST2</strong> and <strong>HOST3</strong>, copy and paste the output of the previous command to join the swarm as a worker.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker swarm join --token ...
</span></span></code></pre></div><p>All further commands should be executed on <strong>HOST1</strong>, i.e. the master node. One final step is to label the nodes. Each node needs the &ldquo;jacs=true&rdquo; label, as well as &ldquo;jacs_name=nodeX&rdquo;. You can find out the node ids by running <code>docker node ls</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs_name</span><span style=color:#ce5c00;font-weight:700>=</span>node1 &lt;id of HOST1&gt;
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs_name</span><span style=color:#ce5c00;font-weight:700>=</span>node2 &lt;id of HOST2&gt;
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs_name</span><span style=color:#ce5c00;font-weight:700>=</span>node3 &lt;id of HOST3&gt;
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> &lt;id of HOST1&gt;
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> &lt;id of HOST2&gt;
</span></span><span style=display:flex><span>docker node update --label-add <span style=color:#000>jacs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> &lt;id of HOST3&gt;
</span></span></code></pre></div><h2 id=download-the-installer>Download the installer</h2><p>Download the installer and extract it onto the master node, as follows. <code>VERSION</code> should be set to the <a href=https://github.com/JaneliaSciComp/jacs-cm/releases>latest stable version</a> available on the releases page.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;version_number_here&gt;
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /opt
</span></span><span style=display:flex><span>sudo mkdir deploy
</span></span><span style=display:flex><span>sudo chown <span style=color:#000>$USER</span> deploy
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> deploy
</span></span><span style=display:flex><span>curl https://codeload.github.com/JaneliaSciComp/jacs-cm/tar.gz/<span style=color:#000>$VERSION</span> <span style=color:#000;font-weight:700>|</span> tar xvz
</span></span><span style=display:flex><span>ln -s jacs-cm-<span style=color:#000>$VERSION</span> jacs-cm
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> jacs-cm
</span></span></code></pre></div><h2 id=configure-the-system>Configure The System</h2><p>Next, create a <code>.env.config</code> file inside the installer directory. This file defines the environment (usernames, passwords, etc.) You can copy the template to get started:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp .env.template .env.config
</span></span><span style=display:flex><span>vi .env.config
</span></span></code></pre></div><p>At minimum, you must customize the following:</p><ol><li>Ensure that <code>REDUNDANT_STORAGE</code> and <code>NON_REDUNDANT_STORAGE</code> point to the disk mounts available on the local systems. Alternatively, you can make symbolic links so that the default paths point to your mounted disks.</li><li>Set <code>HOST1</code>, <code>HOST2</code>, and <code>HOST3</code> to the servers you are deploying on. Use fully-qualified hostnames here &ndash; they should match the SSL certificate you intend to use. Do not use localhost or the loopback address (<code>127.0.0.1</code>). If you don&rsquo;t have a DNS name for the hosts, use the host&rsquo;s IP address.</li><li>Fill in all the unset passwords with >8 character passwords. You should only use alphanumeric characters, special characters are not currently supported.</li><li>Generate 32-byte secret keys for JWT_SECRET_KEY, MONGODB_SECRET_KEY and JADE_API_KEY. If JADE_API_KEY is not set jacs-sync service will not be able to register any Mouselight samples.</li><li>Set <code>JADE_AGENT_VOLUMES</code> to the volumes that you want to be created when you start the system - typically <code>jade1,jade2</code>, but these really depend on the volumes that you you setup in your jade service configuration.</li></ol><h2 id=enable-databases-optional>Enable Databases (optional)</h2><p>Currently, Janelia runs MongoDB outside of the Swarm, so they are commented out in the deployment. If you&rsquo;d like to run the databases as part of the swarm, edit the yaml files under ./deployments/jacs/ and uncomment the databases.</p><h2 id=deploy-services>Deploy Services</h2><p>Now you can follow the <a href=../swarmdeployment>Swarm Deployment instructions</a> to actually deploy the software.</p><h2 id=deploy-elk-for-monitoring>Deploy ELK for monitoring</h2><p>To deploy an ELK stack for monitoring follow <a href=../elkdeployment>ELK Deployment</a>.</p><h2 id=find-more-information>Find More Information</h2><p>This concludes the MouseLight Workstation installation procedure. Further information on using the tools can be found in the <a href=../../../user_manual>User Manual</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-52fa8f551b4259f2d27e1238963f5ab4>3.2.3 - Installing Docker</h1><div class=lead>How to install Docker on Oracle Linux 8</div><p>To install Docker on a server running Oracle Linux 8, some special configuration is needed. Much of this comes from the <a href=https://docs.docker.com/install/linux/docker-ce/centos/>official documentation</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>First, make sure that Docker isn’t already installed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum list installed <span style=color:#000;font-weight:700>|</span> grep docker
</span></span></code></pre></div><p>Remove any existing installations before proceeding.</p><p>Ensure that /opt (or whatever disk is to be used for Docker data) is formatted with the d_type option. You can find out like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ xfs_info /opt
</span></span><span style=display:flex><span>meta-data<span style=color:#ce5c00;font-weight:700>=</span>/dev/mapper/vg0-lv_opt <span style=color:#000>isize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>512</span>    <span style=color:#000>agcount</span><span style=color:#ce5c00;font-weight:700>=</span>4, <span style=color:#000>agsize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5701632</span> <span style=color:#000>blks</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>=</span>                       <span style=color:#000>sectsz</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span>  <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>=</span>2, <span style=color:#000>projid32bit</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>=</span>                       <span style=color:#000>crc</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>        <span style=color:#000>finobt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>spinodes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>data</span>     <span style=color:#ce5c00;font-weight:700>=</span>                       <span style=color:#000>bsize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span>   <span style=color:#000>blocks</span><span style=color:#ce5c00;font-weight:700>=</span>22806528, <span style=color:#000>imaxpct</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>25</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>=</span>                       <span style=color:#000>sunit</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#000>swidth</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> blks
</span></span><span style=display:flex><span><span style=color:#000>naming</span>   <span style=color:#ce5c00;font-weight:700>=</span>version <span style=color:#0000cf;font-weight:700>2</span>              <span style=color:#000>bsize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span>   ascii-ci<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>ftype</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000>log</span>      <span style=color:#ce5c00;font-weight:700>=</span>internal               <span style=color:#000>bsize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span>   <span style=color:#000>blocks</span><span style=color:#ce5c00;font-weight:700>=</span>11136, <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>2</span>
</span></span><span style=display:flex><span>         <span style=color:#ce5c00;font-weight:700>=</span>                       <span style=color:#000>sectsz</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span>  <span style=color:#000>sunit</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> blks, lazy-count<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000>realtime</span> <span style=color:#ce5c00;font-weight:700>=</span>none                   <span style=color:#000>extsz</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>4096</span>   <span style=color:#000>blocks</span><span style=color:#ce5c00;font-weight:700>=</span>0, <span style=color:#000>rtextents</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>If the above says ftype=0, then the filesystem will need to be recreated (<a href=https://linuxer.pro/2017/03/what-is-d_type-and-why-docker-overlayfs-need-it/>reference</a>).</p><h2 id=installing-docker>Installing Docker</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum install -y yum-utils
</span></span><span style=display:flex><span>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style=display:flex><span>sudo yum install -y docker-ce
</span></span></code></pre></div><p>If this fails with error messages like <code>package containerd.io-1.4.3-3.2.el8.x86_64 conflicts with runc provided by runc</code> then you may have conflicting packages installed already. Try removing them like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum erase podman buildah
</span></span></code></pre></div><h2 id=post-install-configuration>Post Install Configuration</h2><p>To avoid running out of space on the root partition, you should configure docker to point to /opt/docker (<a href=https://www.rb-associates.co.uk/blog/move-var-lib-docker-to-another-directory/>reference</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /opt/docker
</span></span><span style=display:flex><span>sudo chown root:root /opt/docker
</span></span><span style=display:flex><span>sudo chmod <span style=color:#0000cf;font-weight:700>701</span> /opt/docker
</span></span></code></pre></div><p>Next, configure Docker to use the overlay2 storage driver (<a href=https://www.projectatomic.io/blog/2015/06/notes-on-fedora-centos-and-docker-storage-drivers/>reference</a>).</p><p>Create a file at /etc/docker/daemon.json with this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;data-root&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;/opt/docker&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;storage-driver&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;overlay2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>You should also create a local user called &ldquo;docker-nobody&rdquo; with UID 4444, which can be used for running containers without root.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo groupadd -g <span style=color:#0000cf;font-weight:700>4444</span> docker-nobody
</span></span><span style=display:flex><span>sudo useradd --uid <span style=color:#0000cf;font-weight:700>4444</span> --gid <span style=color:#0000cf;font-weight:700>4444</span> --shell /sbin/nologin docker-nobody
</span></span></code></pre></div><p>Finally, you can start Docker:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl <span style=color:#204a87>enable</span> docker
</span></span><span style=display:flex><span>sudo systemctl start docker
</span></span></code></pre></div><h2 id=installing-docker-compose>Installing Docker Compose</h2><p>You&rsquo;ll also need to install the Docker Compose executable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo curl -L <span style=color:#4e9a06>&#34;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-</span><span style=color:#204a87;font-weight:700>$(</span>uname -s<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>-</span><span style=color:#204a87;font-weight:700>$(</span>uname -m<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><p>Note that there are newer versions of the Docker Compose, but they have bugs that prevent them from working with our scripts. Please use the version above to ensure compatibility.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8c5f034c618e5b4f6fbabf8e6e9865e1>3.2.4 - Deploying JACS</h1><div class=lead>Deploying the JACS services using Docker Swarm</div><p>This document assumes that you have downloaded and configured the installer according to one of the deployment guides.</p><p>The following steps are common to all Docker Swarm deployments of the Workstation.</p><h2 id=initialize-filesystems>Initialize Filesystems</h2><p>The first step is to initialize the filesystems on all your Swarm systems. On each server, ensure that your <code>REDUNDANT_STORAGE</code> (default: /opt/jacs), <code>NON_REDUNDANT_STORAGE</code> (default: /data) directories exist and can be written to by your UNAME:GNAME user (default: docker-nobody).</p><p>Then, run the Swarm-based initialization procedure from <strong>HOST1</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh init-filesystems
</span></span></code></pre></div><p>You can manually edit the files found in <code>CONFIG_DIR</code> to further customize the installation.</p><p>Once the initialization completes you can just run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh stop
</span></span></code></pre></div><p>Also it is a good idea to stop the initialization stack if anything goes wrong before you try it again.</p><h3 id=ssl-certificates>SSL Certificates</h3><p>At this point, <strong>it is strongly recommended is to replace the self-signed certificates</strong> in <code>$CONFIG_DIR/certs/*</code> on each server with your own certificates signed by a Certificate Authority:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>. .env
</span></span><span style=display:flex><span>sudo cp /path/to/your/certs/cert.<span style=color:#ce5c00;font-weight:700>{</span>crt,key<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>$CONFIG_DIR</span>/certs/
</span></span><span style=display:flex><span>sudo chown docker-nobody:docker-nobody <span style=color:#000>$CONFIG_DIR</span>/certs/*
</span></span></code></pre></div><p>If you continue with the self-signed certificates, you will need to <a href=../selfsignedcerts>set up the trust chain</a> for them later.</p><h3 id=external-authentication>External Authentication</h3><p>The JACS system has its own self-contained authentication system, and can manage users and passwords internally.</p><p>If you&rsquo;d prefer that users authenticate against your existing LDAP or ActiveDirectory server, edit <code>$CONFIG_DIR/jacs-sync/jacs.properties</code> and add these properties:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>LDAP.URL</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.SearchBase</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.SearchFilter</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.BindDN</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.BindCredentials</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span></code></pre></div><p>The URL should point to your authentication server. The SearchBase is part of a distinguished name to search, something like &ldquo;ou=People,dc=yourorg,dc=org&rdquo;. The SearchFilter is the attribute to search on, something like &ldquo;(cn={{username}})&rdquo;. BindDN and BindCredentials defines the distinguished name and password for a service user that can access user information like full names and emails.</p><h2 id=start-all-containers>Start All Containers</h2><p>Next, start up all of the service containers. The parameter to the start command specifies the environment to use. The <strong>dev</strong> environment uses containers tagged as <em>latest</em> and updates them automatically when they change. The <strong>prod</strong> deployment uses a frozen set of production versions. When in doubt, use the <strong>prod</strong> deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh start
</span></span></code></pre></div><p>It may take a minute for the containers to spin up. You can monitor the progress with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh status
</span></span></code></pre></div><p>At this stage, some of the services may not start because they depend on the databases. The next step will take care of that.</p><h2 id=initialize-databases>Initialize Databases</h2><p>Now you are ready to initalize the databases:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh init-databases
</span></span></code></pre></div><p>It&rsquo;s normal to see the &ldquo;Unable to reach primary for set rsJacs&rdquo; error repeated until the Mongo replica set converges on healthiness. After a few seconds, you should see a message &ldquo;Databases have been initialized&rdquo; and the process will exit successfully.</p><p>You can validate the databases as follows:</p><ul><li>Verify that you can connect to the Mongo instance using <code>./manage.sh mongo</code>, and run <code>show tables</code></li><li>Connect to the RabbitMQ server at http://<strong>HOST1</strong>:15672 and log in with your <code>RABBITMQ_USER</code>/<code>RABBITMQ_PASSWORD</code></li></ul><h2 id=restart-services>Restart Services</h2><p>Bounce the stack so that everything reconnects to the databases:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh stop
</span></span><span style=display:flex><span>./manage.sh start
</span></span></code></pre></div><p>Now you shoult wait for all the services to start. You can continue to monitor the progress with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh status
</span></span></code></pre></div><p>If any container failed to start up, it will show up with &ldquo;0/N&rdquo; replicas, and it will need to be investigated before moving further. You can view the corresponding error by specifying the swarm service name, as reported by the status command. For example, if jacs_jade-agent2 fails to start, you would type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh status jacs_jade-agent2
</span></span></code></pre></div><h2 id=verify-functionality>Verify Functionality</h2><p>You can verify the Authentication Service is working as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh login
</span></span></code></pre></div><p>You should be able to log in with the default admin account (root/root), or any LDAP/AD account if you&rsquo;ve configured external authentication. This will return a JWT that can be used on subsequent requests.</p><p>If you run into any problems, these <a href=../troubleshooting>troubleshooting tips</a> may help.</p><h2 id=manage-services>Manage Services</h2><p>As long as your Docker daemon is configured to restart on boot, all of the Swarm services will also restart automatically when the server is rebooted.</p><p>If you want to remove all the services from the Swarm and do a clean restart of everything, you can use this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh stop
</span></span></code></pre></div><p>To pull and redeploy the latest image for a single service, e.g. workstation-site:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh restart jacs_workstation-site
</span></span></code></pre></div><h2 id=configure-crontabs>Configure Crontabs</h2><p>The following crontab entries should be configured in order to perform periodic maintenance automatically. It&rsquo;s easiest to install the crontabs on the docker-nobody account:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo crontab -u docker-nobody -e
</span></span></code></pre></div><p>Database maintenance refreshes indexes and updates entities permissions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>2</span> * * * /opt/deploy/jacs-cm/manage.sh dbMaintenance group:admin -refreshIndexes -refreshPermissions
</span></span></code></pre></div><p>SOLR index refresh (if using SOLR):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>3</span> * * * /opt/deploy/jacs-cm/manage.sh rebuildSolrIndex
</span></span></code></pre></div><p>Database backups (if using containerized databases):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>4</span> * * * /opt/deploy/jacs-cm/manage.sh backup mongo
</span></span></code></pre></div><h2 id=install-the-workstation-client>Install The Workstation Client</h2><p>Now that the services are all running, you can navigate to <a href=https://HOST1>https://HOST1</a> in a web browser on your client machine, and download the Workstation client. Follow the installer wizard, using the default options, then launch the Workstation.</p><p>If you are using the default self-signed certificate, you will need to take some extra steps to <a href=../selfsignedcerts>install it on the client</a>.</p><p>If you are using LDAP/AD integration, you should be able to log in with your normal user/password. If you are using the Workstation&rsquo;s internal user management, you must first login as user root (password: root), and then select <strong>Window</strong> → <strong>Core</strong> → <strong>Administrative GUI</strong> from the menus. Click &ldquo;View Users&rdquo;, then &ldquo;New User&rdquo; and create your first user. Add the user to all of the relevant groups, including MouseLight.</p><h2 id=optional-adding-nfs-storage>Optional: Adding NFS Storage</h2><p>If you have data on NFS, and those NFS drives can be mounted on the MouseLight hosts, that data can be made available to the Workstation.</p><p>First, create a file at deployments/mouselight/docker-swarm.prod.yml which looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3.7&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jade-agent1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/path/to/your/nfs:/path/to/your/nfs:ro,shared</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jade-agent2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/path/to/your/nfs:/path/to/your/nfs:ro,shared</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This will expose the path to both JADE agent containers. Now you need to configure the JADE agents to serve this data. On both hosts, edit /opt/jacs/config/jade/config.properties and add the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>StorageVolume.mouseLightNFS.RootDir</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/path/to/your/nfs</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>StorageVolume.mouseLightNFS.VirtualPath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/path/to/your/nfs</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>StorageVolume.mouseLightNFS.Shared</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>StorageVolume.mouseLightNFS.Tags</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>mousebrain,light</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>StorageVolume.mouseLightNFS.VolumePermissions</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>READ</span>
</span></span></code></pre></div><p>You can use any name you want instead of mouseLightNFS. Then you should add this name to StorageAgent.BootstrappedVolumes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>StorageAgent.BootstrappedVolumes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>jade1,mouseLightNFS</span>
</span></span></code></pre></div><p>You will need to bounce the service stack to pick up these changes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a0d43dee0f682d26aeeced42f6f523b6>3.2.5 - Deploying ELK</h1><div class=lead>How to deploy ELK for log monitoring</div><p>Currently ELK is only available in a swarm deployment because of how the ELK stack is configured.</p><p>Most of the set up necessary for ELK - configuration files and/or data directories - is already done as part of filesystem initialization performed while executing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh init-filesystems
</span></span></code></pre></div><p>The current ELK data directories are created on <code>/data/</code> directory so this directory must exist.</p><p>One manual step is to set the <code>vm.max_map_count</code> value required for running elasticsearch. This is done by adding <code>vm.max_map_count=262144</code> line to <code>/etc/sysctl.conf</code> and then run <code>sysctl -p</code> (typically this must be done as root)</p><p>After that deploying the elk stack for monitoring the application only requires starting with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh start-elk
</span></span></code></pre></div><p>The command to stop the monitoring is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh stop-elk
</span></span></code></pre></div><h2 id=import-data-from-an-old-stack>Import data from an old stack</h2><p>To import data from an old stack the old stack nodes must be whitelisted in the <code>ELK_WHITELIST</code> environment variable so that they can be accessible to the current cluster for importing indexes.</p><p>Some useful elasticsearch endpoints:</p><ul><li>List available indices</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://&lt;escoordinator&gt;:9200/_cat/indices
</span></span></code></pre></div><ul><li>Import an index from a remote cluster:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#000>remoteost</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$1</span>
</span></span><span style=display:flex><span><span style=color:#000>indexName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -H <span style=color:#4e9a06>&#39;Content-Type: application/json&#39;</span> -X POST http://e03u08.int.janelia.org:9200/_reindex -d <span style=color:#4e9a06>&#34;{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    \&#34;source\&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        \&#34;remote\&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            \&#34;host\&#34;: \&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>remoteHost</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:9200\&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        \&#34;index\&#34;: \&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>indexName</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        \&#34;query\&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            \&#34;match_all\&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    \&#34;dest\&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        \&#34;index\&#34;: \&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>indexName</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>\&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}&#34;</span>
</span></span></code></pre></div><ul><li>Export kibana objects</li></ul><p>Here&rsquo;s an example to export kibana visualizations but the command is identical for any one of [config, index-pattern, visualization, search, dashboard, url] - just set the appropriate type</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://&lt;oldkibanahost&gt;:5601/api/saved_objects/_export -H <span style=color:#4e9a06>&#39;kbn-xsrf: true&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     -H <span style=color:#4e9a06>&#39;Content-Type: application/json&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     -d <span style=color:#4e9a06>&#39;{&#34;type&#34;: &#34;visualization&#34; }&#39;</span> &gt; local/kibana-visualizations.ndjson
</span></span></code></pre></div><ul><li>To import</li></ul><p>Use the file generated by the above export command and run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST http://e03u06.int.janelia.org:5601/api/saved_objects/_import <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -H <span style=color:#4e9a06>&#39;kbn-xsrf: true&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --form <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>@local/kibana-visualizations.ndjson
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a8d56f9f9ba6cf350fea8d567173c3e0>3.2.6 - Self-signed Certificates</h1><div class=lead>Using self-signed server certificates</div><p>A self-signed certificate is automatically generated during the <code>init-filesystem</code> step of a jacs-cm installation. For production use, it is recommended that you replace this certificate with a real one. The self-signed certificate is less secure, and it requires some extra steps to get working.</p><p>In order to connect to <a href=https://HOST1>https://HOST1</a>, you need to accept the certificate in the browser. This differs by browser.</p><p>Then, in order to allow the Workstation to accept the certificate, it needs to be added to Java&rsquo;s keystore. For this, you will need the certificate on the desktop computer where you are running the Workstation. You can either export it from the browser, or copy it over from the server. On the server, it is located in <code>$CONFIG_DIR/certs/cert.crt</code>. Once you have the certificate, you can import it using Java&rsquo;s keytool.</p><h2 id=windows>Windows</h2><p>On Windows, click Start and type &ldquo;cmd&rdquo; to find the Command Prompt, then right-click it and select &ldquo;Run as administrator&rdquo;. You need to find out where your JVM is installed by looking under C:\Program Files\Zulu. Then, import the certificate. Here it&rsquo;s assumed the cert was saved to the current working directory:</p><pre tabindex=0><code>C:\&gt; &#34;C:\Program Files\Zulu\zulu-8\bin\keytool.exe&#34; -import -alias mouse1selfcert -file cert.crt -keystore &#34;C:\Program Files\Zulu\zulu-8\jre\lib\security\cacerts&#34; -keypass changeit -storepass changeit
</code></pre><p>The <strong>alias</strong> should be a descriptive name that will be used later if you want to remove or view the certificate. The password for the JVM keystore is actually &ldquo;changeit&rdquo;, so don&rsquo;t change the <strong>keypass</strong> or <strong>storepass</strong> values above.</p><h2 id=mac-or-linux>Mac or Linux</h2><p>First, you need to know where the JVM is located. You can use the same method that the Workstation uses to locate the JVM. This ensures you are modifying the correct one. Open a Terminal and type:</p><pre tabindex=0><code>export JDK_HOME=`/usr/libexec/java_home -v 1.8`
</code></pre><p>Now you can import the certificate into the keystore. Here it&rsquo;s assumed the cert was saved to the desktop:</p><pre tabindex=0><code>sudo keytool -import -v -trustcacerts -alias mouse1 -file ~/Desktop/cert.crt -keystore $JDK_HOME/jre/lib/security/cacerts -keypass changeit -storepass changeit
</code></pre><p>The <strong>alias</strong> should be a descriptive name that will be used later if you want to remove or view the certificate. The password for the JVM keystore is actually &ldquo;changeit&rdquo;, so don&rsquo;t change the <strong>keypass</strong> or <strong>storepass</strong> values above.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-92ef9d692f28e2663500b1b1f2e1e902>3.2.7 - Storage volumes</h1><div class=lead>Managing storage volumes on JADE</div><p>The Workstation/JACS system relies on JADE for its storage API.</p><h2 id=adding-a-new-storage-volume>Adding a new Storage Volume</h2><p><strong>Add bootstrap to the JADE configuration</strong></p><p>On HOST1, edit /opt/jacs/config/jade/config.properties and add a block for your new volume, for example:</p><pre tabindex=0><code>StorageVolume.s3data.RootDir=/s3data
StorageVolume.s3data.VirtualPath=/s3jade
StorageVolume.s3data.Shared=true
StorageVolume.s3data.Tags=aws,cloud
StorageVolume.s3data.VolumePermissions=READ,WRITE,DELETE
</code></pre><p>The properties configure the volume as follows:</p><ul><li>RootDir: defines the actual path to the data on disk</li><li>VirtualPath: optionally defines a virtual path which is mapped to the actual path</li><li>Shared: true if the volume should be accessible to all volumes</li><li>Tags: tags used by applications to find appropriate volumes</li><li>VolumePermissions: list of operations that JADE can execute (READ,WRITE,DELETE)</li></ul><p>Also add your volume to StorageAgent.BootstrappedVolumes, so that it will be created the next time the service is restarted.</p><p><strong>Mount the path into the containers</strong></p><p>Edit the compose/swarm files for your deployment and mount the volume path as a Docker volume. For example, if your <code>DEPLOYMENT</code> is jacs, and <code>STAGE</code> is dev, you must edit these two files:</p><p><code>deployments/jacs/docker-compose.dev.yml</code>
<code>deployments/jacs/docker-swarm.dev.yml</code></p><p>You should add your volume for all services <code>jade-agent&lt;N></code> which you want to service that volume.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jade-agent1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>/data/s3data:/s3data:shared</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Restart the stack after making the changes above and the volume will be created when the JADE worker starts.</p><h2 id=host-specific-volumes>Host-specific Volumes</h2><p>By default, all JADE agents are configured to serve all volumes in the database. You can use <code>StorageAgent.ServedVolumes</code> to control which volumes are served by which hosts.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7a8952308cdb3a7af0e8db8edef7117c>3.2.8 - Data import</h1><div class=lead>How to convert data into Horta format</div><p>In principle, any 3d volumetric data can be imported into the MouseLight Workstation.
At this moment we only provide some very basic tools for converting only TIFF format images into the expected format on disk. Another limitation of the current tools is that the entire volume must be in a single tiff file (per channel)</p><p>The imagery for MouseLight Workstation is a directory containing TIFF and KTX images organized into octrees. JACS compute includes a a service that can generate the octree data from a single volume TIFF file. If there is more than 1 channel, the channels are numbered 0 .. n-1 and each channel is expected to be in its own file. For example if you have 2 channels you would have two tiff files:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/path/to/volume/volume.0.tiff
</span></span><span style=display:flex><span>/path/to/volume/volume.1.tiff
</span></span></code></pre></div><p>The import service requires docker or singularity installed because the actual conversion services are packaged in two docker containers - one that generates a TIFF octree and the other one that takes the TIFF octree and converts the octant channel images into the correspomding ktx blocks.</p><p>Currently pre-built containers for tiff octree tool and ktx tool are only available at Janelia&rsquo;s internal registry, but the containers build files are available at <a href=https://github.com/JaneliaSciComp/jacs-tools-docker.git>https://github.com/JaneliaSciComp/jacs-tools-docker.git</a> in the &rsquo;tiff_octree&rsquo; and &lsquo;ktx_octree&rsquo; subdirectories, respectively. KTX tool container can also be built from <a href=https://github.com/JaneliaSciComp/pyktx.git>https://github.com/JaneliaSciComp/pyktx.git</a>.</p><p>Generating the sample octree requires only a JACS Async service call which is a simple HTTP REST call that can be done using curl or Postman. This service can also be invoked from the JACS dashboard <a href=http://api-gateway-host:8080>http://api-gateway-host:8080</a> by going to the &ldquo;Services List&rdquo; after Login and selecting &ldquo;lvDataImport&rdquo;. The dashboard should also offer a brief description of each argument.</p><p>curl invocation to run the service with singularity (this is the JACS default):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  https://api-gateway-host/SCSW/JACS2AsyncServices/v2/async-services/lvDataImport <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#39;Accept: application/json&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#39;Content-Type: application/json&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -H <span style=color:#4e9a06>&#39;Authorization: Bearer Your_Token&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -d <span style=color:#4e9a06>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;args&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-containerProcessor&#34;, &#34;singularity&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-inputDir&#34;, &#34;/path/to/volumeData&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-inputFilenamePattern&#34;, &#34;test.{channel}.tif&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-outputDir&#34;, &#34;/path/to/lvv/sampleData&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-channels&#34;, &#34;0,1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-levels&#34;, &#34;4&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-voxelSize&#34;, &#34;1,1,1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-subtreeLengthForSubjobSplitting&#34;, 2,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-tiffOctreeContainerImage&#34;, &#34;docker://registry.int.janelia.org/jacs-scripts/octree:1.0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                &#34;-ktxOctreeContainerImage&#34;, &#34;docker://registry.int.janelia.org/jacs-scripts/pyktx:1.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        ],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> &#34;resources&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#39;</span>
</span></span></code></pre></div><p>curl invocation to run the service with docker:</p><pre tabindex=0><code>curl -X POST \
  https://api-gateway-host/SCSW/JACS2AsyncServices/v2/lvDataImport \
  -H &#39;Accept: application/json&#39; \
  -H &#39;Content-Type: application/json&#39; \
  -H &#39;Authorization: Bearer Your_Token&#39; \
  -d &#39;{
 &#34;args&#34;: [
  &#34;-containerProcessor&#34;, &#34;docker&#34;,
  &#34;-inputDir&#34;, &#34;/path/to/volumeData&#34;,
                &#34;-inputFilenamePattern&#34;, &#34;default.{channel}.tif&#34;,
  &#34;-outputDir&#34;, &#34;/path/to/lvv/sampleData&#34;,
  &#34;-channels&#34;, &#34;0&#34;,
  &#34;-levels&#34;, &#34;3&#34;,
  &#34;-voxelSize&#34;, &#34;1,1,1&#34;,
  &#34;-subtreeLengthForSubjobSplitting&#34;, 3,
  &#34;-tiffOctreeContainerImage&#34;, &#34;registry.int.janelia.org/jacs-scripts/octree:1.0&#34;,
  &#34;-ktxOctreeContainerImage&#34;, &#34;registry.int.janelia.org/jacs-scripts/pyktx:1.0&#34;
 ],
 &#34;resources&#34;: {
 }
}
&#39;
</code></pre><h3 id=arguments-description>Arguments description</h3><ul><li>containerProcessor - which container runtime to use docker or singularity</li><li>inputDir - path to original volume data</li><li>inputFileNamePattern - original tiff name. Notice that if you have multiple channels and the channel is anywhere in the name you can use <code>{channel}</code> which will be replaced with the actual channel number.</li><li>outputDir - where the octree will be generated - typically this is the sample data directory that will be imported in the workstation</li><li>channels - specifies a list of all available channels, e.g. &lsquo;0,1&rsquo; if there are two channels or &lsquo;0&rsquo; if there is only 1 channel.</li><li>levels - the number of octree levels. This is left up to the user and the service will not try to figure out the optimum value for the number of octree levels.</li><li>voxelSize - specifies the voxel size in um.</li><li>tiffOctreeContainerImage - tiff octree container image. Not that the format is slightly different for specifying the image name if docker is used or if singularity is used. Since singularity supports docker images, if singularity runtime is used you need to explictily specify that the image is a docker image.</li><li>ktxOctreeContainerImage - ktx octree container image. See above regarding the format based on container processor type.</li><li>subtreeLengthForSubjobSplitting - this parameter applies only for the ktx processor and it tells the service how to split the job and it has a default value of 5. The conversion process typically starts at a certain node and it performs tiff to ktx conversion for a specified number of levels. If you start a process at the root and convert all levels the job may take a while so if you want you have the option to parallelize it by going only for a limited number of levels from the root and start new jobs from all nodes at the level equal with the subtree depth. For example if you have 8 levels and you set <code>subtreeLengthForSubjobSplitting</code> to <code>3</code> then KTX conversion will start <code>1 + 8^3 + 8^6 = 1 + 512 + 262144 = 262657</code> jobs with the following parameters:
<code>"" 3, "111" 3, "112" 3, ..., "118" 3, ..., "888" 3, ..., "111111" 3, ..., "888888" 3</code>
If you leave the default (<code>subtreeLengthForSubjobSplitting=5</code>) then the KTX conversion will start only <code>1 + 8^5 = 32769</code> jobs (<code>"11111" 5, ..., "88888" 5</code>)</li></ul><p>Note that the service invocation requires authentication so before you invoke it, you need to obtain an JWS token from the authentication service - see the <a href=../swarmdeployment>Verify Functionality section on this page</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6d70c3f179823392b17699c06103fb1a>3.2.9 - Troubleshooting</h1><div class=lead>Common issues and solutions</div><h2 id=docker>Docker</h2><p>These are some useful commands for troubleshooting Docker:</p><p>View logs for Docker daemon</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo journalctl -fu docker
</span></span></code></pre></div><p>Restart the Docker daemon</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart docker
</span></span></code></pre></div><p>Remove all Docker objects, including unused containers/networks/etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker system prune -a
</span></span></code></pre></div><h2 id=swarm-gui>Swarm GUI</h2><p>If you would like to see the Swarm&rsquo;s status in a web-based GUI, we recommend installing <a href=https://swarmpit.io>Swarmpit</a>. It&rsquo;s a single command to deploy, and it works well with the JACS stack.</p><h2 id=common-issues>Common issues</h2><h3 id=config-variable-not-set>config variable not set</h3><p>If you see a lot of errors or warnings similar to the ones below, first check that the <code>.env</code> file was generated correctly - it should have all environment variables from .env.config, present and set. If it is not just remove it and try the commands again. It is possible that you may have run a command like <code>./manage.sh init-filesystems</code> before the swarm cluster was available.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;CONFIG_DIR&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;DATA_DIR&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;DB_DIR&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;BACKUPS_DIR&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;CERT_SUBJ&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;DEPLOYMENT&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;MONGODB_SECRET_KEY&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;API_GATEWAY_EXPOSED_HOST&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;RABBITMQ_EXPOSED_HOST&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;RABBITMQ_USER&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;RABBITMQ_PASSWORD&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;MAIL_SERVER&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;NAMESPACE&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;REDUNDANT_STORAGE&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;REDUNDANT_STORAGE&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;NON_REDUNDANT_STORAGE&#34;</span> variable is not set. Defaulting to a blank string.
</span></span><span style=display:flex><span>WARN<span style=color:#ce5c00;font-weight:700>[</span>0000<span style=color:#ce5c00;font-weight:700>]</span> The <span style=color:#4e9a06>&#34;NON_REDUNDANT_STORAGE&#34;</span> variable is not set. Defaulting to a blank string.
</span></span></code></pre></div><h3 id=network-not-found>&ldquo;network not found&rdquo;</h3><p>If you see an intermittent error like this, just retry the command again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>failed to create service jacs-cm_jacs-sync: Error response from daemon: network jacs-cm_jacs-net not found
</span></span></code></pre></div><h3 id=bind-errors-during-init-filesystems>bind errors during init-filesystems</h3><p>If during <code>init-filesystems</code> you see an error that the config folder could not be bound on a particular node of the swarm cluster, make sure you did not forget to create the config and db directories on each node that is part of the swarm. The directories must exist in order for docker to be able to mount the corresponding volumes.
After you created all folders if you already ran <code>./manage.sh init-filesystems</code> and it failed before you run it again stop it using</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh stop
</span></span></code></pre></div><p>and then you can try to re-run it</p><h2 id=restful-services>RESTful services</h2><p>You can access the RESTful services from the command line. Obtain a JWT token like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh login
</span></span></code></pre></div><p>The default admin account is called &ldquo;root&rdquo; with password &ldquo;root&rdquo; for deployments with self-contained authentication.</p><p>Now you can access any of the RESTful APIs on the gateway, for instance:</p><pre tabindex=0><code>export TOKEN=&lt;enter token here&gt;
curl -k --request GET --url https://${API_GATEWAY_EXPOSED_HOST}/SCSW/JACS2AsyncServices/v2/services/metadata --header &#34;Content-Type: application/json&#34; --header &#34;Authorization: Bearer $TOKEN&#34;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-c995838bf718c1eeff1a9f27bbce59da>4 - Developer's guide</h1><div class=lead>Guide for developing HortaCloud code</div><div class="pageinfo pageinfo-primary"><p>We are in the process of writing this documentation.</p></div></div><div class=td-content><h1 id=pg-b3ea425051b85e88366f1255b9a09733>4.1 - Getting started</h1><div class=lead>Getting started with HortaCloud development</div></div><div class=td-content style=page-break-before:always><h1 id=pg-c10a3b2defa728cdb37ebb0801c86708>4.2 - Single server deployment</h1><div class=lead>How to deploy HortaCloud to your own local server</div><div class=pb-3><a href=single_server.png><img src=../single_server.png class="rounded mx-auto" style=max-width:700px alt="single sever deployment diagram"></a></div><p>This document describes a Janelia Workstation deployment intended for setting up a personal development environment. Unlike the canonical distributed deployments which use Docker Swarm, this deployment uses Docker Compose to orchestrate the services on a single server.</p><p>Note that this deployment does not build and serve the Workstation client installers, although that could certainly be added in cases where those pieces need to be developed and tested. In most cases, however, it is expected that this server-side deployment be paired with a development client built and run directly from IntelliJ or NetBeans.</p><h2 id=system-setup>System Setup</h2><p>This deployment should work on any system where Docker is supported. Currently, it has only been tested on Scientific Linux 7 and macOS Mojave.</p><p>To install Docker and Docker Compose on Oracle Linux 8, follow <a href=../installingdocker>these instructions</a>.</p><h2 id=clone-this-repo>Clone This Repo</h2><p>Begin by cloning this repo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/JaneliaSciComp/jacs-cm.git
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> jacs-cm
</span></span></code></pre></div><h2 id=configure-the-system>Configure The System</h2><p>Next, create a <code>.env.config</code> file inside the jacs-cm directory. This file defines the environment (usernames, passwords, etc.) You can copy the template to get started:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp .env.template .env.config
</span></span><span style=display:flex><span>vi .env.config
</span></span></code></pre></div><p>At minimum, you must customize the following:</p><ol><li>Configured the <code>UNAME</code> and <code>GNAME</code> to your liking. Ideally, these should be your username and primary group.</li><li>Setup <code>REDUNDANT_STORAGE</code> and <code>NON_REDUNDANT_STORAGE</code> to point to directories accessible by <code>UNAME</code>:<code>GNAME</code>. If you want to use the defaults, you may need to create these directories and set the permissions yourself.</li><li>Set <code>HOST1</code> to the hostname you are deploying on. If possible, use a fully-qualified hostname &ndash; it should match the SSL certificate you intend to use.</li><li>Fill in all the unset passwords with >8 character passwords. You should only use alphanumeric characters, special characters are not currently supported.</li><li>Generate 32-byte secret keys for JWT_SECRET_KEY and MONGODB_SECRET_KEY.</li></ol><h2 id=enable-databases-optional>Enable Databases (optional)</h2><p>Currently, Janelia runs MongoDB outside of the Swarm, so they are commented out in the deployment. If you&rsquo;d like to run the databases as part of the swarm, edit the yaml files under ./deployments/jacs/ and uncomment the databases.</p><h2 id=initialize-filesystems>Initialize Filesystems</h2><p>The first step is to initialize the filesystem. Ensure that your <code>REDUNDANT_STORAGE</code> (default: /opt/jacs), <code>NON_REDUNDANT_STORAGE</code> (default: /data) directories exist and can be written to by your UNAME:GNAME user (default: docker-nobody).
If you are using Docker for Mac, you&rsquo;ll need to take the additional step of configuring share paths at Docker -> Preferences&mldr; -> File Sharing. Add both <code>REDUNDANT_STORAGE</code> and <code>NON_REDUNDANT_STORAGE</code> and then click &ldquo;Apply & Restart&rdquo; to save your changes.</p><p>Next, run the filesystem initialization procedure:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh init-local-filesystem
</span></span></code></pre></div><p>You should see output about directories being created and initialized. If there are any errors, they need to be resolved before moving further.</p><p>Once the initialization is complete, you can manually edit the files found in <code>CONFIG_DIR</code>. You can use these configuration files to customize much of the JACS environment.</p><h3 id=ssl-certificates>SSL Certificates</h3><p>At this point, <strong>it is strongly recommended is to replace the self-signed certificates</strong> in <code>CONFIG_DIR/certs/*</code> with your own certificates signed by a Certificate Authority:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /path/to/your/certs/cert.<span style=color:#ce5c00;font-weight:700>{</span>crt,key<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>$CONFIG_DIR</span>/certs/
</span></span><span style=display:flex><span>sudo chown docker-nobody:docker-nobody <span style=color:#000>$CONFIG_DIR</span>/certs/*
</span></span></code></pre></div><p>If you use self-signed certificates, you will need to <a href=../selfsignedcerts>set up the trust chain</a> for them later.</p><h3 id=external-authentication>External Authentication</h3><p>The JACS system has its own self-contained authentication system, and can manage users and passwords internally.</p><p>If you&rsquo;d prefer that users authenticate against your existing LDAP or ActiveDirectory server, edit <code>$CONFIG_DIR/jacs-sync/jacs.properties</code> and add these properties:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>LDAP.URL</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.SearchBase</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.SearchFilter</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.BindDN</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>LDAP.BindCredentials</span><span style=color:#ce5c00;font-weight:700>=</span>
</span></span></code></pre></div><p>The URL should point to your authentication server. The SearchBase is part of a distinguished name to search, something like &ldquo;ou=People,dc=yourorg,dc=org&rdquo;. The SearchFilter is the attribute to search on, something like &ldquo;(cn={{username}})&rdquo;. BindDN and BindCredentials defines the distinguished name and password for a service user that can access user information like full names and emails.</p><h2 id=start-all-containers>Start All Containers</h2><p>Now you can bring up all of the application containers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh compose up -d
</span></span></code></pre></div><p>You can monitor the progress with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh compose ps
</span></span></code></pre></div><h2 id=initialize-databases>Initialize Databases</h2><p>If you are running your own databases, you will need to initalize them now:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh init-databases
</span></span></code></pre></div><h2 id=verify-functionality>Verify Functionality</h2><p>You can verify the Authentication Service is working as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh login
</span></span></code></pre></div><p>You should be able to log in with the default admin account (root/root), or any LDAP/AD account if you&rsquo;ve configured external authentication. This will return a JWT that can be used on subsequent requests.·</p><p>If you run into any problems, these <a href=../troubleshooting>troubleshooting tips</a> may help.</p><h2 id=updating-containers>Updating Containers</h2><p>Containers in this deployment are automatically updated by <a href=https://github.com/containrrr/watchtower>Watchtower</a> whenever a new one is available with the &ldquo;latest&rdquo; tag. To update the deployment, simply build and push a new container to the configured registry.</p><h2 id=stop-all-containers>Stop All Containers</h2><p>To stop all containers, run this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./manage.sh compose down
</span></span></code></pre></div><h2 id=build-and-run-client>Build and Run Client</h2><p>Now you can checkout the <a href=https://github.com/JaneliaSciComp/workstation>Janelia Workstation</a> code base in IntelliJ or NetBeans and run its as per its README.</p><p>The client will ask you for the API Gateway URL, which is just <code>http://$HOST1</code>. In order to automatically connect to your standalone gateway instance, you can create a new file at <code>workstation/modules/Core/src/main/resources/my.properties</code> with this content (replacing the variables with the values from your .env.config file):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>api.gateway</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://$HOST1</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-456a54cd44dab2f393eb1317bc996c84>4.3 - System Overview</h1><div class=lead>Guide for developing HortaCloud code</div><div class="pageinfo pageinfo-primary"><p>We are in the process of writing this documentation.</p></div></div><div class=td-content><h1 id=pg-458e3631b38500671eb83386a0800733>4.3.1 - Persistence</h1><div class=lead>Saving Horta data in MongoDB</div><p>This section covers a basic overview of how Horta persists neurons, workspaces, samples and preferences.</p><h1 id=asynchronous-vs-synchronous-saving>Asynchronous vs synchronous saving</h1><p>The final persistence store for Horta is in MongoDB, a document database, whether or not the data being saved is asynchronous or synchronous. Most Horta data is saved synchronously; the purpose of the asynchronous saving is to:</p><ul><li><code>Ease the burden on the annotator to constantly save their work</code></li><li><code>Share annotations in realtime with other annotators or machine algorithms working in the same workspace</code></li></ul><h1 id=persistence-flow>Persistence flow</h1><p>All access to MongoDB is wrapped by a RESTful API, jacs-sync, with a number of endpoints for CRUD operations for TmWorkspace, TmSample, and TmNeuronMetadata. The basic class/component diagram is shown below. When a workspace is first loaded, it relies on NeuronModelAdapter to stream in parallel all the neuron annotations for that workspace into the client app. The following initialization steps are performed with the annotation data:</p><ul><li><code>Concurrent map in NeuronModel is populated</code>:</li><li><code>LoadWorkspace/Sample events are fired to notify relevant GUI panels to update</code></li><li><code>Spatial Filters are initialized with vertices (TmGeoAnnotations) from the neurons for snapping and general neighborhood convenience methods</code></li></ul><div class=pb-3><a href=../horta_persistence.png><img src=../horta_persistence.png class="rounded mx-auto" style=max-width:700px alt="persistence flow diagram"></a></div><p>Once the workspace is initialized and the annotator makes a change to a neuron, the entire neuron is serialized into an AMQP message and sent through the NeuronModelAdapter using RabbitMQ. When a client first starts up, it creates a temperorary queue that both publishes to a RabbitMQ topic exchange (ModelUpdates). Another service, jacs-messaging, listens to this exchange using the UpdateProcessor queue, and consumes messages of the exchange. It determines how to process these messages and if it requires persisting the neuron to the db, connects over the REST API to the jacs-sync service to perform the operation.</p><p>Once the operation is complete, an acknowledgement/update message is posted on the RabbitMQ fanout exchange, ModelRefresh. If there are any errors, they get posted on the ModelError exchange. All the clients are subscribed the ModelRefresh exchange, so they get notifications on any neuron changes. These are processed as multi-threaded callbacks in RefreshHandler, which filters based off the current workspace and fires update events if the message is relevant.</p><div class=pb-3><a href=../shared_workspace_1.png><img src=../shared_workspace_1.png class="rounded mx-auto" style=max-width:700px alt="Shared Workspace Scenario"></a></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6de0d7915d9bbe583ebcb458dc517f90>4.3.2 - Tiled Imagery</h1><div class=lead>Overview of how tiled imagery is loaded in Horta2D/Horta3D</div><h2 id=horta-2d>Horta 2D</h2><p>Horta&rsquo;s 2D and 3D viewer were originally 2 separate visualization packages, so the way that they load tile imagery is quite different. Horta2D was called LVV (Large Volume Viewer) and exclusively loads many 2D slices from a TIFF Octree at a specific resolution to produce a mosaic that fills the window. These 2D slices are retrieved from the jacs-sync REST API based off the current focus on the window.</p><div class=pb-3><a href=../LVV_Graphics.png><img src=../LVV_Graphics.png class="rounded mx-auto" style=max-width:700px alt="Horta2D Class Diagram"></a></div><p>In the LVV Object Diagram above, the key classes to examine when dealing specifically with the UI are QuadViewUI, TraceMode, AnnotationPanel, SkeletonActorModel, and AnnotationManager. QuadViewUI is the main Swing container for LVV, wrapping the 3D viewer and AnnotationPanel. The AnnotationPanel is the Swing panel on the right of the layout that has all the menu options, neuron filter options and annotation lists for each neuron. TraceMode is the main User EventManager, handling all key presses and mouse clicks. The SkeletonActorModel is the Controller for all the Neuron tracing (anchors/vertexes and directed paths between them).</p><p>Horta2D has a different tile-loading mechanism, but shares all other data with Horta3D through TmModelManager, including the current focus location, selection, resolution, voxel-micrometer mapping, etc.</p><h2 id=horta-3d>Horta 3D</h2><p>Horta3D loads 3D tiles as 3D texture-mapped chunks of the type of imagery (KTX, TIFF, MJ2, Zarr) associated with the current workspace/sample. These chunks all inherit from GL3Actor (TetVolumeActor, BrickActor), and are all loaded into a collection that is rendered by NeuronMPRenderer in its VolumeRenderPass. The main JOGL OpenGL window is SceneWindow.</p><p>When Horta3D is first loaded, the focus location is initialized from the sample bounding box and center information that is calculated on scene/workspace loading. The top component of Horta3D, NeuronTracerTopComponent, then delegates to the NeuronTileLoader to find the appropriate 3D chunks for that view. The BrickSource objects are used to load 3D voxel data and convert it into a 3D object that can be rendered in the SceneWindow.</p><p>In the case of KTX, the TetVolumeActor and KTXBlockLoadRunner work together to queue up a number of 3D chunks for multi-threaded loading based off the zoom resolution and current focus in the SceneWindow. The intent is to load as many chunks are necessary to fill up the viewport.</p><div class=pb-3><a href=../horta3d_tile_loading.png><img src=../horta3d_tile_loading.png class="rounded mx-auto" style=max-width:700px alt="Horta3D Tile Loading Diagram"></a></div></div><div class=td-content style=page-break-before:always><h1 id=pg-491d5f73fa085d484aef1779d4149a49>4.3.3 - Event Handling/Communication</h1><div class=lead>How information is communicated in Horta</div><p>This section briefly covers how information is shared throughout the GUI in Horta</p><h3 id=eventbus>EventBus</h3><p>To preserve code independence between different modules in Horta, an EventBus from Google is used. This acts likes an internal publish/subscribe framework within the client, allowing methods to listen for certain events to happen. Events are sent asynchronously on the EventBus, so they are managed in a separate thread than the main AWT thread.</p><p>In Horta, the EventBus is mainly used to communicate events that concern multiple GUI components. Events that are mostly concerned with communication within a GUI component are still managed using Listeners.</p><ul><li><code>ViewerEventBus is the main wrapper around the eventbus for Horta, and is managed by TmViewerManager.</code></li><li>`Each main component has a Controller class that is the main hub for incoming eventbus messages (eg, PanelController for the Horta Command Center). Messages are then appropriately routed to local GUI components from the controller.</li></ul><p>All the eventbus events are listed in the org.janelia.workstation.controller.eventbus package and include events such as SampleCreateEvent, WorkflowEvent, etc. Because events can have inheritance, methods can listen to the super Event class and get notifications on the whole stack of events that inherit from the super class.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-54cfc17f234956ddccf6ffc860b31efe>4.4 - Contribution guidelines</h1><div class=lead>How to contribute to the software</div></div><div class=td-content style=page-break-before:always><h1 id=pg-8efbf7499fe9c7bde8d2c1bb7ff6ee3c>5 - Editing the documentation</h1><div class=lead>How to contribute to the docs</div><p>We use <a href=https://gohugo.io/>Hugo</a> to format and generate our website, the
<a href=https://github.com/google/docsy>Docsy</a> theme for styling and site structure,
and <a href=https://pages.github.com/>GitHub Pages</a> to manage the deployment of the site.</p><p>Hugo is an open-source static site generator that provides us with templates,
content organization in a standard directory structure, and a website generation
engine. You write the pages in Markdown (or HTML if you want), and Hugo wraps them up into a website.</p><p>All submissions, including submissions by project members, require review. We
use GitHub pull requests for this purpose. Consult
<a href=https://help.github.com/articles/about-pull-requests/>GitHub Help</a> for more
information on using pull requests.</p><h2 id=updating-a-single-page>Updating a single page</h2><p>If you&rsquo;ve just spotted something you&rsquo;d like to change while using the docs, Docsy has a shortcut for you:</p><ol><li>Click <strong>Edit this page</strong> in the top right hand corner of the page.</li><li>If you don&rsquo;t already have an up to date fork of the project repo, you are prompted to get one - click <strong>Fork this repository and propose changes</strong> or <strong>Update your Fork</strong> to get an up to date version of the project to edit. The appropriate page in your fork is displayed in edit mode.</li></ol><h2 id=previewing-your-changes-locally>Previewing your changes locally</h2><p>If you want to run your own local Hugo server to preview your changes as you work:</p><ol><li><p>Follow the instructions to <a href=https://gohugo.io/getting-started/installing/>install Hugo</a>. It must be the <strong>extended</strong> version, which supports SCSS.</p></li><li><p>Fork the <a href=https://github.com/JaneliaSciComp/hortacloud-website>HortaCloud website repo</a> locally:</p><pre tabindex=0><code>git clone --recurse-submodules --depth 1 https://github.com/JaneliaSciComp/hortacloud-website
</code></pre></li><li><p>Run <code>npm install</code> and <code>hugo server</code> in the site root directory. By default your site will be available at <a href=http://localhost:1313/>http://localhost:1313/</a>. Now that you&rsquo;re serving your site locally, Hugo will watch for changes to the content and automatically refresh your site.</p></li><li><p>Continue with the usual GitHub workflow to edit files, commit them, push the
changes up to your fork, and create a pull request.</p></li></ol><h2 id=creating-an-issue>Creating an issue</h2><p>If you&rsquo;ve found a problem in the docs, but you&rsquo;re not sure how to fix it yourself, please create an issue in the <a href=https://github.com/JaneliaSciComp/hortacloud-website/issues>HortaCloud website repo</a>. You can also create an issue about a specific page by clicking the <strong>Create Issue</strong> button in the top right hand corner of the page.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Email us" aria-label="Email us"><a target=_blank rel=noopener href=mailto:hortacloud@janelia.hhmi.org aria-label="Email us"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=X aria-label=X><a target=_blank rel=noopener href=https://twitter.com/HortaCloud aria-label=X><i class="fab fa-twitter"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Project management board" aria-label="Project management board"><a target=_blank rel=noopener href=https://github.com/orgs/JaneliaSciComp/projects/3 aria-label="Project management board"><i class="fas fa-tasks"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/JaneliaSciComp/hortacloud aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>Howard Hughes Medical Institute</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://www.hhmi.org/privacy-policy target=_blank rel=noopener>Privacy Policy & Cookie Notice</a></span></div></div></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script></body></html>